name: Code Standards Check

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

jobs:
  # =========================================
  # Job 1: E2Eãƒ†ã‚¹ãƒˆã‚»ãƒ¬ã‚¯ã‚¿è¦ç´„ãƒã‚§ãƒƒã‚¯
  # =========================================
  test-selector-check:
    name: E2E Test Selector Standards
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for forbidden getByText usage in E2E tests
        run: |
          echo "ğŸ” E2Eãƒ†ã‚¹ãƒˆã§ç¦æ­¢ã•ã‚Œã¦ã„ã‚‹ã‚»ãƒ¬ã‚¯ã‚¿ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

          VIOLATIONS=""

          # getByText ã®ä½¿ç”¨ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆPage Objectãƒ•ã‚¡ã‚¤ãƒ«å†…ï¼‰
          if grep -rn "getByText" reserve-app/src/__tests__/e2e/pages/ 2>/dev/null; then
            VIOLATIONS="${VIOLATIONS}âŒ Page Objectã§ã® getByText ä½¿ç”¨ã‚’æ¤œå‡º\n"
          fi

          # :has-text() ã®ä½¿ç”¨ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆPage Objectãƒ•ã‚¡ã‚¤ãƒ«å†…ï¼‰
          if grep -rn ":has-text(" reserve-app/src/__tests__/e2e/pages/ 2>/dev/null; then
            VIOLATIONS="${VIOLATIONS}âŒ Page Objectã§ã® :has-text() ä½¿ç”¨ã‚’æ¤œå‡º\n"
          fi

          # spec.tså†…ã§ã®ç›´æ¥çš„ãªãƒ†ã‚­ã‚¹ãƒˆã‚»ãƒ¬ã‚¯ã‚¿ä½¿ç”¨ã‚’ãƒã‚§ãƒƒã‚¯
          if grep -rn "page\.getByText\|page\.locator.*:has-text" reserve-app/src/__tests__/e2e/*.spec.ts 2>/dev/null | grep -v "// allowed:" ; then
            VIOLATIONS="${VIOLATIONS}âš ï¸ E2Eãƒ†ã‚¹ãƒˆã§ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ã‚»ãƒ¬ã‚¯ã‚¿ä½¿ç”¨ã‚’æ¤œå‡ºï¼ˆdata-testidæ¨å¥¨ï¼‰\n"
          fi

          if [ -n "$VIOLATIONS" ]; then
            echo "============================================"
            echo "âš ï¸ è¦ç´„é•åã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
            echo "============================================"
            echo -e "$VIOLATIONS"
            echo ""
            echo "ğŸ“– å¯¾å¿œæ–¹æ³•:"
            echo "  1. data-testidå±æ€§ã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«è¿½åŠ "
            echo "  2. Page Objectã§ [data-testid=\"...\"] ã‚»ãƒ¬ã‚¯ã‚¿ã‚’ä½¿ç”¨"
            echo "  3. å‚è€ƒ: .cursor/rules/é–‹ç™ºãƒ—ãƒ­ã‚»ã‚¹ãƒ«ãƒ¼ãƒ«.mdc"
            echo ""
            echo "âš ï¸ è­¦å‘Šã¨ã—ã¦æ‰±ã„ã¾ã™ï¼ˆç¾åœ¨ã¯æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã«é•åãŒã‚ã‚‹ãŸã‚ï¼‰"
            # ç¾åœ¨ã¯è­¦å‘Šã®ã¿ã€‚æ—¢å­˜ã‚³ãƒ¼ãƒ‰ä¿®æ­£å¾Œã« exit 1 ã«å¤‰æ›´
            # exit 1
          else
            echo "âœ… ãƒ†ã‚¹ãƒˆã‚»ãƒ¬ã‚¯ã‚¿è¦ç´„ã«é•åã¯ã‚ã‚Šã¾ã›ã‚“"
          fi

  # =========================================
  # Job 2: APIãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¦ç´„ãƒã‚§ãƒƒã‚¯
  # =========================================
  api-validation-check:
    name: API Validation Standards
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Zod validation in new API routes
        run: |
          echo "ğŸ” æ–°è¦APIãƒ«ãƒ¼ãƒˆã§ã®Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä½¿ç”¨ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

          # PRã§è¿½åŠ ãƒ»å¤‰æ›´ã•ã‚ŒãŸAPIãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          API_FILES=$(git diff --name-only origin/main...HEAD -- 'reserve-app/src/app/api/**/*.ts' 2>/dev/null || echo "")

          if [ -z "$API_FILES" ]; then
            echo "âœ… APIãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
            exit 0
          fi

          MISSING_VALIDATION=""

          for file in $API_FILES; do
            if [ -f "$file" ]; then
              # POST/PUT/PATCHãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚‹ãŒsafeParse/.parse()ãŒãªã„å ´åˆ
              if grep -q "export async function POST\|export async function PUT\|export async function PATCH" "$file"; then
                if ! grep -q "safeParse\|\.parse(" "$file"; then
                  MISSING_VALIDATION="${MISSING_VALIDATION}âŒ $file: Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\n"
                fi
              fi
            fi
          done

          if [ -n "$MISSING_VALIDATION" ]; then
            echo "============================================"
            echo "âš ï¸ APIãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¦ç´„é•åã®å¯èƒ½æ€§"
            echo "============================================"
            echo -e "$MISSING_VALIDATION"
            echo ""
            echo "ğŸ“– å¯¾å¿œæ–¹æ³•:"
            echo "  1. Zodã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ï¼ˆsrc/lib/validations.tsï¼‰"
            echo "  2. APIãƒ«ãƒ¼ãƒˆã§safeParseã‚’ä½¿ç”¨"
            echo "  3. å‚è€ƒ: documents/ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ.md"
            echo ""
            echo "âš ï¸ è­¦å‘Šã¨ã—ã¦æ‰±ã„ã¾ã™"
            # ç¾åœ¨ã¯è­¦å‘Šã®ã¿
            # exit 1
          else
            echo "âœ… å¤‰æ›´ã•ã‚ŒãŸAPIãƒ«ãƒ¼ãƒˆã«ã¯Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œã¦ã„ã¾ã™"
          fi

  # =========================================
  # Job 3: Gherkinã‚·ãƒŠãƒªã‚ªå­˜åœ¨ãƒã‚§ãƒƒã‚¯
  # =========================================
  gherkin-check:
    name: Gherkin Scenario Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Gherkin scenarios for new E2E tests
        run: |
          echo "ğŸ” æ–°è¦E2Eãƒ†ã‚¹ãƒˆã«å¯¾å¿œã™ã‚‹Gherkinã‚·ãƒŠãƒªã‚ªã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

          # æ–°ã—ã„spec.tsãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          NEW_SPECS=$(git diff --name-only origin/main...HEAD -- 'reserve-app/src/__tests__/e2e/*.spec.ts' 2>/dev/null || echo "")

          if [ -z "$NEW_SPECS" ]; then
            echo "âœ… æ–°è¦E2Eãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“"
            exit 0
          fi

          MISSING_GHERKIN=""

          for spec in $NEW_SPECS; do
            if [ -f "$spec" ]; then
              # specåã‹ã‚‰featureãƒ•ã‚¡ã‚¤ãƒ«åã‚’æ¨æ¸¬
              SPEC_NAME=$(basename "$spec" .spec.ts)

              # featuresãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã‚’æ¤œç´¢
              if ! find reserve-app/features reserve-app/src/__tests__/e2e/features -name "*.feature" 2>/dev/null | xargs grep -l "$SPEC_NAME" > /dev/null 2>&1; then
                # å®Œå…¨ä¸€è‡´ã®featureãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™
                if ! find reserve-app/features reserve-app/src/__tests__/e2e/features -name "${SPEC_NAME}.feature" 2>/dev/null | head -1 | grep -q .; then
                  MISSING_GHERKIN="${MISSING_GHERKIN}âš ï¸ $spec: å¯¾å¿œã™ã‚‹Gherkinã‚·ãƒŠãƒªã‚ªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\n"
                fi
              fi
            fi
          done

          if [ -n "$MISSING_GHERKIN" ]; then
            echo "============================================"
            echo "âš ï¸ Gherkinã‚·ãƒŠãƒªã‚ªãŒä¸è¶³ã—ã¦ã„ã‚‹å¯èƒ½æ€§"
            echo "============================================"
            echo -e "$MISSING_GHERKIN"
            echo ""
            echo "ğŸ“– ATDD/BDDé–‹ç™ºãƒ—ãƒ­ã‚»ã‚¹:"
            echo "  1. ã¾ãšGherkinã‚·ãƒŠãƒªã‚ªã‚’ä½œæˆï¼ˆfeatures/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼‰"
            echo "  2. æ¬¡ã«E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…"
            echo "  3. å‚è€ƒ: documents/development/é–‹ç™ºãƒ—ãƒ­ã‚»ã‚¹è¨­è¨ˆ.md"
          else
            echo "âœ… E2Eãƒ†ã‚¹ãƒˆã«å¯¾å¿œã™ã‚‹Gherkinã‚·ãƒŠãƒªã‚ªãŒå­˜åœ¨ã—ã¾ã™"
          fi

  # =========================================
  # Job 4: data-testidå±æ€§ãƒã‚§ãƒƒã‚¯
  # =========================================
  testid-check:
    name: data-testid Attribute Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for data-testid in interactive elements
        run: |
          echo "ğŸ” æ–°è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã®data-testidä½¿ç”¨ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

          # å¤‰æ›´ã•ã‚ŒãŸTSXãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          CHANGED_TSX=$(git diff --name-only origin/main...HEAD -- 'reserve-app/src/**/*.tsx' 2>/dev/null || echo "")

          if [ -z "$CHANGED_TSX" ]; then
            echo "âœ… TSXãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
            exit 0
          fi

          WARNINGS=""

          for file in $CHANGED_TSX; do
            if [ -f "$file" ]; then
              # button, input, selectè¦ç´ ãŒã‚ã‚‹ãŒdata-testidãŒãªã„å ´åˆã‚’ãƒã‚§ãƒƒã‚¯
              BUTTONS=$(grep -c "<button" "$file" 2>/dev/null || echo "0")
              INPUTS=$(grep -c "<input" "$file" 2>/dev/null || echo "0")
              SELECTS=$(grep -c "<select" "$file" 2>/dev/null || echo "0")
              TESTIDS=$(grep -c "data-testid" "$file" 2>/dev/null || echo "0")

              INTERACTIVE=$((BUTTONS + INPUTS + SELECTS))

              if [ "$INTERACTIVE" -gt 0 ] && [ "$TESTIDS" -eq 0 ]; then
                WARNINGS="${WARNINGS}âš ï¸ $file: ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–è¦ç´ ($INTERACTIVEå€‹)ã«data-testidãŒã‚ã‚Šã¾ã›ã‚“\n"
              fi
            fi
          done

          if [ -n "$WARNINGS" ]; then
            echo "============================================"
            echo "âš ï¸ data-testidå±æ€§ã®è¿½åŠ ã‚’æ¨å¥¨"
            echo "============================================"
            echo -e "$WARNINGS"
            echo ""
            echo "ğŸ“– å‘½åè¦å‰‡:"
            echo "  - {page}-{element}: åŸºæœ¬å½¢å¼"
            echo "  - {action}-{page}: ãƒœã‚¿ãƒ³ç­‰ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"
            echo "  - ä¾‹: register-email, submit-booking"
          else
            echo "âœ… å¤‰æ›´ã•ã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã¯data-testidãŒå«ã¾ã‚Œã¦ã„ã¾ã™"
          fi

  # =========================================
  # Job 5: tenant_idãƒ•ã‚£ãƒ«ã‚¿ãƒã‚§ãƒƒã‚¯
  # =========================================
  tenant-filter-check:
    name: Tenant ID Filter Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for tenant_id filtering in API routes
        run: |
          echo "ğŸ” APIãƒ«ãƒ¼ãƒˆã§ã®tenant_idãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

          # å¤‰æ›´ã•ã‚ŒãŸAPIãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          API_FILES=$(git diff --name-only origin/main...HEAD -- 'reserve-app/src/app/api/**/*.ts' 2>/dev/null || echo "")

          if [ -z "$API_FILES" ]; then
            echo "âœ… APIãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
            exit 0
          fi

          MISSING_TENANT=""

          for file in $API_FILES; do
            if [ -f "$file" ]; then
              # Prismaã‚¯ã‚¨ãƒªãŒã‚ã‚‹ãŒtenant_id/tenantIdãŒãªã„å ´åˆ
              if grep -q "prisma\." "$file"; then
                if ! grep -q "tenant_id\|tenantId" "$file"; then
                  MISSING_TENANT="${MISSING_TENANT}âŒ $file: tenant_idãƒ•ã‚£ãƒ«ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\n"
                fi
              fi
            fi
          done

          if [ -n "$MISSING_TENANT" ]; then
            echo "============================================"
            echo "ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Š: tenant_idãƒ•ã‚£ãƒ«ã‚¿ä¸è¶³"
            echo "============================================"
            echo -e "$MISSING_TENANT"
            echo ""
            echo "ğŸ“– ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆè¨­è¨ˆã®å¿…é ˆäº‹é …:"
            echo "  - å…¨ã¦ã®Prismaã‚¯ã‚¨ãƒªã«tenant_idãƒ•ã‚£ãƒ«ã‚¿ã‚’è¿½åŠ "
            echo "  - å‚è€ƒ: documents/spec/ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸.md"
            echo ""
            echo "âš ï¸ ã“ã®è­¦å‘Šã¯é‡è¦ã§ã™ã€‚ä¿®æ­£ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚"
            # exit 1  # æœ¬ç•ªé‹ç”¨æ™‚ã¯æœ‰åŠ¹åŒ–
          else
            echo "âœ… å¤‰æ›´ã•ã‚ŒãŸAPIãƒ«ãƒ¼ãƒˆã«ã¯tenant_idãƒ•ã‚£ãƒ«ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã™"
          fi

  # =========================================
  # Job 6: npm auditã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
  # =========================================
  security-audit:
    name: Security Audit (npm audit)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: reserve-app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: reserve-app/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          echo "ğŸ” ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

          # highä»¥ä¸Šã®è„†å¼±æ€§ã‚’ãƒã‚§ãƒƒã‚¯
          if npm audit --audit-level=high; then
            echo "âœ… é‡å¤§ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã¯ã‚ã‚Šã¾ã›ã‚“"
          else
            echo "============================================"
            echo "ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Š: è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "============================================"
            echo ""
            echo "ğŸ“– å¯¾å¿œæ–¹æ³•:"
            echo "  1. npm audit fix ã§è‡ªå‹•ä¿®æ­£ã‚’è©¦ã™"
            echo "  2. ä¿®æ­£ã§ããªã„å ´åˆã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’æ¤œè¨"
            echo ""
            echo "âš ï¸ è­¦å‘Šã¨ã—ã¦æ‰±ã„ã¾ã™"
            # exit 1  # æœ¬ç•ªé‹ç”¨æ™‚ã¯æœ‰åŠ¹åŒ–
          fi

  # =========================================
  # Job 7: å±é™ºãªãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒã‚§ãƒƒã‚¯
  # =========================================
  dangerous-patterns-check:
    name: Dangerous Patterns Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for dangerous patterns
        run: |
          echo "ğŸ” å±é™ºãªã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

          VIOLATIONS=""

          # dangerouslySetInnerHTML ã®ãƒã‚§ãƒƒã‚¯
          if grep -rn "dangerouslySetInnerHTML" reserve-app/src/ --include="*.tsx" --include="*.ts" 2>/dev/null; then
            VIOLATIONS="${VIOLATIONS}âš ï¸ dangerouslySetInnerHTMLä½¿ç”¨ã‚’æ¤œå‡ºï¼ˆXSSãƒªã‚¹ã‚¯ï¼‰\n"
          fi

          # $queryRawUnsafe ã®ãƒã‚§ãƒƒã‚¯
          if grep -rn '\$queryRawUnsafe\|\$executeRawUnsafe' reserve-app/src/ --include="*.ts" 2>/dev/null; then
            VIOLATIONS="${VIOLATIONS}âŒ $queryRawUnsafeä½¿ç”¨ã‚’æ¤œå‡ºï¼ˆSQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒªã‚¹ã‚¯ï¼‰\n"
          fi

          # eval/new Function ã®ãƒã‚§ãƒƒã‚¯
          if grep -rn "eval(\|new Function(" reserve-app/src/ --include="*.ts" --include="*.tsx" 2>/dev/null; then
            VIOLATIONS="${VIOLATIONS}âŒ eval/new Functionä½¿ç”¨ã‚’æ¤œå‡ºï¼ˆã‚³ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒªã‚¹ã‚¯ï¼‰\n"
          fi

          if [ -n "$VIOLATIONS" ]; then
            echo "============================================"
            echo "ğŸš¨ å±é™ºãªãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "============================================"
            echo -e "$VIOLATIONS"
            echo ""
            echo "ğŸ“– å‚è€ƒ: .claude/skills/typescript-security-checker/references/security-checklist.md"
            echo ""
            echo "âš ï¸ è­¦å‘Šã¨ã—ã¦æ‰±ã„ã¾ã™ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ç¢ºèªãŒå¿…è¦ï¼‰"
            # exit 1
          else
            echo "âœ… å±é™ºãªãƒ‘ã‚¿ãƒ¼ãƒ³ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          fi

  # =========================================
  # Job 8: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¼æ´©ãƒã‚§ãƒƒã‚¯ï¼ˆCIã§å¤±æ•—ï¼‰
  # =========================================
  secrets-check:
    name: Secrets Leak Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for hardcoded secrets
        run: |
          echo "ğŸ” ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

          SECRETS_FOUND=""

          # APIã‚­ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³
          if grep -rn "sk_live_\|pk_live_\|sk-[a-zA-Z0-9]\{20,\}" reserve-app/src/ --include="*.ts" --include="*.tsx" 2>/dev/null; then
            SECRETS_FOUND="${SECRETS_FOUND}âŒ APIã‚­ãƒ¼ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™\n"
          fi

          # JWT/ãƒˆãƒ¼ã‚¯ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³
          if grep -rn "eyJ[a-zA-Z0-9_-]*\.[a-zA-Z0-9_-]*\.[a-zA-Z0-9_-]*" reserve-app/src/ --include="*.ts" --include="*.tsx" 2>/dev/null | grep -v "test\|spec\|mock"; then
            SECRETS_FOUND="${SECRETS_FOUND}âŒ JWTãƒˆãƒ¼ã‚¯ãƒ³ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™\n"
          fi

          # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹URLï¼ˆèªè¨¼æƒ…å ±ä»˜ãï¼‰
          if grep -rn "postgresql://.*:.*@\|mysql://.*:.*@\|mongodb://.*:.*@" reserve-app/src/ --include="*.ts" --include="*.tsx" 2>/dev/null | grep -v ".example\|.test"; then
            SECRETS_FOUND="${SECRETS_FOUND}âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹URLãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™\n"
          fi

          if [ -n "$SECRETS_FOUND" ]; then
            echo "============================================"
            echo "ğŸš¨ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¼æ´©ã®å¯èƒ½æ€§ï¼"
            echo "============================================"
            echo -e "$SECRETS_FOUND"
            echo ""
            echo "ğŸ“– å¯¾å¿œæ–¹æ³•:"
            echo "  1. ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ç’°å¢ƒå¤‰æ•°ã«ç§»å‹•"
            echo "  2. .env.exampleã«ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®ã¿è¨˜è¼‰"
            echo "  3. gitå±¥æ­´ã‹ã‚‰ã‚‚ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å‰Šé™¤"
            echo ""
            exit 1  # ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¼æ´©ã¯CIã‚’å¤±æ•—ã•ã›ã‚‹
          else
            echo "âœ… ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          fi

  # =========================================
  # Job 9: ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
  # =========================================
  code-quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for code quality issues
        run: |
          echo "ğŸ” ã‚³ãƒ¼ãƒ‰å“è³ªã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

          WARNINGS=""

          # anyå‹ã®ä½¿ç”¨ãƒã‚§ãƒƒã‚¯ï¼ˆå¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ï¼‰
          CHANGED_TS=$(git diff --name-only origin/main...HEAD -- 'reserve-app/src/**/*.ts' 'reserve-app/src/**/*.tsx' 2>/dev/null || echo "")

          if [ -n "$CHANGED_TS" ]; then
            for file in $CHANGED_TS; do
              if [ -f "$file" ]; then
                if grep -n ": any\|: any\[\]\|as any" "$file" 2>/dev/null; then
                  WARNINGS="${WARNINGS}âš ï¸ $file: anyå‹ã®ä½¿ç”¨ã‚’æ¤œå‡º\n"
                fi
              fi
            done
          fi

          # console.logã®ä½¿ç”¨ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ†ã‚¹ãƒˆä»¥å¤–ï¼‰
          if [ -n "$CHANGED_TS" ]; then
            for file in $CHANGED_TS; do
              if [ -f "$file" ] && [[ ! "$file" =~ (test|spec|__tests__) ]]; then
                if grep -n "console\.log\|console\.debug" "$file" 2>/dev/null; then
                  WARNINGS="${WARNINGS}âš ï¸ $file: console.log/debugã®ä½¿ç”¨ã‚’æ¤œå‡º\n"
                fi
              fi
            done
          fi

          if [ -n "$WARNINGS" ]; then
            echo "============================================"
            echo "âš ï¸ ã‚³ãƒ¼ãƒ‰å“è³ªã®æ”¹å–„ãŒæ¨å¥¨ã•ã‚Œã¾ã™"
            echo "============================================"
            echo -e "$WARNINGS"
            echo ""
            echo "ğŸ“– å¯¾å¿œæ–¹æ³•:"
            echo "  - anyå‹ â†’ unknownå‹ + å‹ã‚¬ãƒ¼ãƒ‰ã«å¤‰æ›´"
            echo "  - console.log â†’ å‰Šé™¤ã¾ãŸã¯ãƒ­ã‚¬ãƒ¼ã«ç½®æ›"
            echo ""
            echo "âš ï¸ è­¦å‘Šã¨ã—ã¦æ‰±ã„ã¾ã™"
            # exit 1
          else
            echo "âœ… ã‚³ãƒ¼ãƒ‰å“è³ªã«å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“"
          fi

  # =========================================
  # Job 10: æ—¥æœ¬èªé‹ç”¨ãƒã‚§ãƒƒã‚¯
  # =========================================
  japanese-check:
    name: Japanese Language Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title for Japanese
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "ğŸ” PRã‚¿ã‚¤ãƒˆãƒ«ã®æ—¥æœ¬èªãƒã‚§ãƒƒã‚¯ä¸­..."

          # PRã‚¿ã‚¤ãƒˆãƒ«ã«æ—¥æœ¬èªãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if echo "$PR_TITLE" | grep -P '[\p{Hiragana}\p{Katakana}\p{Han}]' > /dev/null 2>&1; then
            echo "âœ… PRã‚¿ã‚¤ãƒˆãƒ«ã«æ—¥æœ¬èªãŒå«ã¾ã‚Œã¦ã„ã¾ã™"
          else
            echo "============================================"
            echo "âš ï¸ PRã‚¿ã‚¤ãƒˆãƒ«ã«æ—¥æœ¬èªãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "============================================"
            echo "ç¾åœ¨ã®ã‚¿ã‚¤ãƒˆãƒ«: $PR_TITLE"
            echo ""
            echo "ğŸ“– æ—¥æœ¬èªé‹ç”¨ãƒ«ãƒ¼ãƒ«:"
            echo "  - PRã‚¿ã‚¤ãƒˆãƒ«ã¯æ—¥æœ¬èªã§è¨˜è¿°"
            echo "  - ä¾‹: [FEATURE] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½ã‚’å®Ÿè£…"
            echo "  - å‚è€ƒ: .cursor/rules/æ—¥æœ¬èªé‹ç”¨ãƒ«ãƒ¼ãƒ«.md"
            echo ""
            echo "âš ï¸ è­¦å‘Šã¨ã—ã¦æ‰±ã„ã¾ã™"
            # exit 1
          fi

      - name: Check commit messages for Japanese
        run: |
          echo "ğŸ” ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ—¥æœ¬èªãƒã‚§ãƒƒã‚¯ä¸­..."

          # PRå†…ã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
          COMMITS=$(git log origin/main..HEAD --oneline 2>/dev/null || echo "")

          if [ -z "$COMMITS" ]; then
            echo "âœ… ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚³ãƒŸãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“"
            exit 0
          fi

          NON_JAPANESE=""
          while IFS= read -r line; do
            # æ—¥æœ¬èªã‚’å«ã¾ãªã„ã‚³ãƒŸãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯
            if ! echo "$line" | grep -P '[\p{Hiragana}\p{Katakana}\p{Han}]' > /dev/null 2>&1; then
              NON_JAPANESE="${NON_JAPANESE}  - $line\n"
            fi
          done <<< "$COMMITS"

          if [ -n "$NON_JAPANESE" ]; then
            echo "============================================"
            echo "âš ï¸ æ—¥æœ¬èªã‚’å«ã¾ãªã„ã‚³ãƒŸãƒƒãƒˆãŒã‚ã‚Šã¾ã™"
            echo "============================================"
            echo -e "$NON_JAPANESE"
            echo ""
            echo "ğŸ“– æ—¥æœ¬èªé‹ç”¨ãƒ«ãƒ¼ãƒ«:"
            echo "  - ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯æ—¥æœ¬èªã§è¨˜è¿°"
            echo "  - ä¾‹: feat: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½ã‚’å®Ÿè£…"
            echo ""
            echo "âš ï¸ è­¦å‘Šã¨ã—ã¦æ‰±ã„ã¾ã™"
            # exit 1
          else
            echo "âœ… å…¨ã¦ã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ—¥æœ¬èªãŒå«ã¾ã‚Œã¦ã„ã¾ã™"
          fi

  # =========================================
  # Job 11: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã—ãã„å€¤ãƒã‚§ãƒƒã‚¯
  # =========================================
  coverage-threshold:
    name: Coverage Threshold Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: reserve-app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: reserve-app/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Run tests with coverage
        run: |
          echo "ğŸ” ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."

          # ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          npm run test:coverage -- --passWithNoTests || true

          # ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
          if [ -f coverage/coverage-summary.json ]; then
            echo ""
            echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼:"
            cat coverage/coverage-summary.json | jq '.total'

            # ã—ãã„å€¤ãƒã‚§ãƒƒã‚¯ï¼ˆLines: 70%, Branches: 60%, Functions: 70%ï¼‰
            LINES=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
            BRANCHES=$(cat coverage/coverage-summary.json | jq '.total.branches.pct')
            FUNCTIONS=$(cat coverage/coverage-summary.json | jq '.total.functions.pct')

            echo ""
            echo "Lines: ${LINES}% (ç›®æ¨™: 70%)"
            echo "Branches: ${BRANCHES}% (ç›®æ¨™: 60%)"
            echo "Functions: ${FUNCTIONS}% (ç›®æ¨™: 70%)"

            # ã—ãã„å€¤ã‚’ä¸‹å›ã£ã¦ã„ã‚‹å ´åˆã¯è­¦å‘Š
            if (( $(echo "$LINES < 70" | bc -l) )) || \
               (( $(echo "$BRANCHES < 60" | bc -l) )) || \
               (( $(echo "$FUNCTIONS < 70" | bc -l) )); then
              echo ""
              echo "âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒã—ãã„å€¤ã‚’ä¸‹å›ã£ã¦ã„ã¾ã™"
              echo "âš ï¸ è­¦å‘Šã¨ã—ã¦æ‰±ã„ã¾ã™"
              # exit 1
            else
              echo ""
              echo "âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸ã¯ã—ãã„å€¤ã‚’æº€ãŸã—ã¦ã„ã¾ã™"
            fi
          else
            echo "âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
