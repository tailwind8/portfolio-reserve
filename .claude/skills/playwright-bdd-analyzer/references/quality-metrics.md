# BDD品質メトリクス

このドキュメントは、BDDテストの品質を測定するための具体的なメトリクスを定義します。

---

## 1. 基本メトリクス

### M1: Feature数

**定義**: プロジェクト内の`.feature`ファイルの総数

**目標値**: -（機能数に応じて変動）

**計算方法**:
```bash
find reserve-app/features -name "*.feature" | wc -l
```

---

### M2: Scenario数

**定義**: すべてのFeatureファイル内のScenario総数

**目標値**: -（機能数に応じて変動）

**計算方法**:
```bash
grep -r "Scenario:" reserve-app/features | wc -l
```

---

### M3: Step数

**定義**: すべてのScenario内のステップ（Given/When/Then/And/But）総数

**目標値**: -

**計算方法**:
```bash
grep -rE "^\s+(Given|When|Then|And|But)" reserve-app/features | wc -l
```

---

## 2. 品質メトリクス

### M4: ステップ再利用率

**定義**: 複数のシナリオで使われているステップ定義の割合

**目標値**: 60%以上

**計算方法**:
```
ステップ再利用率 = (使用回数2回以上のステップ数) / (総ステップ定義数) × 100%
```

**評価基準**:
- 80%以上: 優秀
- 60-79%: 良好
- 40-59%: 普通
- 40%未満: 要改善

**解釈**:
- 高い再利用率 → 保守性が高い
- 低い再利用率 → ステップ定義が重複している可能性

---

### M5: 宣言的シナリオ率

**定義**: 宣言的スタイルで記述されたシナリオの割合

**目標値**: 80%以上

**計算方法**:
```
宣言的シナリオ率 = (宣言的シナリオ数) / (総シナリオ数) × 100%
```

**判定基準**:

❌ 命令的（UIの詳細が含まれる）
```gherkin
When ユーザー名フィールドに "test@example.com" を入力する
And パスワードフィールドに "password123" を入力する
And ログインボタンをクリックする
```

✅ 宣言的（ビジネスの意図が明確）
```gherkin
When ユーザーが有効な認証情報でログインする
```

**評価基準**:
- 90%以上: 優秀
- 80-89%: 良好
- 60-79%: 普通
- 60%未満: 要改善

---

### M6: シナリオ独立性率

**定義**: 他のシナリオに依存せず単独実行可能なシナリオの割合

**目標値**: 100%

**計算方法**:
```
シナリオ独立性率 = (独立したシナリオ数) / (総シナリオ数) × 100%
```

**判定基準**:
- シナリオ実行順序に依存しない
- 前提条件が `Given` で明示されている
- 共有リソースへの依存がない

**評価基準**:
- 100%: 優秀
- 90-99%: 良好
- 80-89%: 要改善
- 80%未満: 重大な問題

---

### M7: Background活用率

**定義**: Backgroundを使用しているFeatureファイルの割合

**目標値**: 50%以上

**計算方法**:
```
Background活用率 = (Backgroundを使用しているFeature数) / (総Feature数) × 100%
```

**評価基準**:
- 60%以上: 優秀（共通前提条件を適切に抽出）
- 40-59%: 良好
- 20-39%: 普通
- 20%未満: 要改善（重複が多い可能性）

---

### M8: Scenario Outline活用率

**定義**: Scenario Outlineを使用しているFeatureファイルの割合

**目標値**: 30%以上

**計算方法**:
```
Scenario Outline活用率 = (Scenario Outlineを含むFeature数) / (総Feature数) × 100%
```

**評価基準**:
- 50%以上: 優秀（パラメータ化を積極的に活用）
- 30-49%: 良好
- 10-29%: 普通
- 10%未満: 要改善（類似シナリオが重複している可能性）

---

## 3. 網羅性メトリクス

### M9: ハッピーパスカバレッジ

**定義**: ハッピーパス（正常系）シナリオが存在する機能の割合

**目標値**: 100%

**計算方法**:
```
ハッピーパスカバレッジ = (ハッピーパスがある機能数) / (総機能数) × 100%
```

**評価基準**:
- 100%: 必須
- 90-99%: 早急に改善
- 90%未満: 重大な欠陥

---

### M10: エラーパスカバレッジ

**定義**: エラーパス（異常系）シナリオが存在する機能の割合

**目標値**: 100%

**計算方法**:
```
エラーパスカバレッジ = (エラーパスがある機能数) / (総機能数) × 100%
```

**評価基準**:
- 100%: 優秀
- 80-99%: 良好
- 60-79%: 普通
- 60%未満: 要改善

---

### M11: 境界値テストカバレッジ

**定義**: 境界値テストが存在する数値入力項目の割合

**目標値**: 80%以上

**計算方法**:
```
境界値テストカバレッジ = (境界値テストがある項目数) / (数値入力項目総数) × 100%
```

**対象項目**:
- 人数、価格、日付、数量など

**評価基準**:
- 90%以上: 優秀
- 80-89%: 良好
- 60-79%: 普通
- 60%未満: 要改善

---

### M12: セキュリティテストカバレッジ

**定義**: セキュリティテストが存在する入力項目の割合

**目標値**: 100%

**計算方法**:
```
セキュリティテストカバレッジ = (セキュリティテストがある項目数) / (ユーザー入力項目総数) × 100%
```

**必須セキュリティテスト**:
- XSS対策（スクリプトタグの入力）
- CSRF対策（トークンなしリクエスト）
- 認証バイパステスト（未認証アクセス）

**評価基準**:
- 100%: 必須
- 80-99%: 早急に改善
- 80%未満: 重大なセキュリティリスク

---

## 4. 保守性メトリクス

### M13: タグ付け率

**定義**: タグが付与されているシナリオの割合

**目標値**: 90%以上

**計算方法**:
```
タグ付け率 = (タグ付きシナリオ数) / (総シナリオ数) × 100%
```

**評価基準**:
- 95%以上: 優秀
- 90-94%: 良好
- 80-89%: 普通
- 80%未満: 要改善

---

### M14: フレーキーテスト率

**定義**: フレーキーパターンを含むテストの割合

**目標値**: 0%

**計算方法**:
```
フレーキーテスト率 = (フレーキーパターンを含むテスト数) / (総テスト数) × 100%
```

**フレーキーパターン**:
- `page.waitForTimeout()` の使用
- テキストセレクタの使用
- ネストした待機処理

**評価基準**:
- 0%: 優秀
- 1-5%: 良好
- 6-10%: 要改善
- 10%超: 重大な問題

---

## 5. 複合メトリクス

### M15: 総合品質スコア

**定義**: すべてのメトリクスを加重平均した総合スコア

**目標値**: 80以上

**計算方法**:
```
総合品質スコア = Σ(各メトリクスのスコア × 重み) / Σ重み
```

**重み付け**:
| メトリクス | 重み | 理由 |
|-----------|------|------|
| ハッピーパスカバレッジ | 10 | 最重要 |
| エラーパスカバレッジ | 10 | 最重要 |
| セキュリティテストカバレッジ | 10 | 最重要 |
| シナリオ独立性率 | 8 | 重要 |
| ステップ再利用率 | 6 | 中程度 |
| 宣言的シナリオ率 | 6 | 中程度 |
| 境界値テストカバレッジ | 5 | 中程度 |
| フレーキーテスト率 | 5 | 中程度 |
| Background活用率 | 3 | 低 |
| Scenario Outline活用率 | 3 | 低 |
| タグ付け率 | 2 | 低 |

**評価基準**:
- 90-100: S級（優秀）
- 80-89: A級（良好）
- 70-79: B級（普通）
- 60-69: C級（要改善）
- 60未満: D級（大幅な改善が必要）

---

## 6. トレンド分析

### M16: 品質スコアの推移

**定義**: 総合品質スコアの時系列変化

**目標**: 継続的な改善（右肩上がり）

**測定頻度**: 週次または月次

**グラフ例**:
```
100 ┤                              ●
 90 ┤                         ●
 80 ┤                    ●
 70 ┤               ●
 60 ┤          ●
    └─────────────────────────────
     W1   W2   W3   W4   W5   W6
```

---

## 7. ダッシュボード例

```markdown
# BDD品質ダッシュボード

## 総合評価: A級（85点）

### 基本メトリクス
- Feature数: 12
- Scenario数: 87
- Step数: 342

### 品質メトリクス
| メトリクス | 現在値 | 目標 | 状態 |
|-----------|--------|------|------|
| ステップ再利用率 | 68% | 60% | ✅ |
| 宣言的シナリオ率 | 75% | 80% | ⚠️ |
| シナリオ独立性率 | 100% | 100% | ✅ |

### 網羅性メトリクス
| メトリクス | 現在値 | 目標 | 状態 |
|-----------|--------|------|------|
| ハッピーパスカバレッジ | 100% | 100% | ✅ |
| エラーパスカバレッジ | 92% | 100% | ⚠️ |
| 境界値テストカバレッジ | 70% | 80% | ⚠️ |
| セキュリティテストカバレッジ | 100% | 100% | ✅ |

### 保守性メトリクス
| メトリクス | 現在値 | 目標 | 状態 |
|-----------|--------|------|------|
| タグ付け率 | 95% | 90% | ✅ |
| フレーキーテスト率 | 3% | 0% | ⚠️ |

## 改善優先度

1. 🔴 エラーパスカバレッジを100%にする（1機能不足）
2. 🟡 宣言的シナリオ率を向上（22シナリオ要リファクタ）
3. 🟡 境界値テストを追加（3項目不足）
4. 🟡 フレーキーテストを修正（3テスト）
```

---

## まとめ

これらのメトリクスを定期的に測定・分析することで、BDDテストの品質を継続的に改善できます。

重要なのは、スコアを上げることではなく、**実際のバグ検出能力と保守性を向上させること**です。
