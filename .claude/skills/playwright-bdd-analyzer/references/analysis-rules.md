# BDD分析ルール詳細

このドキュメントは、Playwright-BDD Analyzerが使用する詳細な分析ルールを定義します。

---

## 1. Gherkin品質ルール

### R1-1: 宣言的スタイルの使用

**ルール**: シナリオは「何をするか」ではなく「何が起こるか」を記述すべき

**検出パターン**:
- UIの詳細（ボタン、フィールド、クリック）が直接記述されている
- `When` ステップに「〜をクリックする」「〜を入力する」が含まれる

**例**:

❌ 命令的
```gherkin
When ユーザー名フィールドに "test@example.com" を入力する
And パスワードフィールドに "password123" を入力する
And ログインボタンをクリックする
```

✅ 宣言的
```gherkin
When ユーザーが有効な認証情報でログインする
```

**重要度**: 中

---

### R1-2: シナリオの独立性

**ルール**: 各シナリオは他のシナリオに依存せず、単独で実行可能であること

**検出パターン**:
- 「前のシナリオで〜」のような記述
- シナリオ実行順序に依存する状態管理

**例**:

❌ 依存あり
```gherkin
Scenario: ユーザーを作成する
  When ユーザー "test@example.com" を作成する

Scenario: 作成したユーザーでログインする  # 前のシナリオに依存
  When ユーザー "test@example.com" でログインする
```

✅ 独立
```gherkin
Scenario: ユーザーを作成する
  When ユーザー "test@example.com" を作成する

Scenario: 既存ユーザーでログインする
  Given ユーザー "test@example.com" が存在する  # 独立した前提条件
  When ユーザー "test@example.com" でログインする
```

**重要度**: 高

---

### R1-3: Backgroundの適切な使用

**ルール**: 複数シナリオで共通の前提条件は `Background` に抽出すべき

**検出パターン**:
- 同じ `Given` ステップが3つ以上のシナリオで繰り返される

**例**:

❌ 繰り返し
```gherkin
Scenario: 予約を作成する
  Given 管理者がログイン済みである
  When 予約を作成する

Scenario: 予約を更新する
  Given 管理者がログイン済みである  # 繰り返し
  When 予約を更新する

Scenario: 予約を削除する
  Given 管理者がログイン済みである  # 繰り返し
  When 予約を削除する
```

✅ Background使用
```gherkin
Background:
  Given 管理者がログイン済みである

Scenario: 予約を作成する
  When 予約を作成する

Scenario: 予約を更新する
  When 予約を更新する

Scenario: 予約を削除する
  When 予約を削除する
```

**重要度**: 中

---

### R1-4: Scenario Outlineの活用

**ルール**: 類似ケースは `Scenario Outline` でパラメータ化すべき

**検出パターン**:
- 構造が同じで値だけ異なるシナリオが3つ以上

**例**:

❌ 繰り返し
```gherkin
Scenario: メールアドレスが無効な場合エラーが表示される
  When メールアドレスに "invalid-email" を入力する
  Then "正しいメールアドレスを入力してください" というエラーが表示される

Scenario: 電話番号が無効な場合エラーが表示される
  When 電話番号に "abc-defg" を入力する
  Then "正しい電話番号を入力してください" というエラーが表示される
```

✅ Scenario Outline
```gherkin
Scenario Outline: 不正な形式の入力でエラーが表示される
  When <field> に "<invalid_value>" を入力する
  Then "<error_message>" というエラーが表示される

  Examples:
    | field | invalid_value | error_message |
    | メールアドレス | invalid-email | 正しいメールアドレスを入力してください |
    | 電話番号 | abc-defg | 正しい電話番号を入力してください |
```

**重要度**: 中

---

## 2. 網羅性ルール

### R2-1: ハッピーパスの存在

**ルール**: すべての主要機能にハッピーパス（正常系）シナリオが存在すること

**検出パターン**:
- 機能に対応するFeatureファイルにハッピーパスシナリオが0件

**重要度**: 高

---

### R2-2: エラーパスの存在

**ルール**: すべての主要機能にエラーパス（異常系）シナリオが存在すること

**検出パターン**:
- ハッピーパスのみでエラーケースが0件
- 認証失敗、バリデーションエラーなどのシナリオがない

**重要度**: 高

---

### R2-3: 境界値テストの存在

**ルール**: 数値入力やリストがある場合、境界値テストが存在すること

**検出パターン**:
- 人数、価格、日付などの入力項目に対する境界値テストがない

**例**:

必要な境界値テスト:
- 人数: 0人（最小-1）、1人（最小）、10人（最大）、11人（最大+1）
- 価格: 0円、負の値、最大値
- 日付: 過去、今日、未来

**重要度**: 中

---

### R2-4: 認証・認可パターンの存在

**ルール**: アクセス制御がある機能には、以下のシナリオが存在すること

- 未認証ユーザー
- 認証済み一般ユーザー
- 管理者ユーザー
- 権限不足ユーザー

**重要度**: 高

---

### R2-5: マルチテナント分離の確認

**ルール**: マルチテナントシステムの場合、テナント分離のシナリオが存在すること

**例**:

```gherkin
@security
Scenario: テナントAの管理者がテナントBのデータを閲覧できない
  Given テナントAの管理者がログイン済みである
  When 予約一覧APIを呼び出す
  Then テナントBの予約は含まれない
```

**重要度**: 高（マルチテナントシステムの場合）

---

## 3. ステップ定義ルール

### R3-1: ステップ再利用率

**ルール**: ステップ定義の再利用率は60%以上が目標

**計算方法**:
```
再利用率 = (使用回数2回以上のステップ数) / (総ステップ定義数) × 100%
```

**重要度**: 中

---

### R3-2: 重複ステップの統合

**ルール**: 意味が同じステップ定義は統合すべき

**検出パターン**:
```typescript
// 重複例
When('ユーザーが {string} にアクセスする', ...)
When('ユーザーが {string} ページにアクセスする', ...)
When('{string} にアクセスする', ...)
```

**重要度**: 低

---

### R3-3: パラメータ化の推奨

**ルール**: 類似ステップ定義はパラメータ化すべき

**例**:

❌ Before
```typescript
When('ユーザーがログインページにアクセスする', ...)
When('ユーザーがダッシュボードページにアクセスする', ...)
When('ユーザーが予約ページにアクセスする', ...)
```

✅ After
```typescript
When('ユーザーが {string} にアクセスする', async ({ page }, url: string) => {
  await page.goto(url);
})
```

**重要度**: 中

---

## 4. 実行効率ルール

### R4-1: フレーキーパターンの検出

**ルール**: 以下のパターンは避けるべき

#### パターン1: 固定待機時間

❌ 避ける
```typescript
await page.waitForTimeout(2000);
```

✅ 推奨
```typescript
await page.waitForSelector('[data-testid="result"]');
```

#### パターン2: テキストセレクタ

❌ 避ける
```typescript
await page.click('button:has-text("予約する")');
```

✅ 推奨
```typescript
await page.click('[data-testid="submit-booking"]');
```

#### パターン3: ネストした待機

❌ 避ける
```typescript
await page.waitForTimeout(1000);
await page.waitForSelector('.loading');
await page.waitForTimeout(2000);
```

✅ 推奨
```typescript
await page.waitForSelector('.loading', { state: 'detached' });
```

**重要度**: 高

---

### R4-2: 並列実行可能性

**ルール**: シナリオは並列実行可能であるべき

**検出パターン**:
- 共有リソース（グローバル変数、ファイル）への依存
- シナリオ間の順序依存

**重要度**: 中

---

## 5. タグ付けルール

### R5-1: タグの必須化

**ルール**: すべてのシナリオに少なくとも1つのタグが付与されていること

**推奨タグ**:
- `@smoke`: クリティカルパス
- `@regression`: リグレッションテスト
- `@api`: API Routes
- `@ui`: UIインタラクション
- `@security`: セキュリティ
- `@concurrency`: 同時実行

**重要度**: 中

---

### R5-2: タグの一貫性

**ルール**: タグの命名は一貫性を持つべき

**検出パターン**:
- 類似タグ: `@smoke` と `@smoke-test`
- 大文字小文字の不一致: `@API` と `@api`

**重要度**: 低

---

## 6. セキュリティルール

### R6-1: XSS/CSRFテストの存在

**ルール**: ユーザー入力がある機能には、XSS/CSRFテストが存在すること

**例**:

```gherkin
@security
Scenario: XSS攻撃を防ぐ
  When 名前フィールドに "<script>alert('XSS')</script>" を入力する
  Then スクリプトが実行されない
  And サニタライズされたテキストとして保存される
```

**重要度**: 高

---

### R6-2: 認証バイパステストの存在

**ルール**: 認証が必要な機能には、認証バイパステストが存在すること

**例**:

```gherkin
@security
Scenario: 未認証ユーザーが管理者ページにアクセスできない
  Given ユーザーが未認証である
  When "/admin/dashboard" にアクセスを試みる
  Then "/login" にリダイレクトされる
```

**重要度**: 高

---

## 7. スコアリング

### 総合品質スコア

```
総合品質スコア = (各ルールのスコア合計) / (最大スコア) × 100
```

### 重要度別配点

- **高**: 10点
- **中**: 5点
- **低**: 2点

### 評価基準

| スコア | 評価 | 説明 |
|--------|------|------|
| 90-100 | 優秀 | 高品質なBDDテスト |
| 75-89 | 良好 | 一部改善の余地あり |
| 60-74 | 普通 | 改善が必要 |
| 0-59 | 要改善 | 大幅な改善が必要 |

---

## まとめ

このドキュメントで定義されたルールに基づいて、BDDテストの品質を定量的に評価します。

各ルールの重要度と検出パターンを理解し、継続的な品質改善に活用してください。
