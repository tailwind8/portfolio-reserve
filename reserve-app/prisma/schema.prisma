// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ========================================
// Booking System Models
// ========================================
// Note: All tables use 'booking_' prefix for multi-portfolio support
// tenantId is used for logical data separation

model BookingUser {
  id        String   @id @default(uuid())
  tenantId  String   @default("demo-booking") @map("tenant_id")
  authId    String?  @unique @map("auth_id") // Supabase Auth UUID
  email     String
  name      String?
  phone     String?
  memo      String?  @default("") // 顧客メモ（500文字以内）
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  reservations BookingReservation[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("booking_users")
}

model BookingStaff {
  id        String   @id @default(uuid())
  tenantId  String   @default("demo-booking") @map("tenant_id")
  name      String
  email     String
  phone     String?
  role      String? // 役職（例: スタイリスト、シニアスタイリスト）
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  reservations BookingReservation[]
  shifts       BookingStaffShift[]
  vacations    BookingStaffVacation[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("booking_staff")
}

model BookingMenu {
  id          String   @id @default(uuid())
  tenantId    String   @default("demo-booking") @map("tenant_id")
  name        String
  description String?
  price       Int // 価格（円）
  duration    Int // 所要時間（分）
  isActive    Boolean  @default(true) @map("is_active")
  category    String? // カテゴリ（例: カット、カラー、パーマ）
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  reservations BookingReservation[]

  @@index([tenantId])
  @@map("booking_menus")
}

model BookingReservation {
  id       String  @id @default(uuid())
  tenantId String  @default("demo-booking") @map("tenant_id")
  userId   String  @map("user_id")
  staffId  String? @map("staff_id") // オプショナル（指名なし可）
  menuId   String  @map("menu_id")

  reservedDate DateTime          @map("reserved_date") // 予約日
  reservedTime String            @map("reserved_time") // 予約時間（例: "14:00"）
  status       ReservationStatus @default(PENDING)

  notes        String?  @default("") // 備考・要望
  reminderSent Boolean  @default(false) @map("reminder_sent") // リマインダーメール送信済みフラグ
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user  BookingUser   @relation(fields: [userId], references: [id], onDelete: Cascade)
  staff BookingStaff? @relation(fields: [staffId], references: [id])
  menu  BookingMenu   @relation(fields: [menuId], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@index([reservedDate])
  // 複合インデックス（パフォーマンス最適化）
  @@index([tenantId, userId]) // ユーザーの予約一覧
  @@index([tenantId, staffId, reservedDate]) // スタッフの予約状況
  @@index([tenantId, status]) // ステータス別予約取得
  @@index([staffId, reservedDate, status]) // スタッフの空き状況確認
  @@map("booking_reservations")
}

model BookingSettings {
  id         String  @id @default(uuid())
  tenantId   String  @unique @default("demo-booking") @map("tenant_id")
  storeName  String  @map("store_name")
  storeEmail String? @map("store_email")
  storePhone String? @map("store_phone")

  openTime   String   @default("09:00") @map("open_time")
  closeTime  String   @default("20:00") @map("close_time")
  closedDays String[] @default([]) @map("closed_days") // 定休日（例: ["Sunday", "Monday"]）

  slotDuration Int @default(30) @map("slot_duration") // 予約枠の間隔（分）

  isPublic Boolean @default(true) @map("is_public") // システム公開・非公開フラグ

  // 予約受付期間設定
  minAdvanceBookingDays Int @default(0) @map("min_advance_booking_days") // 何日後から予約可能
  maxAdvanceBookingDays Int @default(90) @map("max_advance_booking_days") // 何日後まで予約可能

  // キャンセル期限設定
  cancellationDeadlineHours Int @default(24) @map("cancellation_deadline_hours") // 予約日の何時間前までキャンセル可能

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("booking_settings")
}

// ========================================
// Staff Shift Models
// ========================================

model BookingStaffShift {
  id        String    @id @default(uuid())
  tenantId  String    @default("demo-booking") @map("tenant_id")
  staffId   String    @map("staff_id")
  dayOfWeek DayOfWeek @map("day_of_week") // 曜日
  startTime String    @map("start_time") // 出勤時間（例: "09:00"）
  endTime   String    @map("end_time") // 退勤時間（例: "18:00"）
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  staff BookingStaff @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([tenantId, staffId, dayOfWeek])
  @@index([tenantId])
  @@index([staffId])
  @@map("booking_staff_shifts")
}

model BookingStaffVacation {
  id        String   @id @default(uuid())
  tenantId  String   @default("demo-booking") @map("tenant_id")
  staffId   String   @map("staff_id")
  startDate DateTime @map("start_date") // 休暇開始日
  endDate   DateTime @map("end_date") // 休暇終了日
  reason    String? // 理由（任意）
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  staff BookingStaff @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([staffId])
  @@index([startDate, endDate])
  @@map("booking_staff_vacations")
}

// ========================================
// Enums
// ========================================

enum ReservationStatus {
  PENDING // 予約確定待ち
  CONFIRMED // 確定
  CANCELLED // キャンセル
  COMPLETED // 完了（来店済み）
  NO_SHOW // 無断キャンセル
}

enum DayOfWeek {
  MONDAY // 月曜日
  TUESDAY // 火曜日
  WEDNESDAY // 水曜日
  THURSDAY // 木曜日
  FRIDAY // 金曜日
  SATURDAY // 土曜日
  SUNDAY // 日曜日
}
