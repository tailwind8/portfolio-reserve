// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ========================================
// Booking System Models
// ========================================
// Note: All tables use 'booking_' prefix for multi-portfolio support
// tenantId is used for logical data separation

model BookingUser {
  id        String   @id @default(uuid())
  tenantId  String   @default("demo-booking") @map("tenant_id")
  authId    String?  @unique @map("auth_id") // Supabase Auth UUID
  email     String
  name      String?
  phone     String?
  memo      String?  @default("") // 顧客メモ（500文字以内）
  role      UserRole @default(CUSTOMER) // ユーザーロール（CUSTOMER, ADMIN, SUPER_ADMIN）
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  reservations BookingReservation[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([role]) // ロール検索用インデックス
  @@map("booking_users")
}

model BookingStaff {
  id        String   @id @default(uuid())
  tenantId  String   @default("demo-booking") @map("tenant_id")
  name      String
  email     String
  phone     String?
  role      String? // 役職（例: スタイリスト、シニアスタイリスト）
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  reservations BookingReservation[]
  shifts       BookingStaffShift[]
  vacations    BookingStaffVacation[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("booking_staff")
}

model BookingMenu {
  id          String   @id @default(uuid())
  tenantId    String   @default("demo-booking") @map("tenant_id")
  name        String
  description String?
  price       Int // 価格（円）
  duration    Int // 所要時間（分）
  isActive    Boolean  @default(true) @map("is_active")
  category    String? // カテゴリ（例: カット、カラー、パーマ）
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  reservations BookingReservation[]

  @@index([tenantId])
  @@map("booking_menus")
}

model BookingReservation {
  id       String  @id @default(uuid())
  tenantId String  @default("demo-booking") @map("tenant_id")
  userId   String  @map("user_id")
  staffId  String? @map("staff_id") // オプショナル（指名なし可）
  menuId   String  @map("menu_id")

  reservedDate DateTime          @map("reserved_date") // 予約日
  reservedTime String            @map("reserved_time") // 予約時間（例: "14:00"）
  status       ReservationStatus @default(PENDING)

  notes        String?  @default("") // 備考・要望
  reminderSent Boolean  @default(false) @map("reminder_sent") // リマインダーメール送信済みフラグ
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user  BookingUser   @relation(fields: [userId], references: [id], onDelete: Cascade)
  staff BookingStaff? @relation(fields: [staffId], references: [id])
  menu  BookingMenu   @relation(fields: [menuId], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@index([reservedDate])
  // 複合インデックス（パフォーマンス最適化）
  @@index([tenantId, userId]) // ユーザーの予約一覧
  @@index([tenantId, staffId, reservedDate]) // スタッフの予約状況
  @@index([tenantId, status]) // ステータス別予約取得
  @@index([staffId, reservedDate, status]) // スタッフの空き状況確認
  @@map("booking_reservations")
}

model BookingSettings {
  id         String  @id @default(uuid())
  tenantId   String  @unique @default("demo-booking") @map("tenant_id")
  storeName  String  @map("store_name")
  storeEmail String? @map("store_email")
  storePhone String? @map("store_phone")

  openTime   String   @default("09:00") @map("open_time")
  closeTime  String   @default("20:00") @map("close_time")
  closedDays String[] @default([]) @map("closed_days") // 定休日（例: ["Sunday", "Monday"]）

  slotDuration Int @default(30) @map("slot_duration") // 予約枠の間隔（分）

  isPublic Boolean @default(true) @map("is_public") // システム公開・非公開フラグ

  // 予約受付期間設定
  minAdvanceBookingDays Int @default(0) @map("min_advance_booking_days") // 何日後から予約可能
  maxAdvanceBookingDays Int @default(90) @map("max_advance_booking_days") // 何日後まで予約可能

  // キャンセル期限設定
  cancellationDeadlineHours Int @default(24) @map("cancellation_deadline_hours") // 予約日の何時間前までキャンセル可能

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("booking_settings")
}

// ========================================
// Staff Shift Models
// ========================================

model BookingStaffShift {
  id        String    @id @default(uuid())
  tenantId  String    @default("demo-booking") @map("tenant_id")
  staffId   String    @map("staff_id")
  dayOfWeek DayOfWeek @map("day_of_week") // 曜日
  startTime String    @map("start_time") // 出勤時間（例: "09:00"）
  endTime   String    @map("end_time") // 退勤時間（例: "18:00"）
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  staff BookingStaff @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([tenantId, staffId, dayOfWeek])
  @@index([tenantId])
  @@index([staffId])
  @@map("booking_staff_shifts")
}

model BookingStaffVacation {
  id        String   @id @default(uuid())
  tenantId  String   @default("demo-booking") @map("tenant_id")
  staffId   String   @map("staff_id")
  startDate DateTime @map("start_date") // 休暇開始日
  endDate   DateTime @map("end_date") // 休暇終了日
  reason    String? // 理由（任意）
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  staff BookingStaff @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([staffId])
  @@index([startDate, endDate])
  @@map("booking_staff_vacations")
}

// ========================================
// Feature Flags Model
// ========================================

model FeatureFlag {
  id       String @id @default(uuid())
  tenantId String @unique @default("demo-booking") @map("tenant_id")

  // オプション機能のフラグ（10種類）
  enableStaffSelection       Boolean @default(false) @map("enable_staff_selection") // スタッフ指名機能 (+8,000円)
  enableStaffShiftManagement Boolean @default(false) @map("enable_staff_shift_management") // スタッフシフト管理 (+10,000円)
  enableCustomerManagement   Boolean @default(true) @map("enable_customer_management") // 顧客管理・メモ機能 (+12,000円) ※既に実装済み
  enableReservationUpdate    Boolean @default(false) @map("enable_reservation_update") // 予約変更機能 (+5,000円)
  enableReminderEmail        Boolean @default(true) @map("enable_reminder_email") // リマインダーメール (+8,000円) ※一部実装済み
  enableManualReservation    Boolean @default(true) @map("enable_manual_reservation") // 予約手動追加 (+6,000円) ※既に実装済み
  enableAnalyticsReport      Boolean @default(true) @map("enable_analytics_report") // 分析レポート (+15,000円) ※一部実装済み
  enableRepeatRateAnalysis   Boolean @default(false) @map("enable_repeat_rate_analysis") // リピート率分析 (+12,000円)
  enableCouponFeature        Boolean @default(false) @map("enable_coupon_feature") // クーポン機能 (+18,000円)
  enableLineNotification     Boolean @default(false) @map("enable_line_notification") // LINE通知連携 (+20,000円)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("feature_flags")
}

// ========================================
// Enums
// ========================================

enum ReservationStatus {
  PENDING // 予約確定待ち
  CONFIRMED // 確定
  CANCELLED // キャンセル
  COMPLETED // 完了（来店済み）
  NO_SHOW // 無断キャンセル
}

enum DayOfWeek {
  MONDAY // 月曜日
  TUESDAY // 火曜日
  WEDNESDAY // 水曜日
  THURSDAY // 木曜日
  FRIDAY // 金曜日
  SATURDAY // 土曜日
  SUNDAY // 日曜日
}

enum UserRole {
  CUSTOMER // 一般ユーザー（顧客）
  ADMIN // 店舗管理者
  SUPER_ADMIN // スーパー管理者（開発者）
}

// ========================================
// Security Logging Model
// ========================================

model SecurityLog {
  id        String   @id @default(uuid())
  tenantId  String   @default("demo-booking") @map("tenant_id")
  eventType String   @map("event_type") // LOGIN_SUCCESS, LOGIN_FAILED, USER_REGISTER, LOGOUT, UNAUTHORIZED_ACCESS, RATE_LIMIT_EXCEEDED
  userId    String?  @map("user_id") // ログインユーザーがいる場合
  ipAddress String?  @map("ip_address") // リクエスト元IPアドレス
  userAgent String?  @map("user_agent") // User-Agent文字列
  metadata  Json? // その他の情報（email、reason、pathなど）
  createdAt DateTime @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([eventType])
  @@index([userId])
  @@index([createdAt])
  @@index([tenantId, eventType, createdAt]) // イベント種別・日時での検索用
  @@map("security_logs")
}
