# language: ja

Feature: 予約作成機能
  顧客として空き時間を確認して予約を作成したい

  Issue: #9, #10

  ユーザーストーリー:
  As a customer
  I want to view available time slots and create a reservation
  So that I can book an appointment at my preferred time

  Background:
    Given ユーザーが予約ページにアクセスしている

  # 基本表示
  Scenario: 予約ページが正しく表示される
    Then ページタイトルに「予約カレンダー」が表示される
    And サブタイトルに「ご希望の日時を選択してください」が表示される
    And カレンダーが表示される
    And 予約情報サイドバーが表示される

  Scenario: メニューとスタッフの選択欄が表示される
    When ページが読み込まれる
    Then メニュー選択ドロップダウンが表示される
    And スタッフ選択ドロップダウンが表示される
    And 備考入力欄が表示される

  # カレンダー機能
  Scenario: 現在の月が表示される
    When ページが読み込まれる
    Then 現在の年月が表示される
    And カレンダーに日付が表示される

  Scenario: 月のナビゲーションが機能する
    Given カレンダーが表示されている
    When 「次月 →」ボタンをクリックする
    Then 次の月のカレンダーが表示される
    When 「← 前月」ボタンをクリックする
    Then 前の月のカレンダーが表示される
    And 元の月に戻っている

  Scenario: 過去の日付が選択できない
    When ページが読み込まれる
    Then 過去の日付ボタンが無効化されている
    And 過去の日付はグレーアウトされている

  Scenario: 未来の日付が選択できる
    When ページが読み込まれる
    Then 未来の日付ボタンが有効化されている
    And 未来の日付は通常表示されている

  # メニュー選択
  Scenario: メニュー一覧が読み込まれる
    When ページが読み込まれる
    Then メニュー選択ドロップダウンにメニューが表示される

  Scenario: メニューを選択できる
    When メニュー選択ドロップダウンからメニューを選択する
    Then 選択したメニューが表示される

  Scenario: URLパラメータからメニューが事前選択される
    Given URLに「menuId=test-menu-id」パラメータが含まれている
    When 予約ページにアクセスする
    Then メニューが事前選択されている

  # スタッフ選択
  Scenario: スタッフ一覧が読み込まれる
    When ページが読み込まれる
    Then スタッフ選択ドロップダウンにスタッフが表示される

  Scenario: スタッフを選択できる
    When スタッフ選択ドロップダウンからスタッフを選択する
    Then 選択したスタッフが表示される

  # 空き時間表示
  Scenario: メニューと日付選択後に空き時間が表示される
    Given メニューを選択している
    When 未来の日付を選択する
    Then 「時間帯を選択」セクションが表示される
    And 利用可能な時間帯が表示される

  Scenario: スタッフ指定時の空き時間表示
    Given メニューを選択している
    And スタッフを選択している
    When 未来の日付を選択する
    Then 選択したスタッフの空き時間のみが表示される

  Scenario: 空き時間が存在しない場合
    Given メニューを選択している
    When 予約が満杯の日付を選択する
    Then 「予約可能な時間がありません」というメッセージが表示される

  # 時間帯選択
  Scenario: 時間帯を選択できる
    Given メニューと日付を選択している
    And 空き時間が表示されている
    When 利用可能な時間帯をクリックする
    Then 時間帯が選択状態になる
    And サイドバーに選択した時間が表示される

  Scenario: 別の時間帯を選択すると前の選択が解除される
    Given 時間帯を1つ選択している
    When 別の時間帯をクリックする
    Then 新しい時間帯が選択される
    And 前の時間帯の選択が解除される

  # 備考入力
  Scenario: 備考を入力できる
    When 備考入力欄に「窓際の席を希望します」と入力する
    Then 入力した備考が表示される

  Scenario: 備考の文字数カウンターが表示される
    When 備考入力欄に文字を入力する
    Then 文字カウンター「/500文字」が表示される

  Scenario: 備考が500文字を超えると入力できない
    When 備考入力欄に501文字入力しようとする
    Then 500文字までしか入力できない

  # 予約確定ボタンの状態
  Scenario: 必須項目未入力時は予約確定ボタンが無効
    When ページが読み込まれる
    Then 「予約を確定する」ボタンが無効化されている

  Scenario: メニューのみ選択時は予約確定ボタンが無効
    When メニューを選択する
    Then 「予約を確定する」ボタンが無効化されている

  Scenario: メニューとスタッフのみ選択時は予約確定ボタンが無効
    When メニューを選択する
    And スタッフを選択する
    Then 「予約を確定する」ボタンが無効化されている

  Scenario: メニュー・スタッフ・日付選択時は予約確定ボタンが無効
    When メニューを選択する
    And スタッフを選択する
    And 日付を選択する
    Then 「予約を確定する」ボタンが無効化されている

  Scenario: 全ての必須項目選択時は予約確定ボタンが有効
    When メニューを選択する
    And スタッフを選択する
    And 日付を選択する
    And 時間帯を選択する
    Then 「予約を確定する」ボタンが有効化されている

  # 予約確定フロー
  Scenario: 予約を正常に作成できる
    Given メニューを選択している
    And スタッフを選択している
    And 日付を選択している
    And 時間帯を選択している
    When 「予約を確定する」ボタンをクリックする
    Then 予約が作成される
    And 成功メッセージ「予約が完了しました。確認メールをお送りしましたのでご確認ください。」が表示される
    And フォームがリセットされる

  Scenario: 備考付きで予約を作成できる
    Given メニューを選択している
    And スタッフを選択している
    And 日付を選択している
    And 時間帯を選択している
    And 備考に「初回来店です」と入力している
    When 「予約を確定する」ボタンをクリックする
    Then 備考付きで予約が作成される
    And 成功メッセージが表示される

  Scenario: 予約作成中はボタンがローディング状態になる
    Given 全ての必須項目を選択している
    When 「予約を確定する」ボタンをクリックする
    Then ボタンがローディング状態になる
    And ボタンが無効化されている

  # サイドバー表示
  Scenario: サイドバーに選択した情報が表示される
    When メニューを選択する
    Then サイドバーに選択したメニュー名が表示される
    When スタッフを選択する
    Then サイドバーに選択したスタッフ名が表示される
    When 日付を選択する
    Then サイドバーに選択した日付が表示される
    When 時間帯を選択する
    Then サイドバーに選択した時間が表示される

  Scenario: サイドバーにメニューの料金と所要時間が表示される
    When メニューを選択する
    Then サイドバーに料金が表示される
    And サイドバーに所要時間が表示される

  # 機能セクション
  Scenario: 機能セクションが表示される
    When ページが読み込まれる
    Then 「24時間予約OK」が表示される
    And 「確認メール送信」が表示される
    And 「リマインダー」が表示される

  # エラーハンドリング
  Scenario: APIエラー時にエラーメッセージが表示される
    Given APIがエラーを返す
    When ページが読み込まれる
    Then 「エラーが発生しました」というメッセージが表示される

  Scenario: 予約作成失敗時にエラーメッセージが表示される
    Given 全ての必須項目を選択している
    And APIが予約作成エラーを返す
    When 「予約を確定する」ボタンをクリックする
    Then エラーメッセージ「予約の作成に失敗しました」が表示される
    And フォームはリセットされない

  # ローディング状態
  Scenario: 初回ローディング中にスピナーが表示される
    Given 予約ページにアクセスする
    When データ取得中である
    Then ローディングスピナーが表示される

  Scenario: 空き時間取得中にローディング表示される
    Given メニューを選択している
    When 日付を選択する
    Then 空き時間取得中のローディングが表示される

  # レスポンシブデザイン
  Scenario: モバイルで正しく表示される
    Given モバイル画面サイズ（375x667）に設定している
    When 予約ページにアクセスする
    Then カレンダーがモバイル用レイアウトで表示される
    And サイドバーが下部に表示される

  Scenario: タブレットで正しく表示される
    Given タブレット画面サイズ（768x1024）に設定している
    When 予約ページにアクセスする
    Then カレンダーとサイドバーが2カラムで表示される

  Scenario: デスクトップで正しく表示される
    Given デスクトップ画面サイズ（1920x1080）に設定している
    When 予約ページにアクセスする
    Then カレンダーとサイドバーが横並びで表示される

  # 日付選択の変更
  Scenario: 日付を変更すると時間帯選択がリセットされる
    Given メニューと日付と時間帯を選択している
    When 別の日付を選択する
    Then 時間帯の選択がリセットされる
    And 新しい日付の空き時間が表示される

  # 予約完了後のフロー
  Scenario: 予約完了後3秒でメッセージが消える
    Given 予約が完了している
    And 成功メッセージが表示されている
    When 3秒待つ
    Then 成功メッセージが消える

  # アクセシビリティ
  Scenario: キーボード操作で日付を選択できる
    Given カレンダーが表示されている
    When Tabキーで日付にフォーカスする
    And Enterキーを押す
    Then 日付が選択される

  Scenario: スクリーンリーダー用のラベルが設定されている
    When ページが読み込まれる
    Then メニュー選択にaria-labelが設定されている
    And スタッフ選択にaria-labelが設定されている
    And カレンダーにaria-labelが設定されている
