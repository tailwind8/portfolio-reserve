# language: ja

Feature: リマインダーメール自動送信機能
  顧客として予約前日にリマインダーメールを受信したい

  Issue: #25

  ユーザーストーリー:
  As a customer
  I want to receive a reminder email before my reservation
  So that I don't forget my appointment

  Background:
    Given データベースに翌日の予約が存在する

  # リマインダーメール送信（Cron Job）
  Scenario: 翌日に予約がある顧客にリマインダーメールが送信される
    Given 翌日18:00に予約がある顧客「山田太郎」が存在する
    And 顧客のメールアドレスは「yamada@example.com」である
    And 予約メニューは「カット＋カラー」である
    When リマインダーメール送信Cron Jobが実行される
    Then 「yamada@example.com」宛にリマインダーメールが送信される
    And メール件名は「【予約リマインダー】明日のご予約について」である
    And メール本文に「山田太郎 様」が含まれる
    And メール本文に予約日時が含まれる
    And メール本文に予約メニュー「カット＋カラー」が含まれる
    And データベースの予約に「リマインダー送信済み」フラグが立つ

  Scenario: 複数の顧客に一括送信される
    Given 翌日に予約がある顧客が3人存在する
    When リマインダーメール送信Cron Jobが実行される
    Then 3通のリマインダーメールが送信される
    And すべての予約に「リマインダー送信済み」フラグが立つ

  Scenario: すでにリマインダー送信済みの予約はスキップされる
    Given 翌日に予約がある顧客「佐藤花子」が存在する
    And その予約はすでに「リマインダー送信済み」である
    When リマインダーメール送信Cron Jobが実行される
    Then 「佐藤花子」にはメールが送信されない
    And 送信されたメール数は0件である

  Scenario: キャンセル済みの予約にはリマインダーが送信されない
    Given 翌日に予約があったが「キャンセル済み」の予約が存在する
    When リマインダーメール送信Cron Jobが実行される
    Then メールは送信されない
    And 送信されたメール数は0件である

  Scenario: 当日や2日後の予約にはリマインダーが送信されない
    Given 当日18:00に予約がある顧客が存在する
    And 2日後18:00に予約がある顧客が存在する
    When リマインダーメール送信Cron Jobが実行される
    Then メールは送信されない
    And 送信されたメール数は0件である

  # メールテンプレート内容
  Scenario: リマインダーメールに必要な情報がすべて含まれる
    Given 翌日10:00に予約がある顧客「鈴木一郎」が存在する
    And 予約メニューは「シャンプー＋ブロー」である
    And 担当スタッフは「田中美容師」である
    When リマインダーメール送信Cron Jobが実行される
    Then 送信されたメールに以下の情報が含まれる:
      | 項目         | 値                     |
      | 顧客名       | 鈴木一郎 様            |
      | 予約日時     | 明日 10:00            |
      | メニュー     | シャンプー＋ブロー      |
      | 担当スタッフ | 田中美容師             |
      | キャンセル方法 | マイページからキャンセル可能 |

  # API エンドポイント
  Scenario: リマインダーメール送信APIが正常に動作する
    Given 翌日に予約がある顧客が5人存在する
    When "/api/cron/send-reminders" APIにGETリクエストを送信する
    Then HTTPステータスコード200が返される
    And レスポンスボディに「送信件数: 5」が含まれる
    And レスポンスボディに「成功: 5」が含まれる
    And レスポンスボディに「失敗: 0」が含まれる

  Scenario: メール送信エラー時も処理が継続される
    Given 翌日に予約がある顧客が3人存在する
    And 2人目の顧客のメールアドレスが無効である
    When "/api/cron/send-reminders" APIにGETリクエストを送信する
    Then HTTPステータスコード200が返される
    And レスポンスボディに「送信件数: 3」が含まれる
    And レスポンスボディに「成功: 2」が含まれる
    And レスポンスボディに「失敗: 1」が含まれる
    And 有効なメールアドレスの顧客2人にはメールが送信される

  # セキュリティ
  Scenario: 認証トークンなしではAPIにアクセスできない
    When "/api/cron/send-reminders" APIに認証トークンなしでGETリクエストを送信する
    Then HTTPステータスコード401が返される
    And レスポンスボディに「Unauthorized」が含まれる
    And メールは送信されない
