# language: ja

Feature: ユーザーログイン
  登録済みユーザーとしてログインしたい

  Issue: #6

  ユーザーストーリー:
  As a registered customer
  I want to log in to my account
  So that I can access my reservations and make new bookings

  Background:
    Given ユーザーがログインページにアクセスしている

  # 基本表示
  Scenario: ログインページが正しく表示される
    Then ページタイトルに「予約システム」が表示される
    And ページ見出しに「ログイン」が表示される
    And メールアドレス入力欄が表示される
    And パスワード入力欄が表示される
    And ログイン状態保持チェックボックスが表示される
    And 「ログイン」ボタンが表示される

  Scenario: 関連リンクが表示される
    Then 新規登録リンクが表示される
    And 新規登録リンクのhrefが「/register」である
    And 管理者ログインリンクが表示される
    And 管理者ログインリンクのhrefが「/admin/login」である
    And パスワードリセットリンクが表示される
    And パスワードリセットリンクのhrefが「/reset-password」である

  # 成功シナリオ
  Scenario: 正しい認証情報でログインできる
    Given ユーザー「test@example.com」がパスワード「password123」で登録されている
    When メールアドレスに「test@example.com」と入力する
    And パスワードに「password123」と入力する
    And 「ログイン」ボタンをクリックする
    Then ログインが成功する
    And ホームページ「/」にリダイレクトされる

  Scenario: ログイン状態保持をチェックしてログインできる
    Given ユーザー「test@example.com」がパスワード「password123」で登録されている
    When メールアドレスに「test@example.com」と入力する
    And パスワードに「password123」と入力する
    And ログイン状態保持チェックボックスをチェックする
    And 「ログイン」ボタンをクリックする
    Then ログインが成功する
    And ログイン状態が保持される

  # ログイン状態保持チェックボックス
  Scenario: ログイン状態保持チェックボックスがデフォルトで未チェック
    Then ログイン状態保持チェックボックスが未チェックである

  Scenario: ログイン状態保持チェックボックスをチェックできる
    When ログイン状態保持チェックボックスをクリックする
    Then ログイン状態保持チェックボックスがチェック済みである

  Scenario: ログイン状態保持チェックボックスを再度クリックするとチェックが外れる
    Given ログイン状態保持チェックボックスがチェック済みである
    When ログイン状態保持チェックボックスをクリックする
    Then ログイン状態保持チェックボックスが未チェックである

  # バリデーションエラー - 空欄
  Scenario: 必須項目が空欄の場合エラーが表示される
    When 何も入力せずに「ログイン」ボタンをクリックする
    Then エラーメッセージ「有効なメールアドレスを入力してください」が表示される
    And エラーメッセージ「パスワードを入力してください」が表示される
    And ページはリダイレクトされない

  Scenario: メールアドレスが空欄の場合エラーが表示される
    When パスワードに「password123」と入力する
    And 「ログイン」ボタンをクリックする
    Then エラーメッセージ「有効なメールアドレスを入力してください」が表示される

  Scenario: パスワードが空欄の場合エラーが表示される
    When メールアドレスに「test@example.com」と入力する
    And 「ログイン」ボタンをクリックする
    Then エラーメッセージ「パスワードを入力してください」が表示される

  # バリデーションエラー - メールアドレス形式
  Scenario: 無効なメールアドレス形式の場合エラーが表示される
    When メールアドレスに「invalid-email」と入力する
    And パスワードに「password123」と入力する
    And 「ログイン」ボタンをクリックする
    Then エラーメッセージ「有効なメールアドレスを入力してください」が表示される

  # 認証エラー
  Scenario: 無効な認証情報でログインを試みるとエラーが表示される
    When メールアドレスに「nonexistent@example.com」と入力する
    And パスワードに「wrongpassword」と入力する
    And 「ログイン」ボタンをクリックする
    Then エラーメッセージ「メールアドレスまたはパスワードが正しくありません」が表示される
    And ページはリダイレクトされない

  Scenario: 存在するメールアドレスでも間違ったパスワードだとエラーが表示される
    Given ユーザー「test@example.com」がパスワード「password123」で登録されている
    When メールアドレスに「test@example.com」と入力する
    And パスワードに「wrongpassword」と入力する
    And 「ログイン」ボタンをクリックする
    Then エラーメッセージ「メールアドレスまたはパスワードが正しくありません」が表示される

  Scenario: 存在しないメールアドレスでエラーが表示される
    When メールアドレスに「nonexistent@example.com」と入力する
    And パスワードに「password123」と入力する
    And 「ログイン」ボタンをクリックする
    Then エラーメッセージ「メールアドレスまたはパスワードが正しくありません」が表示される

  # リアルタイムバリデーション
  Scenario: フィールドに入力を始めるとそのフィールドのエラーが消える
    Given 何も入力せずに送信してエラーが表示されている
    When メールアドレスに「test@example.com」と入力する
    Then メールアドレスのエラーメッセージが消える

  Scenario: パスワードに入力を始めるとパスワードのエラーが消える
    Given 何も入力せずに送信してエラーが表示されている
    When パスワードに「password」と入力する
    Then パスワードのエラーメッセージが消える

  # ローディング状態
  Scenario: 送信中はボタンがローディング状態になる
    Given メールアドレスとパスワードを入力している
    When 「ログイン」ボタンをクリックする
    Then ボタンがローディング状態になる
    And ボタンが無効化されている

  # エラーハンドリング
  Scenario: APIエラー時にエラーメッセージが表示される
    Given APIがエラーを返す
    When メールアドレスに「test@example.com」と入力する
    And パスワードに「password123」と入力する
    And 「ログイン」ボタンをクリックする
    Then エラーメッセージ「ログインに失敗しました」が表示される
    And ページはリダイレクトされない

  Scenario: ネットワークエラー時にエラーメッセージが表示される
    Given ネットワークエラーが発生する
    When メールアドレスに「test@example.com」と入力する
    And パスワードに「password123」と入力する
    And 「ログイン」ボタンをクリックする
    Then エラーメッセージ「予期しないエラーが発生しました。もう一度お試しください。」が表示される

  # パスワードリセット
  Scenario: パスワードリセットリンクをクリックできる
    When パスワードリセットリンクをクリックする
    Then パスワードリセットページ「/reset-password」に遷移する

  # 新規登録への遷移
  Scenario: 新規登録リンクをクリックできる
    When 新規登録リンクをクリックする
    Then 新規登録ページ「/register」に遷移する

  # 管理者ログインへの遷移
  Scenario: 管理者ログインリンクをクリックできる
    When 管理者ログインリンクをクリックする
    Then 管理者ログインページ「/admin/login」に遷移する

  # フルフロー
  Scenario: 新規登録後にログインできる
    Given 新規登録ページから「newuser@example.com」で新規登録を完了している
    And ログインページにリダイレクトされている
    When メールアドレスに「newuser@example.com」と入力する
    And パスワードに「password123」と入力する
    And 「ログイン」ボタンをクリックする
    Then ログインが成功する
    And ホームページにリダイレクトされる

  # エラー後の再試行
  Scenario: エラー後に正しい情報で再試行できる
    Given 無効な認証情報でログインを試みてエラーが表示されている
    When メールアドレスを「test@example.com」に修正する
    And パスワードを「password123」に修正する
    And 「ログイン」ボタンをクリックする
    Then ログインが成功する

  # セキュリティ
  Scenario: パスワードフィールドがマスクされている
    Then パスワード入力欄が「password」タイプである
    And 入力した文字が「●」で表示される

  Scenario: パスワードフィールドのオートコンプリートが設定されている
    Then パスワード入力欄にオートコンプリート属性が設定されている

  # アクセシビリティ
  Scenario: すべての入力欄にラベルが設定されている
    Then メールアドレス入力欄にラベルが設定されている
    And パスワード入力欄にラベルが設定されている
    And ログイン状態保持チェックボックスにラベルが設定されている

  Scenario: キーボード操作でフォームを送信できる
    Given メールアドレスとパスワードを入力している
    When パスワード入力欄でEnterキーを押す
    Then フォームが送信される

  Scenario: Tabキーでフォーカス移動ができる
    When Tabキーを押す
    Then メールアドレス入力欄にフォーカスが移動する
    When Tabキーを押す
    Then パスワード入力欄にフォーカスが移動する
    When Tabキーを押す
    Then ログイン状態保持チェックボックスにフォーカスが移動する

  # レスポンシブデザイン
  Scenario: モバイルで正しく表示される
    Given モバイル画面サイズ（375x667）に設定している
    When ログインページにアクセスする
    Then フォームが縦1列で表示される
    And すべての入力欄が読みやすく表示される

  Scenario: タブレットで正しく表示される
    Given タブレット画面サイズ（768x1024）に設定している
    When ログインページにアクセスする
    Then フォームが適切に表示される

  Scenario: デスクトップで正しく表示される
    Given デスクトップ画面サイズ（1920x1080）に設定している
    When ログインページにアクセスする
    Then フォームが中央に配置されて表示される

  # ログイン後の状態
  Scenario: ログイン成功後にページがリフレッシュされる
    Given ユーザー「test@example.com」がパスワード「password123」で登録されている
    When メールアドレスに「test@example.com」と入力する
    And パスワードに「password123」と入力する
    And 「ログイン」ボタンをクリックする
    Then ログインが成功する
    And ページがリフレッシュされて認証状態が更新される
