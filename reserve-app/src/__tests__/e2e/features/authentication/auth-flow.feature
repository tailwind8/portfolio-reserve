# language: ja

Feature: 認証フロー全体
  ユーザーとして新規登録からログイン、ログアウトまでの一連の流れを実行したい

  Issue: #5, #6

  ユーザーストーリー:
  As a new customer
  I want to complete the full authentication flow
  So that I can access the system and manage my account

  # 新規登録→ログインフロー
  Scenario: 新規登録してすぐにログインできる
    Given ユーザーが新規登録ページにアクセスしている
    When 名前に「田中花子」と入力する
    And メールアドレスに「tanaka-flow@example.com」と入力する
    And パスワードに「securePassword123」と入力する
    And パスワード確認に「securePassword123」と入力する
    And 利用規約に同意する
    And 「アカウントを作成」ボタンをクリックする
    Then ログインページにリダイレクトされる
    When メールアドレスに「tanaka-flow@example.com」と入力する
    And パスワードに「securePassword123」と入力する
    And 「ログイン」ボタンをクリックする
    Then ログインが成功する
    And ホームページにリダイレクトされる

  Scenario: 新規登録→ログイン→マイページアクセス
    Given ユーザーが新規登録を完了している
    And ログインに成功している
    When マイページにアクセスする
    Then マイページが正しく表示される
    And ログインしたユーザーの情報が表示される

  # ログイン状態の確認
  Scenario: ログイン状態が維持される
    Given ユーザーがログインしている
    When 別のページに遷移する
    Then ログイン状態が維持されている
    And ヘッダーにユーザー名が表示されている

  Scenario: ログアウト後は認証が必要なページにアクセスできない
    Given ユーザーがログインしている
    When ログアウトする
    And マイページにアクセスしようとする
    Then ログインページにリダイレクトされる
    And エラーメッセージ「ログインが必要です」が表示される

  # セッション管理
  Scenario: ログイン状態保持をチェックするとセッションが延長される
    Given ユーザーがログイン状態保持をチェックしてログインしている
    When 24時間後にページにアクセスする
    Then ログイン状態が維持されている

  Scenario: ログイン状態保持をチェックしないとセッションが短期間で切れる
    Given ユーザーがログイン状態保持をチェックせずにログインしている
    When 2時間後にページにアクセスする
    Then ログイン状態が切れている
    And ログインページにリダイレクトされる

  # 複数デバイス対応
  Scenario: 複数デバイスで同時にログインできる
    Given ユーザーがデスクトップでログインしている
    When モバイルデバイスで同じアカウントにログインする
    Then 両方のデバイスでログイン状態が維持される

  # ログイン失敗からの回復
  Scenario: ログイン失敗後にパスワードをリセットして再ログインできる
    Given ユーザーがパスワードを忘れている
    When ログインページにアクセスする
    And パスワードリセットリンクをクリックする
    And パスワードリセット手続きを完了する
    And 新しいパスワードでログインする
    Then ログインが成功する

  # アカウント情報の更新後
  Scenario: アカウント情報を更新後もログイン状態が維持される
    Given ユーザーがログインしている
    When マイページでアカウント情報を更新する
    Then ログイン状態が維持される
    And 更新された情報が反映されている

  # セキュリティ
  Scenario: 同じブラウザで別ユーザーにログインすると前のセッションが無効化される
    Given ユーザーA「userA@example.com」でログインしている
    When ログアウトする
    And ユーザーB「userB@example.com」でログインする
    Then ユーザーBのセッションが有効になる
    And ユーザーAのセッションは無効化されている

  Scenario: 複数回ログイン失敗するとアカウントがロックされる
    Given ユーザー「test@example.com」が登録されている
    When 間違ったパスワードで5回ログインを試みる
    Then エラーメッセージ「アカウントがロックされました。しばらくしてから再度お試しください。」が表示される
    And ログインボタンが無効化されている

  Scenario: アカウントロック後、一定時間経過すると再度ログインできる
    Given アカウントがロックされている
    When 30分待つ
    And 正しい認証情報でログインを試みる
    Then ログインが成功する

  # ブラウザ再起動後の挙動
  Scenario: ブラウザ再起動後もログイン状態が維持される（ログイン状態保持ON）
    Given ログイン状態保持をチェックしてログインしている
    When ブラウザを再起動する
    And ページにアクセスする
    Then ログイン状態が維持されている

  Scenario: ブラウザ再起動後はログイン状態が切れる（ログイン状態保持OFF）
    Given ログイン状態保持をチェックせずにログインしている
    When ブラウザを再起動する
    And ページにアクセスする
    Then ログイン状態が切れている
    And ログインページにリダイレクトされる

  # エラーから新規登録へ
  Scenario: ログインエラー時に新規登録リンクから登録できる
    Given ログインページにアクセスしている
    And 存在しないアカウントでログインを試みてエラーが表示されている
    When 新規登録リンクをクリックする
    Then 新規登録ページに遷移する
    When 新規登録を完了する
    Then ログインページにリダイレクトされる
    And 新規登録したアカウントでログインできる

  # ナビゲーション
  Scenario: 認証済みユーザーがログインページにアクセスするとホームにリダイレクトされる
    Given ユーザーがログインしている
    When ログインページにアクセスしようとする
    Then ホームページにリダイレクトされる
    And 情報メッセージ「既にログインしています」が表示される

  Scenario: 認証済みユーザーが新規登録ページにアクセスするとホームにリダイレクトされる
    Given ユーザーがログインしている
    When 新規登録ページにアクセスしようとする
    Then ホームページにリダイレクトされる
    And 情報メッセージ「既にログインしています」が表示される

  # ソーシャルログイン（Phase 2予定）
  # Scenario: Googleアカウントでログインできる
  #   Given ログインページにアクセスしている
  #   When 「Googleでログイン」ボタンをクリックする
  #   Then Google認証ページにリダイレクトされる
  #   And Google認証を完了する
  #   Then ホームページにリダイレクトされる
  #   And ログインが成功する

  # パスワードリセット（Phase 2予定）
  # Scenario: パスワードリセットメールを受信して新しいパスワードを設定できる
  #   Given パスワードリセットページにアクセスしている
  #   When メールアドレスに「test@example.com」と入力する
  #   And 「リセットリンクを送信」ボタンをクリックする
  #   Then 成功メッセージ「パスワードリセットリンクをメールで送信しました」が表示される
  #   And メールを確認する
  #   And リセットリンクをクリックする
  #   Then パスワード変更ページが表示される
  #   When 新しいパスワードを入力する
  #   And パスワードを確認する
  #   And 「パスワードを変更」ボタンをクリックする
  #   Then 成功メッセージ「パスワードが変更されました」が表示される
  #   And ログインページにリダイレクトされる
  #   And 新しいパスワードでログインできる
