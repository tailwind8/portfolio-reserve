# language: ja
機能: ネットワークエラーハンドリング

  アプリケーションでは、ネットワークエラー、タイムアウト、サーバーエラーなど
  さまざまなエラーが発生する可能性がある。
  これらのエラーを適切にハンドリングし、ユーザーに分かりやすいメッセージを表示する必要がある。

  背景:
    前提 ユーザー"田中太郎"が登録されている

  # APIタイムアウトエラー
  シナリオ: APIリクエストがタイムアウトした場合のエラー表示
    前提 ユーザーでログインしている
    かつ 予約一覧ページにアクセスしている
    もし APIリクエストが30秒でタイムアウトする
    ならば エラーメッセージ"リクエストがタイムアウトしました。もう一度お試しください。"が表示される
    かつ 再試行ボタンが表示される

  シナリオ: タイムアウト後の再試行
    前提 ユーザーでログインしている
    かつ 予約一覧ページにアクセスしている
    かつ APIリクエストがタイムアウトした
    もし 再試行ボタンをクリックする
    ならば APIリクエストが再度送信される
    かつ 予約一覧が正常に表示される

  # ネットワーク切断エラー
  シナリオ: ネットワーク切断時のオフライン表示
    前提 ユーザーでログインしている
    かつ マイページにアクセスしている
    もし ネットワーク接続が切断される
    かつ 予約一覧ページに移動しようとする
    ならば エラーメッセージ"インターネット接続が切断されています。接続を確認してください。"が表示される
    かつ オフラインアイコンが表示される

  シナリオ: オフラインからオンラインへの復帰
    前提 ユーザーでログインしている
    かつ ネットワーク接続が切断されている
    かつ オフライン表示がされている
    もし ネットワーク接続が復帰する
    ならば 自動的にページがリロードされる
    かつ 成功メッセージ"接続が復帰しました"が表示される

  # 500 Internal Server Error
  シナリオ: 500エラー発生時の処理
    前提 ユーザーでログインしている
    かつ 予約作成ページにアクセスしている
    もし 予約登録APIが500エラーを返す
    ならば エラーメッセージ"サーバーエラーが発生しました。しばらくしてからもう一度お試しください。"が表示される
    かつ エラー詳細がログに記録される

  シナリオ: 500エラー後の自動再試行
    前提 ユーザーでログインしている
    かつ 予約作成ページにアクセスしている
    もし 予約登録APIが500エラーを返す
    かつ 3秒後に自動的に再試行される
    かつ 再試行が成功する
    ならば 予約が正常に登録される
    かつ 成功メッセージが表示される

  # 503 Service Unavailable
  シナリオ: 503エラー（メンテナンス中）の処理
    前提 ユーザーがログインしようとしている
    もし APIが503エラーを返す
    ならば エラーメッセージ"現在メンテナンス中です。しばらくお待ちください。"が表示される
    かつ メンテナンス画面が表示される

  シナリオ: メンテナンス終了後の自動リダイレクト
    前提 メンテナンス画面が表示されている
    もし メンテナンスが終了する
    かつ APIが正常なレスポンスを返す
    ならば 自動的にログインページにリダイレクトされる
    かつ メッセージ"メンテナンスが終了しました"が表示される

  # 502 Bad Gateway
  シナリオ: 502エラー発生時の処理
    前提 ユーザーでログインしている
    もし APIが502エラーを返す
    ならば エラーメッセージ"サーバーとの通信に失敗しました。時間をおいて再度お試しください。"が表示される
    かつ 再試行ボタンが表示される

  # 504 Gateway Timeout
  シナリオ: 504エラー発生時の処理
    前提 ユーザーでログインしている
    かつ 予約一覧ページにアクセスしている
    もし APIが504エラーを返す
    ならば エラーメッセージ"リクエストの処理に時間がかかっています。しばらくお待ちください。"が表示される
    かつ 再試行ボタンが表示される

  # 400 Bad Request
  シナリオ: 400エラー（不正なリクエスト）の処理
    前提 ユーザーでログインしている
    かつ 予約作成ページにアクセスしている
    もし 不正な形式のデータでAPIリクエストを送る
    ならば ステータスコード "400" が返される
    かつ エラーメッセージ"リクエストが不正です。入力内容を確認してください。"が表示される
    かつ 詳細なバリデーションエラーが表示される

  # 401 Unauthorized
  シナリオ: 401エラー（認証エラー）の処理
    前提 ユーザーでログインしている
    かつ セッションが期限切れになる
    もし 予約一覧APIにリクエストを送る
    ならば ステータスコード "401" が返される
    かつ 自動的にログインページにリダイレクトされる
    かつ メッセージ"セッションが期限切れです。再度ログインしてください。"が表示される

  # 403 Forbidden
  シナリオ: 403エラー（権限エラー）の処理
    前提 ユーザーでログインしている
    もし 管理者専用APIにリクエストを送る
    ならば ステータスコード "403" が返される
    かつ エラーメッセージ"この操作を実行する権限がありません"が表示される
    かつ ホームページへのリンクが表示される

  # 404 Not Found
  シナリオ: 404エラー（リソースが見つからない）の処理
    前提 ユーザーでログインしている
    もし 存在しない予約ID "invalid-id" の詳細ページにアクセスする
    ならば ステータスコード "404" が返される
    かつ エラーメッセージ"指定された予約が見つかりませんでした"が表示される
    かつ 予約一覧ページへのリンクが表示される

  # 409 Conflict
  シナリオ: 409エラー（競合エラー）の処理
    前提 ユーザーでログインしている
    かつ 予約作成ページにアクセスしている
    もし 既に予約されている時間帯で予約を試みる
    ならば ステータスコード "409" が返される
    かつ エラーメッセージ"この時間は既に予約済みです"が表示される
    かつ 他の時間帯を選択できる

  # 429 Too Many Requests（レート制限）
  シナリオ: 429エラー（レート制限超過）の処理
    前提 ユーザーがログインページにアクセスしている
    もし 1分間に10回以上ログインを試みる
    ならば ステータスコード "429" が返される
    かつ エラーメッセージ"リクエストが多すぎます。しばらく時間をおいてから再度お試しください。"が表示される
    かつ 再試行可能になるまでの時間が表示される

  # データベース接続エラー
  シナリオ: データベース接続失敗時のエラー処理
    前提 ユーザーでログインしている
    もし データベース接続に失敗する
    かつ 予約一覧ページにアクセスする
    ならば エラーメッセージ"データの取得に失敗しました。時間をおいて再度お試しください。"が表示される
    かつ エラーログにDB接続エラーが記録される

  # 画像アップロードエラー
  シナリオ: 画像アップロード失敗時のエラー処理
    前提 管理者でログインしている
    かつ メニュー作成ページにアクセスしている
    もし サイズが10MBを超える画像をアップロードする
    ならば エラーメッセージ"画像ファイルのサイズが大きすぎます（上限: 10MB）"が表示される
    かつ 画像はアップロードされない

  シナリオ: ネットワークエラーによる画像アップロード失敗
    前提 管理者でログインしている
    かつ メニュー作成ページにアクセスしている
    もし 画像アップロード中にネットワークエラーが発生する
    ならば エラーメッセージ"画像のアップロードに失敗しました。もう一度お試しください。"が表示される
    かつ 再アップロードボタンが表示される

  # 部分的なデータ取得エラー
  シナリオ: 一部のAPIが失敗してもページは表示される
    前提 管理者でログインしている
    かつ ダッシュボードページにアクセスしている
    もし 統計データAPIが失敗する
    かつ 予約一覧APIは成功する
    ならば ページは表示される
    かつ 統計セクションに"データの取得に失敗しました"というメッセージが表示される
    かつ 予約一覧は正常に表示される

  # エラー後の状態復旧
  シナリオ: エラー後にフォーム入力が保持される
    前提 ユーザーでログインしている
    かつ 予約作成ページにアクセスしている
    かつ フォームに必要事項を入力している
    もし 予約登録中にネットワークエラーが発生する
    ならば エラーメッセージが表示される
    かつ 入力した内容が保持されている
    かつ 再試行時に再入力不要である

  # クライアント側バリデーションとサーバー側エラーの統合
  シナリオ: クライアント側バリデーションを通過してもサーバー側でエラー
    前提 ユーザーでログインしている
    かつ 予約作成ページにアクセスしている
    もし クライアント側バリデーションを通過するデータを入力する
    かつ サーバー側で追加のバリデーションエラーが発生する
    ならば サーバー側のエラーメッセージが表示される
    かつ エラー箇所がハイライトされる
