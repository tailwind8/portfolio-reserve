# language: ja
機能: Sentryエラー監視

  アプリケーションでは、本番環境で発生したエラーを適切に監視・追跡する必要がある。
  Sentryを導入することで、エラーの発生状況、スタックトレース、ユーザーコンテキストを収集し、
  迅速な問題解決を可能にする。

  背景:
    前提 アプリケーションが起動している

  # Sentry初期化
  シナリオ: Sentryが正しく初期化される
    前提 環境変数"NEXT_PUBLIC_SENTRY_DSN"が設定されている
    もし アプリケーションが起動する
    ならば Sentryクライアントが初期化される
    かつ エラーハンドラーが設定される

  シナリオ: 本番環境でSentryが有効化される
    前提 環境変数"NODE_ENV"が"production"である
    かつ 環境変数"NEXT_PUBLIC_SENTRY_DSN"が設定されている
    もし アプリケーションが起動する
    ならば Sentryが有効化される

  シナリオ: 開発環境でもSentryが初期化される
    前提 環境変数"NODE_ENV"が"development"である
    もし アプリケーションが起動する
    ならば Sentryが初期化される
    かつ デバッグモードが有効化される

  # エラーキャプチャ
  シナリオ: クライアントサイドエラーがSentryに送信される
    前提 ユーザーがログインしている
    かつ 予約一覧ページにアクセスしている
    もし JavaScriptエラーが発生する
    ならば Sentryにエラーが送信される
    かつ エラーメッセージが記録される
    かつ スタックトレースが記録される

  シナリオ: サーバーサイドエラーがSentryに送信される
    前提 ユーザーがログインしている
    もし API "/api/reservations" で500エラーが発生する
    ならば Sentryにサーバーエラーが送信される
    かつ エラー詳細が記録される
    かつ リクエスト情報が記録される

  シナリオ: 未処理のPromise拒否がSentryに送信される
    前提 ユーザーが予約作成ページにアクセスしている
    もし 非同期処理でunhandled rejectionが発生する
    ならば Sentryにエラーが送信される
    かつ エラータイプが"UnhandledRejection"である

  # ユーザーコンテキスト
  シナリオ: ログイン済みユーザーのコンテキストがSentryに記録される
    前提 ユーザー"田中太郎" (user-123) がログインしている
    かつ 予約一覧ページにアクセスしている
    もし JavaScriptエラーが発生する
    ならば Sentryにユーザー情報が送信される
    かつ ユーザーID "user-123" が記録される
    かつ ユーザーメール "tanaka@example.com" が記録される

  シナリオ: 未ログインユーザーのエラーも記録される
    前提 ユーザーがログインしていない
    かつ ホームページにアクセスしている
    もし JavaScriptエラーが発生する
    ならば Sentryにエラーが送信される
    かつ ユーザーコンテキストが"anonymous"である

  # パフォーマンストレース
  シナリオ: ページロードのパフォーマンスが記録される
    前提 Sentryパフォーマンス監視が有効化されている
    もし ユーザーがホームページにアクセスする
    ならば ページロードトレースがSentryに送信される
    かつ ロード時間が記録される

  シナリオ: APIリクエストのパフォーマンスが記録される
    前提 ユーザーがログインしている
    かつ Sentryパフォーマンス監視が有効化されている
    もし 予約一覧APIを呼び出す
    ならば APIリクエストトレースがSentryに送信される
    かつ レスポンス時間が記録される

  # エラーフィルタリング
  シナリオ: 本番環境でセンシティブ情報がマスクされる
    前提 環境変数"NODE_ENV"が"production"である
    かつ ユーザーがログインしている
    もし エラーに個人情報が含まれる
    ならば Sentryに送信される前に個人情報がマスクされる
    かつ パスワードフィールドが除外される
    かつ クレジットカード番号が除外される

  シナリオ: 期待されるエラーはSentryに送信されない
    前提 ユーザーがログインしている
    もし バリデーションエラーが発生する
    ならば Sentryにエラーが送信されない
    かつ ユーザーにエラーメッセージが表示される

  # エラーレベル
  シナリオ: 重大なエラーは"error"レベルで記録される
    前提 ユーザーが予約作成ページにアクセスしている
    もし データベース接続エラーが発生する
    ならば Sentryにエラーレベル"error"で送信される

  シナリオ: 警告は"warning"レベルで記録される
    前提 ユーザーがログインしている
    もし 非推奨APIが呼び出される
    ならば Sentryに警告レベル"warning"で送信される

  # エラーグルーピング
  シナリオ: 同じエラーが適切にグルーピングされる
    前提 複数のユーザーが同じエラーに遭遇する
    もし 同じスタックトレースのエラーが3回発生する
    ならば Sentry上で1つのIssueにグルーピングされる
    かつ 発生回数が3回と記録される

  # 環境別設定
  シナリオ: 本番環境とステージング環境が区別される
    前提 環境変数"NEXT_PUBLIC_ENVIRONMENT"が"production"である
    もし エラーが発生する
    ならば Sentryに環境タグ"production"が付与される

  # リリース追跡
  シナリオ: リリースバージョンがエラーに紐付けられる
    前提 環境変数"NEXT_PUBLIC_SENTRY_RELEASE"が"v1.2.3"である
    もし エラーが発生する
    ならば Sentryにリリースバージョン"v1.2.3"が記録される

  # ソースマップ
  シナリオ: 本番環境でソースマップが正しく適用される
    前提 環境変数"NODE_ENV"が"production"である
    かつ ビルド時にソースマップがアップロードされている
    もし minifyされたコードでエラーが発生する
    ならば Sentryに元のソースコード行が表示される
    かつ 変数名が復元される

  # エラー通知
  シナリオ: 重大なエラー発生時にアラートが送信される
    前提 Sentryアラート設定がされている
    もし 5分間に10回以上同じエラーが発生する
    ならば 開発チームにアラートが送信される

  # 統合テスト
  シナリオ: Supabase認証エラーがSentryに記録される
    前提 ユーザーがログインページにアクセスしている
    もし Supabase認証APIがエラーを返す
    ならば Sentryにエラーが送信される
    かつ エラータグに"supabase-auth"が付与される

  シナリオ: PrismaデータベースエラーがSentryに記録される
    前提 管理者がダッシュボードにアクセスしている
    もし Prismaクエリがエラーを返す
    ならば Sentryにエラーが送信される
    かつ エラータグに"prisma-database"が付与される
