# language: ja
機能: 予約ステータス遷移の制御

  予約システムでは、予約のステータスが不正に変更されることを防ぐ必要がある。
  許可された状態遷移のみを許可し、不正な遷移を防止する。

  正常な状態遷移:
    PENDING → CONFIRMED → COMPLETED
    CONFIRMED → CANCELLED
    CONFIRMED → NO_SHOW

  不正な状態遷移（防止すべき）:
    COMPLETED → PENDING
    COMPLETED → CONFIRMED
    CANCELLED → CONFIRMED
    CANCELLED → COMPLETED
    NO_SHOW → COMPLETED
    NO_SHOW → CONFIRMED

  背景:
    前提 管理者でログインしている
    かつ ユーザー"田中太郎"が登録されている
    かつ メニュー"カット（60分）"が存在する

  # 正常な状態遷移
  シナリオ: PENDING から CONFIRMED への遷移（正常）
    前提 ステータスが"PENDING"の予約が存在する
    もし 管理者が予約ステータスを"CONFIRMED"に変更する
    ならば 予約ステータスが"CONFIRMED"に更新される
    かつ 成功メッセージ"予約を確定しました"が表示される

  シナリオ: CONFIRMED から COMPLETED への遷移（正常）
    前提 ステータスが"CONFIRMED"の予約が存在する
    もし 管理者が予約ステータスを"COMPLETED"に変更する
    ならば 予約ステータスが"COMPLETED"に更新される
    かつ 成功メッセージ"予約を完了しました"が表示される

  シナリオ: CONFIRMED から CANCELLED への遷移（正常）
    前提 ステータスが"CONFIRMED"の予約が存在する
    もし 管理者が予約ステータスを"CANCELLED"に変更する
    ならば 予約ステータスが"CANCELLED"に更新される
    かつ 成功メッセージ"予約をキャンセルしました"が表示される

  シナリオ: CONFIRMED から NO_SHOW への遷移（正常）
    前提 ステータスが"CONFIRMED"の予約が存在する
    もし 管理者が予約ステータスを"NO_SHOW"に変更する
    ならば 予約ステータスが"NO_SHOW"に更新される
    かつ 成功メッセージ"無断キャンセルとして記録しました"が表示される

  # 不正な状態遷移の防止
  シナリオ: COMPLETED から PENDING への遷移を防止
    前提 ステータスが"COMPLETED"の予約が存在する
    もし 管理者が予約ステータスを"PENDING"に変更しようとする
    ならば エラーメッセージ"完了済みの予約は保留状態に戻せません"が表示される
    かつ 予約ステータスは"COMPLETED"のまま変更されない

  シナリオ: COMPLETED から CONFIRMED への遷移を防止
    前提 ステータスが"COMPLETED"の予約が存在する
    もし 管理者が予約ステータスを"CONFIRMED"に変更しようとする
    ならば エラーメッセージ"完了済みの予約は確定状態に戻せません"が表示される
    かつ 予約ステータスは"COMPLETED"のまま変更されない

  シナリオ: COMPLETED から CANCELLED への遷移を防止
    前提 ステータスが"COMPLETED"の予約が存在する
    もし 管理者が予約ステータスを"CANCELLED"に変更しようとする
    ならば エラーメッセージ"完了済みの予約はキャンセルできません"が表示される
    かつ 予約ステータスは"COMPLETED"のまま変更されない

  シナリオ: CANCELLED から PENDING への遷移を防止
    前提 ステータスが"CANCELLED"の予約が存在する
    もし 管理者が予約ステータスを"PENDING"に変更しようとする
    ならば エラーメッセージ"キャンセル済みの予約は保留状態に戻せません"が表示される
    かつ 予約ステータスは"CANCELLED"のまま変更されない

  シナリオ: CANCELLED から CONFIRMED への遷移を防止
    前提 ステータスが"CANCELLED"の予約が存在する
    もし 管理者が予約ステータスを"CONFIRMED"に変更しようとする
    ならば エラーメッセージ"キャンセル済みの予約は確定状態に戻せません"が表示される
    かつ 予約ステータスは"CANCELLED"のまま変更されない

  シナリオ: CANCELLED から COMPLETED への遷移を防止
    前提 ステータスが"CANCELLED"の予約が存在する
    もし 管理者が予約ステータスを"COMPLETED"に変更しようとする
    ならば エラーメッセージ"キャンセル済みの予約は完了状態にできません"が表示される
    かつ 予約ステータスは"CANCELLED"のまま変更されない

  シナリオ: NO_SHOW から PENDING への遷移を防止
    前提 ステータスが"NO_SHOW"の予約が存在する
    もし 管理者が予約ステータスを"PENDING"に変更しようとする
    ならば エラーメッセージ"無断キャンセルの予約は保留状態に戻せません"が表示される
    かつ 予約ステータスは"NO_SHOW"のまま変更されない

  シナリオ: NO_SHOW から CONFIRMED への遷移を防止
    前提 ステータスが"NO_SHOW"の予約が存在する
    もし 管理者が予約ステータスを"CONFIRMED"に変更しようとする
    ならば エラーメッセージ"無断キャンセルの予約は確定状態に戻せません"が表示される
    かつ 予約ステータスは"NO_SHOW"のまま変更されない

  シナリオ: NO_SHOW から COMPLETED への遷移を防止
    前提 ステータスが"NO_SHOW"の予約が存在する
    もし 管理者が予約ステータスを"COMPLETED"に変更しようとする
    ならば エラーメッセージ"無断キャンセルの予約は完了状態にできません"が表示される
    かつ 予約ステータスは"NO_SHOW"のまま変更されない

  # APIレベルでの防止
  シナリオ: APIで不正な状態遷移を試みた場合の防止
    前提 ステータスが"COMPLETED"の予約（ID: "reservation-123"）が存在する
    もし "/api/reservations/reservation-123" にステータス"PENDING"のPATCHリクエストを送る
    ならば ステータスコード "400" が返される
    かつ エラーメッセージ"不正な状態遷移です"が返される

  # 一般ユーザーによるステータス変更の防止
  シナリオ: 一般ユーザーは予約ステータスを変更できない
    前提 ユーザー"田中太郎"でログインしている
    かつ 自分のステータスが"CONFIRMED"の予約が存在する
    もし ユーザーが予約ステータスを"COMPLETED"に変更しようとする
    ならば エラーメッセージ"この操作を実行する権限がありません"が表示される
    かつ 予約ステータスは"CONFIRMED"のまま変更されない

  # ステータスに応じた編集制限
  シナリオ: COMPLETED ステータスの予約は編集できない
    前提 ステータスが"COMPLETED"の予約が存在する
    もし 管理者が予約の日時を変更しようとする
    ならば エラーメッセージ"完了済みの予約は編集できません"が表示される
    かつ 予約内容は変更されない

  シナリオ: CANCELLED ステータスの予約は編集できない
    前提 ステータスが"CANCELLED"の予約が存在する
    もし 管理者が予約の日時を変更しようとする
    ならば エラーメッセージ"キャンセル済みの予約は編集できません"が表示される
    かつ 予約内容は変更されない

  シナリオ: NO_SHOW ステータスの予約は編集できない
    前提 ステータスが"NO_SHOW"の予約が存在する
    もし 管理者が予約の日時を変更しようとする
    ならば エラーメッセージ"無断キャンセルの予約は編集できません"が表示される
    かつ 予約内容は変更されない

  # 削除制限
  シナリオ: COMPLETED ステータスの予約は削除できない
    前提 ステータスが"COMPLETED"の予約が存在する
    もし 管理者が予約を削除しようとする
    ならば エラーメッセージ"完了済みの予約は削除できません"が表示される
    かつ 予約は削除されない

  シナリオ: PENDING と CONFIRMED ステータスの予約は削除できる（キャンセルに変更）
    前提 ステータスが"CONFIRMED"の予約が存在する
    もし 管理者が予約を削除しようとする
    ならば 予約ステータスが"CANCELLED"に変更される
    かつ 成功メッセージ"予約をキャンセルしました"が表示される
