# language: ja
機能: 予約の並行処理と重複防止

  予約システムでは、複数のユーザーが同時に同じ時間帯を予約しようとする場合や、
  所要時間が重複する予約を防ぐ必要がある。
  また、スタッフのダブルブッキングも防止しなければならない。

  背景:
    前提 ユーザー"田中太郎"がログインしている
    かつ メニュー"カット（60分）"が存在する
    かつ スタッフ"佐藤花子"が存在する
    かつ "2025年1月20日"は営業日である

  シナリオ: 同時リクエストによる重複予約防止（Race Condition）
    前提 ユーザー"鈴木次郎"も同時にログインしている
    かつ "2025年1月20日 14:00-15:00"の時間帯が空いている
    もし ユーザー"田中太郎"とユーザー"鈴木次郎"が同時に"2025年1月20日 14:00"を予約しようとする
    ならば 片方の予約のみが成功する
    かつ もう片方にはエラーメッセージ"この時間は既に予約済みです"が表示される
    かつ データベースには1件の予約のみが保存されている

  シナリオ: 所要時間が重複する予約の防止
    前提 "2025年1月20日 14:00-15:00"にメニュー"カット（60分）"の予約が存在する
    もし メニュー"カット（60分）"を選択する
    かつ 予約日時として"2025年1月20日 14:30"を選択する
    かつ 「予約する」ボタンをクリックする
    ならば エラーメッセージ"予約時間が重複しています"が表示される
    かつ 予約が登録されない

  シナリオ: 所要時間が重複する予約の防止（後ろの予約が先行予約に重複）
    前提 "2025年1月20日 14:00-15:00"にメニュー"カット（60分）"の予約が存在する
    もし メニュー"カット（60分）"を選択する
    かつ 予約日時として"2025年1月20日 13:30"を選択する
    かつ 「予約する」ボタンをクリックする
    ならば エラーメッセージ"予約時間が重複しています"が表示される
    かつ 予約が登録されない

  シナリオ: 所要時間が重複しない予約は成功する
    前提 "2025年1月20日 14:00-15:00"にメニュー"カット（60分）"の予約が存在する
    もし メニュー"カット（60分）"を選択する
    かつ 予約日時として"2025年1月20日 15:00"を選択する
    かつ 「予約する」ボタンをクリックする
    ならば 予約完了ページが表示される
    かつ 予約詳細に"2025年1月20日 15:00"と表示される

  シナリオ: スタッフのダブルブッキング防止
    前提 "2025年1月20日 14:00-15:00"にスタッフ"佐藤花子"の予約が存在する
    もし メニュー"カット（60分）"を選択する
    かつ スタッフ"佐藤花子"を選択する
    かつ 予約日時として"2025年1月20日 14:30"を選択する
    かつ 「予約する」ボタンをクリックする
    ならば エラーメッセージ"選択されたスタッフは指定時間帯に対応できません"が表示される
    かつ 予約が登録されない

  シナリオ: スタッフのダブルブッキング防止（複数スタッフが存在する場合）
    前提 スタッフ"山田太郎"が存在する
    かつ "2025年1月20日 14:00-15:00"にスタッフ"佐藤花子"の予約が存在する
    もし メニュー"カット（60分）"を選択する
    かつ スタッフ"山田太郎"を選択する
    かつ 予約日時として"2025年1月20日 14:30"を選択する
    かつ 「予約する」ボタンをクリックする
    ならば 予約完了ページが表示される
    かつ 予約詳細にスタッフ"山田太郎"が表示される

  シナリオ: 同一ユーザーによる重複時間帯予約の防止
    前提 "2025年1月20日 14:00-15:00"に自分の予約が存在する
    もし メニュー"カット（60分）"を選択する
    かつ 予約日時として"2025年1月20日 14:30"を選択する
    かつ 「予約する」ボタンをクリックする
    ならば エラーメッセージ"既にこの時間帯に予約があります"が表示される
    かつ 予約が登録されない

  シナリオ: 複数スタッフがいる場合の並行予約（成功ケース）
    前提 スタッフ"山田太郎"が存在する
    かつ スタッフ"佐藤花子"が存在する
    かつ ユーザー"鈴木次郎"も同時にログインしている
    かつ "2025年1月20日 14:00"の時間帯が空いている
    もし ユーザー"田中太郎"がスタッフ"佐藤花子"で"2025年1月20日 14:00"を予約する
    かつ 同時にユーザー"鈴木次郎"がスタッフ"山田太郎"で"2025年1月20日 14:00"を予約する
    ならば 両方の予約が成功する
    かつ データベースには2件の予約が保存されている
