# language: ja
Feature: リマインダーメール自動送信
  As a customer
  I want to receive a reminder email
  So that I don't forget my reservation

  Background:
    Given 予約システムが稼働している

  Scenario: 前日リマインダーメール自動送信（ハッピーパス）
    Given 予約が"2025年1月21日 14:00"に存在する
    And 現在の日時が"2025年1月20日 10:00"である
    When リマインダーメール送信ジョブが実行される
    Then リマインダーメールが"test@example.com"に送信される
    And メールに予約日時"2025年1月21日 14:00"が含まれる
    And メールにメニュー名が含まれる
    And メールにスタッフ名が含まれる
    And メールに店舗情報が含まれる

  Scenario: 当日リマインダーメール自動送信
    Given 予約が"2025年1月21日 14:00"に存在する
    And 現在の日時が"2025年1月21日 09:00"である
    When リマインダーメール送信ジョブが実行される
    Then リマインダーメールが送信される
    And メールに"本日14:00の予約です"というテキストが含まれる

  Scenario: リマインダーメール送信スキップ（予約がキャンセル済み）
    Given 予約が"2025年1月21日 14:00"に存在する
    And 予約のステータスが"キャンセル済み"である
    And 現在の日時が"2025年1月20日 10:00"である
    When リマインダーメール送信ジョブが実行される
    Then リマインダーメールは送信されない

  Scenario: リマインダーメール送信スキップ（既に来店済み）
    Given 予約が"2025年1月21日 14:00"に存在する
    And 予約のステータスが"来店済み"である
    And 現在の日時が"2025年1月20日 10:00"である
    When リマインダーメール送信ジョブが実行される
    Then リマインダーメールは送信されない

  Scenario: リマインダーメール送信スキップ（送信済み）
    Given 予約が"2025年1月21日 14:00"に存在する
    And 前日リマインダーメールが既に送信されている
    And 現在の日時が"2025年1月20日 11:00"である
    When リマインダーメール送信ジョブが実行される
    Then リマインダーメールは再送信されない

  Scenario: リマインダーメール送信失敗時の処理
    Given 予約が"2025年1月21日 14:00"に存在する
    And 現在の日時が"2025年1月20日 10:00"である
    And メール送信サービスが利用できない
    When リマインダーメール送信ジョブが実行される
    Then リマインダーメール送信が失敗する
    And エラーログが記録される
    And 次回のジョブ実行時に再送信が試みられる

  Scenario: 複数予約のリマインダーメール送信
    Given 予約が"2025年1月21日 14:00"に存在する
    And 予約が"2025年1月22日 15:00"に存在する
    And 現在の日時が"2025年1月20日 10:00"である
    When リマインダーメール送信ジョブが実行される
    Then "2025年1月21日 14:00"の予約にリマインダーメールが送信される
    And "2025年1月22日 15:00"の予約にはリマインダーメールが送信されない

  Scenario: リマインダーメールの内容確認
    Given 予約が"2025年1月21日 14:00"に存在する
    And 予約のメニューが"カット"である
    And 予約のスタッフが"田中"である
    And 現在の日時が"2025年1月20日 10:00"である
    When リマインダーメール送信ジョブが実行される
    Then リマインダーメールが送信される
    And メールに予約日時"2025年1月21日 14:00"が含まれる
    And メールにメニュー名"カット"が含まれる
    And メールにスタッフ名"田中"が含まれる
    And メールに店舗名が含まれる
    And メールに店舗住所が含まれる
    And メールに店舗電話番号が含まれる
    And メールに"予約の変更・キャンセルはこちら"リンクが含まれる

  Scenario: リマインダーメール送信時刻の確認
    Given 予約が"2025年1月21日 14:00"に存在する
    And 現在の日時が"2025年1月20日 09:59"である
    When リマインダーメール送信ジョブが実行される
    Then リマインダーメールは送信されない
    When 現在の日時が"2025年1月20日 10:00"になる
    And リマインダーメール送信ジョブが実行される
    Then リマインダーメールが送信される

  Scenario: リマインダーメール送信履歴の記録
    Given 予約が"2025年1月21日 14:00"に存在する
    And 現在の日時が"2025年1月20日 10:00"である
    When リマインダーメール送信ジョブが実行される
    Then リマインダーメールが送信される
    And 送信履歴が記録される
    And 送信日時が記録される
    And 送信ステータスが"成功"として記録される

