# language: ja
Feature: 予約キャンセル
  As a customer
  I want to cancel my reservation
  So that I can free up the time slot

  Background:
    Given ユーザーがログインしている
    And マイページにアクセスしている
    And 予約が1件以上存在する

  Scenario: 予約キャンセル成功（ハッピーパス）
    Given 予約を選択している
    When "キャンセル"ボタンをクリックする
    Then "予約をキャンセルしますか？"という確認ダイアログが表示される
    And 予約日時が表示される
    And メニュー名が表示される
    And "この操作は取り消せません"という警告が表示される
    When 確認ダイアログで"はい"を選択する
    Then 予約がキャンセル済みに更新される
    And キャンセル確認メッセージが表示される
    And キャンセル確認メールが送信される
    And マイページに予約一覧が更新されて表示される

  Scenario: キャンセル確認ダイアログ表示
    Given 予約を選択している
    When "キャンセル"ボタンをクリックする
    Then "予約をキャンセルしますか？"という確認ダイアログが表示される
    And 予約日時が表示される
    And メニュー名が表示される
    And 担当者名が表示される
    And 料金が表示される
    And 所要時間が表示される
    And "戻る"ボタンが表示される
    And "キャンセルする"ボタンが表示される

  Scenario: キャンセル取り消し
    Given 予約を選択している
    When "キャンセル"ボタンをクリックする
    Then 確認ダイアログが表示される
    When "戻る"ボタンをクリックする
    Then 確認ダイアログが閉じる
    And 予約はキャンセルされない
    And 予約のステータスは変更されない

  Scenario: キャンセル期限超過時のエラー
    Given 予約を選択している
    And 予約のキャンセル期限が過ぎている
    When "キャンセル"ボタンをクリックしようとする
    Then "キャンセル"ボタンが無効化されている
    And エラーメッセージ"予約のキャンセル期限が過ぎています"が表示される

  Scenario: 既に来店済み予約のキャンセル不可
    Given 予約を選択している
    And 予約のステータスが"来店済み"である
    When "キャンセル"ボタンをクリックしようとする
    Then "キャンセル"ボタンが無効化されている
    And エラーメッセージ"既に来店済みの予約はキャンセルできません"が表示される

  Scenario: 既にキャンセル済み予約のキャンセル不可
    Given 予約を選択している
    And 予約のステータスが"キャンセル済み"である
    When "キャンセル"ボタンをクリックしようとする
    Then "キャンセル"ボタンが無効化されている
    And エラーメッセージ"既にキャンセル済みの予約です"が表示される

  Scenario: キャンセル確認メール送信
    Given 予約を選択している
    When "キャンセル"ボタンをクリックする
    Then 確認ダイアログが表示される
    When 確認ダイアログで"はい"を選択する
    Then キャンセル確認メールが送信される
    And メールにキャンセルした予約の日時が含まれる
    And メールにキャンセルした予約のメニュー名が含まれる
    And メールにキャンセルした予約のスタッフ名が含まれる
    And メールにキャンセル日時が含まれる

  Scenario: キャンセル後の予約一覧表示
    Given 予約を選択している
    When "キャンセル"ボタンをクリックする
    Then 確認ダイアログが表示される
    When 確認ダイアログで"はい"を選択する
    Then 予約がキャンセル済みに更新される
    And マイページの予約一覧から該当予約が"キャンセル"タブに移動する
    When "キャンセル"タブをクリックする
    Then キャンセル済みの予約が表示される

  Scenario: キャンセル後の時間帯が利用可能になる
    Given 予約を選択している
    And 予約の日時が"2025年1月20日 14:00"である
    When "キャンセル"ボタンをクリックする
    Then 確認ダイアログが表示される
    When 確認ダイアログで"はい"を選択する
    Then 予約がキャンセル済みに更新される
    When 予約ページにアクセスする
    And 日付"20日"を選択する
    Then 時間帯"14:00"が利用可能として表示される

  Scenario: キャンセル確認ダイアログの詳細表示
    Given 予約を選択している
    And 予約の日時が"2025年1月20日 14:00"である
    And 予約のメニューが"カット"である
    And 予約のスタッフが"田中"である
    And 予約の料金が"5000円"である
    When "キャンセル"ボタンをクリックする
    Then 確認ダイアログに"2025年1月20日 14:00"が表示される
    And 確認ダイアログに"カット"が表示される
    And 確認ダイアログに"田中"が表示される
    And 確認ダイアログに"5000円"が表示される

  Scenario: 複数予約の個別キャンセル
    Given 予約が複数件存在する
    When 最初の予約を選択する
    And "キャンセル"ボタンをクリックする
    Then 確認ダイアログが表示される
    When 確認ダイアログで"はい"を選択する
    Then 最初の予約のみがキャンセルされる
    And 他の予約は影響を受けない

