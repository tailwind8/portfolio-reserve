# language: ja
Feature: 予約確認メール送信
  As a customer
  I want to receive a confirmation email
  So that I have a record of my reservation

  Background:
    Given ユーザーがログインしている
    And 予約ページにアクセスしている

  Scenario: 予約確定時にメール送信成功（ハッピーパス）
    When メニューを選択する
    And スタッフを選択する
    And 未来の日付"15日"を選択する
    And 1秒待つ
    And 利用可能な時間帯を選択する
    And "予約を確定する"ボタンをクリックする
    Then 予約が登録される
    And 予約完了画面が表示される
    And 確認メールが"test@example.com"に送信される
    And メール送信成功メッセージが表示される

  Scenario: メール内容に予約詳細が含まれる
    When メニュー"カット"を選択する
    And スタッフ"田中"を選択する
    And 未来の日付"2025年1月20日"を選択する
    And 1秒待つ
    And 時間帯"14:00"を選択する
    And "予約を確定する"ボタンをクリックする
    Then 確認メールが送信される
    And メールに予約日時"2025年1月20日 14:00"が含まれる
    And メールにメニュー名"カット"が含まれる
    And メールにスタッフ名"田中"が含まれる
    And メールに料金が含まれる
    And メールに予約IDが含まれる

  Scenario: メール送信失敗時のエラーハンドリング
    Given メール送信サービスが利用できない
    When メニューを選択する
    And スタッフを選択する
    And 未来の日付"15日"を選択する
    And 1秒待つ
    And 利用可能な時間帯を選択する
    And "予約を確定する"ボタンをクリックする
    Then 予約は登録される
    And 予約完了画面が表示される
    And 警告メッセージ"メール送信に失敗しましたが、予約は正常に登録されました"が表示される

  Scenario: メールアドレス不正時の処理
    Given ユーザーのメールアドレスが不正である
    When メニューを選択する
    And スタッフを選択する
    And 未来の日付"15日"を選択する
    And 1秒待つ
    And 利用可能な時間帯を選択する
    And "予約を確定する"ボタンをクリックする
    Then 予約は登録される
    And 予約完了画面が表示される
    And 警告メッセージ"メールアドレスが無効なため、確認メールを送信できませんでした"が表示される

  Scenario: メール送信遅延時の処理
    Given メール送信サービスが遅延している
    When メニューを選択する
    And スタッフを選択する
    And 未来の日付"15日"を選択する
    And 1秒待つ
    And 利用可能な時間帯を選択する
    And "予約を確定する"ボタンをクリックする
    Then 予約が登録される
    And 予約完了画面が表示される
    And "確認メールを送信中です..."というメッセージが表示される
    When メール送信が完了する
    Then "確認メールを送信しました"というメッセージが表示される

  Scenario: 予約確定後のメール再送信
    Given 予約が確定されている
    And 確認メールが送信されている
    When マイページから"メールを再送信"ボタンをクリックする
    Then 確認メールが再送信される
    And "メールを再送信しました"というメッセージが表示される

