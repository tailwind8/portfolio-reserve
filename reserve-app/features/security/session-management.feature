# language: ja
機能: セッション管理

  アプリケーションでは、ログアウト後の不正アクセスを防ぎ、
  セッションタイムアウトやセッションハイジャックから保護し、
  他のユーザーのデータへの横断アクセスを防止する必要がある。

  背景:
    前提 ユーザー"田中太郎"が登録されている
    かつ 管理者"admin@example.com"が登録されている

  シナリオ: ログアウト後の管理画面アクセス防止
    前提 管理者でログインしている
    かつ 管理者ダッシュボードページ "/admin/dashboard" にアクセスする
    かつ ダッシュボードが表示されている
    もし ログアウトする
    かつ 直接URL "/admin/dashboard" にアクセスする
    ならば ログインページ "/admin/login" にリダイレクトされる
    かつ エラーメッセージ"ログインが必要です"が表示される

  シナリオ: ログアウト後のAPIアクセス防止
    前提 ユーザーでログインしている
    かつ 認証トークンを保持している
    もし ログアウトする
    かつ 保持していたトークンで "/api/reservations" にGETリクエストを送る
    ならば ステータスコード "401" が返される
    かつ エラーメッセージ"認証が必要です"が返される

  シナリオ: セッションタイムアウト後の自動ログアウト（30分）
    前提 ユーザーでログインしている
    かつ マイページにアクセスしている
    もし 30分間操作しない
    かつ 予約ページにアクセスしようとする
    ならば ログインページにリダイレクトされる
    かつ メッセージ"セッションがタイムアウトしました。再度ログインしてください。"が表示される

  シナリオ: 他のユーザーの予約への横断アクセス防止（表示）
    前提 ユーザー"田中太郎"がログインしている
    かつ ユーザー"鈴木次郎"の予約（ID: "reservation-123"）が存在する
    もし 直接URL "/api/reservations/reservation-123" にGETリクエストを送る
    ならば ステータスコード "403" が返される
    かつ エラーメッセージ"この予約にアクセスする権限がありません"が返される

  シナリオ: 他のユーザーの予約への横断アクセス防止（更新）
    前提 ユーザー"田中太郎"がログインしている
    かつ ユーザー"鈴木次郎"の予約（ID: "reservation-123"）が存在する
    もし "/api/reservations/reservation-123" に更新データをPATCHリクエストで送る
    ならば ステータスコード "403" が返される
    かつ エラーメッセージ"この予約を編集する権限がありません"が返される

  シナリオ: 他のユーザーの予約への横断アクセス防止（削除）
    前提 ユーザー"田中太郎"がログインしている
    かつ ユーザー"鈴木次郎"の予約（ID: "reservation-123"）が存在する
    もし "/api/reservations/reservation-123" にDELETEリクエストを送る
    ならば ステータスコード "403" が返される
    かつ エラーメッセージ"この予約を削除する権限がありません"が返される

  シナリオ: 管理者は全ての予約にアクセスできる
    前提 管理者でログインしている
    かつ ユーザー"田中太郎"の予約（ID: "reservation-123"）が存在する
    もし "/api/reservations/reservation-123" にGETリクエストを送る
    ならば ステータスコード "200" が返される
    かつ 予約詳細が正しく返される

  シナリオ: 一般ユーザーでの管理者APIアクセス防止
    前提 ユーザー"田中太郎"がログインしている
    もし "/api/admin/dashboard" にGETリクエストを送る
    ならば ステータスコード "403" が返される
    かつ エラーメッセージ"管理者権限が必要です"が返される

  シナリオ: 未ログイン状態での保護されたページアクセス防止
    前提 ログインしていない
    もし 直接URL "/mypage" にアクセスする
    ならば ログインページ "/login" にリダイレクトされる
    かつ メッセージ"ログインが必要です"が表示される

  シナリオ: セッション固定攻撃の防止
    前提 ログインしていない
    かつ セッションID "old-session-id" を持っている
    もし 有効な認証情報でログインする
    ならば 新しいセッションID "new-session-id" が発行される
    かつ 古いセッションID "old-session-id" は無効になる

  シナリオ: 同時ログイン時のセッション管理
    前提 ユーザー"田中太郎"がブラウザAでログインしている
    もし 同じユーザー"田中太郎"がブラウザBでログインする
    ならば ブラウザAのセッションは無効になる
    かつ ブラウザBのセッションは有効である
    かつ ブラウザAで保護されたページにアクセスすると再ログインが要求される

  シナリオ: リフレッシュトークンの有効期限チェック
    前提 ユーザーでログインしている
    かつ リフレッシュトークンが発行されている
    もし リフレッシュトークンの有効期限が切れる
    かつ リフレッシュトークンを使ってアクセストークンを更新しようとする
    ならば ステータスコード "401" が返される
    かつ エラーメッセージ"リフレッシュトークンの有効期限が切れています"が返される
    かつ 再ログインが要求される

  シナリオ: CSRF トークン検証
    前提 ユーザーでログインしている
    もし CSRFトークンなしでPOSTリクエストを "/api/reservations" に送る
    ならば ステータスコード "403" が返される
    かつ エラーメッセージ"CSRF トークンが無効です"が返される

  シナリオ: 不正なCSRFトークンでのリクエスト拒否
    前提 ユーザーでログインしている
    もし 不正なCSRFトークンでPOSTリクエストを "/api/reservations" に送る
    ならば ステータスコード "403" が返される
    かつ エラーメッセージ"CSRF トークンが無効です"が返される
