# language: ja
機能: XSS・CSRF攻撃防止

  アプリケーションでは、XSS（クロスサイトスクリプティング）攻撃と
  CSRF（クロスサイトリクエストフォージェリ）攻撃から保護する必要がある。

  背景:
    前提 ユーザー"田中太郎"が登録されている

  # XSS攻撃防止（スクリプトタグ）
  シナリオ: 備考欄にスクリプトタグを入力してもエスケープされる
    前提 ユーザーでログインしている
    かつ 予約作成ページにアクセスしている
    もし 備考に"<script>alert('XSS')</script>"を入力する
    かつ 「予約する」ボタンをクリックする
    ならば 予約が正常に登録される
    かつ 予約詳細ページで備考が"&lt;script&gt;alert('XSS')&lt;/script&gt;"とエスケープされて表示される
    かつ スクリプトが実行されない

  シナリオ: メニュー説明にスクリプトタグを入力してもエスケープされる
    前提 管理者でログインしている
    かつ メニュー作成ページにアクセスしている
    もし メニュー説明に"<script>alert('XSS')</script>"を入力する
    かつ 「登録」ボタンをクリックする
    ならば メニューが正常に登録される
    かつ メニュー一覧ページで説明が"&lt;script&gt;alert('XSS')&lt;/script&gt;"とエスケープされて表示される
    かつ スクリプトが実行されない

  # XSS攻撃防止（イベントハンドラ）
  シナリオ: イベントハンドラを含むHTML入力がエスケープされる
    前提 ユーザーでログインしている
    かつ 予約作成ページにアクセスしている
    もし 備考に"<img src=x onerror='alert(1)'>"を入力する
    かつ 「予約する」ボタンをクリックする
    ならば 予約が正常に登録される
    かつ 予約詳細ページで備考が"&lt;img src=x onerror='alert(1)'&gt;"とエスケープされて表示される
    かつ スクリプトが実行されない

  # XSS攻撃防止（リンク）
  シナリオ: JavaScriptプロトコルを含むリンクがエスケープされる
    前提 ユーザーでログインしている
    かつ 予約作成ページにアクセスしている
    もし 備考に"<a href='javascript:alert(1)'>クリック</a>"を入力する
    かつ 「予約する」ボタンをクリックする
    ならば 予約が正常に登録される
    かつ 予約詳細ページでリンクがエスケープされて表示される
    かつ スクリプトが実行されない

  # XSS攻撃防止（iframe）
  シナリオ: iframeタグを含む入力がエスケープされる
    前提 管理者でログインしている
    かつ 店舗設定ページにアクセスしている
    もし 店舗紹介文に"<iframe src='https://evil.com'></iframe>"を入力する
    かつ 「保存」ボタンをクリックする
    ならば 設定が正常に保存される
    かつ 店舗紹介文が"&lt;iframe src='https://evil.com'&gt;&lt;/iframe&gt;"とエスケープされて表示される
    かつ iframeは埋め込まれない

  # XSS攻撃防止（SVG）
  シナリオ: SVGタグを含む入力がエスケープされる
    前提 ユーザーでログインしている
    かつ 予約作成ページにアクセスしている
    もし 備考に"<svg onload='alert(1)'>"を入力する
    かつ 「予約する」ボタンをクリックする
    ならば 予約が正常に登録される
    かつ 予約詳細ページでSVGタグがエスケープされて表示される
    かつ スクリプトが実行されない

  # XSS攻撃防止（HTMLエンティティ）
  シナリオ: HTMLエンティティを使った攻撃もエスケープされる
    前提 ユーザーでログインしている
    かつ 予約作成ページにアクセスしている
    もし 備考に"&#60;script&#62;alert('XSS')&#60;/script&#62;"を入力する
    かつ 「予約する」ボタンをクリックする
    ならば 予約が正常に登録される
    かつ 予約詳細ページでエスケープされた文字列として表示される
    かつ スクリプトが実行されない

  # CSRF攻撃防止（トークン検証）
  シナリオ: CSRFトークンなしでのPOSTリクエストは拒否される
    前提 ユーザーでログインしている
    もし CSRFトークンなしで "/api/reservations" にPOSTリクエストを送る
    ならば ステータスコード "403" が返される
    かつ エラーメッセージ"CSRF トークンが無効です"が返される
    かつ 予約は登録されない

  シナリオ: 不正なCSRFトークンでのPOSTリクエストは拒否される
    前提 ユーザーでログインしている
    もし 不正なCSRFトークンで "/api/reservations" にPOSTリクエストを送る
    ならば ステータスコード "403" が返される
    かつ エラーメッセージ"CSRF トークンが無効です"が返される
    かつ 予約は登録されない

  シナリオ: 有効なCSRFトークンでのPOSTリクエストは成功する
    前提 ユーザーでログインしている
    かつ 有効なCSRFトークンを取得している
    もし 有効なCSRFトークンで "/api/reservations" にPOSTリクエストを送る
    ならば ステータスコード "201" が返される
    かつ 予約が正常に登録される

  # CSRF攻撃防止（PATCHリクエスト）
  シナリオ: CSRFトークンなしでのPATCHリクエストは拒否される
    前提 ユーザーでログインしている
    かつ 自分の予約が存在する
    もし CSRFトークンなしで予約更新APIにPATCHリクエストを送る
    ならば ステータスコード "403" が返される
    かつ エラーメッセージ"CSRF トークンが無効です"が返される
    かつ 予約は更新されない

  # CSRF攻撃防止（DELETEリクエスト）
  シナリオ: CSRFトークンなしでのDELETEリクエストは拒否される
    前提 ユーザーでログインしている
    かつ 自分の予約が存在する
    もし CSRFトークンなしで予約削除APIにDELETEリクエストを送る
    ならば ステータスコード "403" が返される
    かつ エラーメッセージ"CSRF トークンが無効です"が返される
    かつ 予約は削除されない

  # CSRF攻撃防止（管理者操作）
  シナリオ: CSRFトークンなしでの管理者操作は拒否される
    前提 管理者でログインしている
    もし CSRFトークンなしで "/api/admin/menus" にPOSTリクエストを送る
    ならば ステータスコード "403" が返される
    かつ エラーメッセージ"CSRF トークンが無効です"が返される
    かつ メニューは登録されない

  # CSRF攻撃防止（トークンの有効期限）
  シナリオ: 期限切れのCSRFトークンでのリクエストは拒否される
    前提 ユーザーでログインしている
    かつ CSRFトークンが発行されている
    もし CSRFトークンの有効期限が切れる
    かつ 期限切れのトークンで "/api/reservations" にPOSTリクエストを送る
    ならば ステータスコード "403" が返される
    かつ エラーメッセージ"CSRF トークンの有効期限が切れています"が返される
    かつ 予約は登録されない

  # CSRF攻撃防止（SameSite Cookie）
  シナリオ: SameSite属性付きCookieによるCSRF防止
    前提 ユーザーでログインしている
    かつ セッションCookieにSameSite=Lax属性が設定されている
    もし 外部サイトからクロスサイトリクエストを送る
    ならば リクエストがブロックされる
    かつ エラーメッセージ"不正なリクエストです"が表示される

  # Content Security Policy (CSP)
  シナリオ: CSPヘッダーによるインラインスクリプトの実行防止
    前提 ユーザーがページにアクセスしている
    もし レスポンスヘッダーにContent-Security-Policyが設定されている
    ならば インラインスクリプトが実行されない
    かつ 外部スクリプトの読み込みが制限される

  # SQL Injection防止（Prisma ORMによる自動防御）
  シナリオ: SQLインジェクションを試みてもエスケープされる
    前提 ログインページにアクセスしている
    もし メールアドレスに"test@example.com' OR '1'='1"を入力する
    かつ パスワードに"password' OR '1'='1"を入力する
    かつ 「ログイン」ボタンをクリックする
    ならば ログインに失敗する
    かつ エラーメッセージ"メールアドレスまたはパスワードが正しくありません"が表示される
    かつ SQLインジェクションは実行されない

  シナリオ: 検索機能でのSQLインジェクション防止
    前提 管理者でログインしている
    かつ 顧客管理ページにアクセスしている
    もし 検索フォームに"'; DROP TABLE restaurant_users; --"を入力する
    かつ 「検索」ボタンをクリックする
    ならば 検索結果が"該当するユーザーが見つかりません"と表示される
    かつ テーブルは削除されない
    かつ SQLインジェクションは実行されない

  # HTML属性インジェクション防止
  シナリオ: HTML属性インジェクションが防止される
    前提 ユーザーでログインしている
    かつ プロフィール編集ページにアクセスしている
    もし 名前に"田中" onmouseover="alert('XSS')"を入力する
    かつ 「保存」ボタンをクリックする
    ならば プロフィールが正常に保存される
    かつ プロフィールページで名前が"田中\" onmouseover=\"alert('XSS')\""とエスケープされて表示される
    かつ スクリプトが実行されない

  # HTTPヘッダーインジェクション防止
  シナリオ: HTTPヘッダーインジェクションが防止される
    前提 ユーザーでログインしている
    もし リダイレクトURLに改行コードとSet-Cookieヘッダーを含めて送信する
    ならば リダイレクトが拒否される
    かつ エラーメッセージ"不正なリクエストです"が表示される
    かつ 不正なCookieは設定されない

  # Clickjacking防止（X-Frame-Options）
  シナリオ: X-Frame-Optionsヘッダーによるクリックジャッキング防止
    前提 ユーザーがページにアクセスしている
    もし レスポンスヘッダーに"X-Frame-Options: DENY"が設定されている
    ならば ページがiframe内に埋め込まれない
    かつ ブラウザがframeでの表示を拒否する

  # Open Redirect防止
  シナリオ: オープンリダイレクトが防止される
    前提 ユーザーがログインページにアクセスしている
    もし redirectパラメータに"https://evil.com"を設定する
    かつ ログインに成功する
    ならば 外部サイトにリダイレクトされない
    かつ 内部ページ "/mypage" にリダイレクトされる
    かつ セキュリティログに警告が記録される
