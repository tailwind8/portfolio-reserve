# 予約システム開発プロセス設計

## 🎯 開発方針

### コアプリンシプル
1. **ATDD/BDDによるテスト駆動開発** - 受入テストから始める
2. **GitHub Issueによる機能管理** - すべての機能をIssue化して追跡
3. **継続的リファクタリング** - Red → Green → Refactor サイクル
4. **生成AI駆動開発** - AIを活用して品質を保ちながら高速開発
5. **技術負債の最小化** - コードレビュー、静的解析、テストカバレッジ

---

## 📋 開発プロセスフロー

```
1. GitHub Issue作成（機能要件定義）
   ↓
2. BDDシナリオ作成（Gherkin記法）
   ↓
3. 受入テスト実装（Playwright/Cypress）
   ↓ [Red]
4. 単体テスト実装（Jest + RTL）
   ↓ [Red]
5. 最小実装（機能実装）
   ↓ [Green]
6. リファクタリング
   ↓ [Refactor]
7. コードレビュー（AIレビュー + 手動レビュー）
   ↓
8. PR作成 → マージ
   ↓
9. Issue Close
```

---

## 🧪 テスト戦略

### テストピラミッド

```
        /\
       /E2E\         E2Eテスト（10%）
      /------\       - Playwright
     /Integration\   統合テスト（30%）
    /------------\   - React Testing Library
   /  Unit Tests  \  単体テスト（60%）
  /----------------\ - Jest
```

### テスト種別と責務

| テスト種別 | ツール | 責務 | カバレッジ目標 |
|----------|--------|------|--------------|
| E2E | Playwright | ユーザーシナリオの検証 | 主要フロー100% |
| 統合テスト | RTL | コンポーネント間連携 | 70% |
| 単体テスト | Jest | 関数・ロジックの検証 | 80% |

---

## 🏗️ 技術スタック（追加）

### テスト関連
- **E2Eテスト**: Playwright
- **コンポーネントテスト**: React Testing Library
- **単体テスト**: Jest
- **BDDツール**: Cucumber.js（オプション）
- **モック**: MSW (Mock Service Worker)

### コード品質
- **Linter**: ESLint（Next.js推奨設定 + strict）
- **Formatter**: Prettier
- **型チェック**: TypeScript strict mode
- **コミットフック**: Husky + lint-staged
- **CI/CD**: GitHub Actions

### データベース・認証
- **DB**: Supabase PostgreSQL
- **ORM**: Prisma（型安全性のため）
- **認証**: Supabase Auth
- **バリデーション**: Zod

---

## 📝 GitHub Issue管理

### Issueラベル体系

| ラベル | 説明 | 色 |
|-------|------|-----|
| `feature` | 新機能 | 🟢 緑 |
| `bug` | バグ修正 | 🔴 赤 |
| `refactor` | リファクタリング | 🟡 黄 |
| `test` | テスト追加 | 🔵 青 |
| `docs` | ドキュメント | ⚪ 白 |
| `tech-debt` | 技術的負債 | 🟠 オレンジ |
| `priority-high` | 高優先度 | 🔴 赤 |
| `priority-medium` | 中優先度 | 🟡 黄 |
| `priority-low` | 低優先度 | 🟢 緑 |
| `sprint-1` | Sprint 1 | 🔵 青 |
| `sprint-2` | Sprint 2 | 🔵 青 |

### Issue テンプレート

#### 1. Feature Issue Template
```markdown
## 📋 機能概要
<!-- 何を実装するか -->

## 🎯 ユーザーストーリー
As a [ユーザー種別]
I want to [やりたいこと]
So that [目的・価値]

## ✅ 受入基準（BDD Scenario）
```gherkin
Feature: [機能名]

  Scenario: [シナリオ名]
    Given [前提条件]
    When [アクション]
    Then [期待結果]
    And [追加の期待結果]
```

## 🔧 実装タスク
- [ ] BDDシナリオ作成
- [ ] E2Eテスト実装
- [ ] 単体テスト実装
- [ ] 機能実装
- [ ] リファクタリング
- [ ] ドキュメント更新

## 📦 関連Issue
- Depends on: #XX
- Blocks: #XX
- Related to: #XX

## 🧪 テストケース
<!-- 追加のテストケースがあれば記載 -->

## 📝 メモ
<!-- 実装時の注意点など -->
```

#### 2. Bug Issue Template
```markdown
## 🐛 バグ概要
<!-- 何が起きているか -->

## 🔄 再現手順
1.
2.
3.

## 🎯 期待される動作
<!-- 本来どうあるべきか -->

## 📸 スクリーンショット
<!-- あれば添付 -->

## 🌍 環境
- OS:
- ブラウザ:
- バージョン:

## 🔧 修正方針（案）
<!-- もしあれば -->

## ⚠️ 影響範囲
- [ ] ユーザー機能
- [ ] 管理者機能
- [ ] API
- [ ] データベース
```

#### 3. Refactor Issue Template
```markdown
## 🔄 リファクタリング対象
<!-- どのコードをリファクタリングするか -->

## 🎯 目的
- [ ] 可読性向上
- [ ] パフォーマンス改善
- [ ] 保守性向上
- [ ] 重複コード削減
- [ ] テストカバレッジ向上

## 📊 現状の課題
<!-- 何が問題か -->

## ✨ リファクタリング後
<!-- どう改善されるか -->

## ✅ チェックリスト
- [ ] テストが通る
- [ ] 機能に影響がない
- [ ] コードレビュー完了
```

---

## 🔄 開発サイクル（Sprint）

### Sprint期間: 1週間

#### Sprint構成
```
Sprint N（1週間）
├── Day 1: Sprint Planning + Issue作成
├── Day 2-5: 開発（TDD + リファクタリング）
├── Day 6: コードレビュー + バグ修正
└── Day 7: Sprint Review + Retrospective
```

### Sprint 1-4 の目標

#### **Sprint 1: 基盤構築**（1週目）
- [ ] テスト環境セットアップ（Jest, RTL, Playwright）
- [ ] Supabase接続 + Prismaセットアップ
- [ ] 認証機能実装（ユーザー登録・ログイン）
- [ ] CI/CD構築（GitHub Actions）

#### **Sprint 2: 予約機能（ユーザー側）**（2週目）
- [ ] 予約カレンダー実装
- [ ] メニュー選択機能
- [ ] スタッフ選択機能
- [ ] 予約登録・確認メール送信

#### **Sprint 3: 管理機能（店舗側）**（3週目）
- [ ] ダッシュボード実装
- [ ] 予約管理（CRUD）
- [ ] 顧客管理
- [ ] スタッフ管理

#### **Sprint 4: 拡張機能**（4週目）
- [ ] メニュー管理
- [ ] リマインダーメール自動送信
- [ ] 分析レポート
- [ ] パフォーマンス最適化

---

## 🤖 生成AI駆動開発のワークフロー

### AIを活用するポイント

#### 1. **テストコード生成**
```
プロンプト例:
「以下のユーザーストーリーに対するPlaywrightのE2Eテストを生成してください：
- As a customer, I want to book a reservation...」
```

#### 2. **実装コード生成**
```
プロンプト例:
「以下のテストが通るようにReactコンポーネントを実装してください：
[テストコードを貼り付け]」
```

#### 3. **リファクタリング提案**
```
プロンプト例:
「以下のコードをクリーンコード原則に従ってリファクタリングしてください：
- 関数は小さく
- DRY原則
- 単一責任の原則」
```

#### 4. **コードレビュー**
```
プロンプト例:
「以下のPRコードをレビューしてください。観点：
- バグの可能性
- パフォーマンス
- セキュリティ
- 可読性
- テストカバレッジ」
```

#### 5. **ドキュメント生成**
```
プロンプト例:
「以下の関数にJSDocコメントを追加してください」
```

---

## 📊 技術負債管理

### 技術負債の可視化

#### 1. **SonarQubeまたはCodeClimateを導入**
- コード品質スコア
- 技術負債の時間換算
- コードスメルの検出

#### 2. **週次レビュー**
- 毎週金曜にコードベース全体をレビュー
- 技術負債IssueをBacklogに追加
- 優先度をつけて計画的に解消

#### 3. **リファクタリング時間の確保**
- 各Sprintの20%をリファクタリングに割り当て
- 「Boy Scout Rule」: 触ったコードは元より綺麗に

---

## 🔒 コード品質チェックリスト

### PRマージ前チェック
- [ ] すべてのテストが通る（Unit + Integration + E2E）
- [ ] テストカバレッジ80%以上
- [ ] ESLintエラー0件
- [ ] TypeScriptエラー0件
- [ ] Lighthouseスコア90以上（Performance）
- [ ] アクセシビリティチェック（axe）
- [ ] セキュリティ脆弱性チェック（npm audit）

---

## 🚀 最初にやるべきこと（優先順位順）

### Week 1: 開発基盤構築

#### Day 1-2: テスト環境セットアップ
1. [ ] Jestセットアップ
2. [ ] React Testing Libraryセットアップ
3. [ ] Playwrightセットアップ
4. [ ] MSWセットアップ（APIモック）

#### Day 3-4: DB・認証セットアップ
5. [ ] Prismaセットアップ + スキーマ定義
6. [ ] Supabase接続設定
7. [ ] 環境変数管理（.env.local, .env.example）

#### Day 5: CI/CD構築
8. [ ] GitHub Actionsワークフロー作成
9. [ ] 自動テスト実行
10. [ ] 自動デプロイ（Vercel）

#### Day 6-7: Issue作成 + Sprint Planning
11. [ ] 全機能をGitHub Issue化
12. [ ] Sprint 1のタスク割り当て

---

## 📁 推奨ディレクトリ構造

```
reserve-system/
├── reserve-app/
│   ├── src/
│   │   ├── app/                    # Next.js App Router
│   │   ├── components/             # UIコンポーネント
│   │   │   ├── ui/                 # 汎用UIコンポーネント
│   │   │   └── features/           # 機能別コンポーネント
│   │   ├── lib/                    # ユーティリティ・ヘルパー
│   │   │   ├── supabase/          # Supabase関連
│   │   │   ├── utils/             # 汎用ユーティリティ
│   │   │   └── validations/       # Zodスキーマ
│   │   ├── hooks/                  # カスタムフック
│   │   ├── types/                  # TypeScript型定義
│   │   └── __tests__/              # テストファイル
│   │       ├── unit/              # 単体テスト
│   │       ├── integration/       # 統合テスト
│   │       └── e2e/               # E2Eテスト
│   ├── prisma/
│   │   ├── schema.prisma          # Prismaスキーマ
│   │   └── migrations/            # マイグレーション
│   ├── public/
│   ├── playwright.config.ts       # Playwright設定
│   ├── jest.config.js             # Jest設定
│   └── package.json
├── documents/                      # ドキュメント
│   ├── 機能一覧とページ設計.md
│   ├── 開発プロセス設計.md
│   ├── BDDシナリオ/
│   └── API仕様書/
└── .github/
    ├── ISSUE_TEMPLATE/            # Issueテンプレート
    │   ├── feature.md
    │   ├── bug.md
    │   └── refactor.md
    └── workflows/                 # GitHub Actions
        ├── test.yml
        ├── lint.yml
        └── deploy.yml
```

---

## 🎓 BDD開発例

### Example: ユーザー予約機能

#### 1. BDDシナリオ（Gherkin）
```gherkin
Feature: 予約機能
  As a customer
  I want to book a reservation
  So that I can visit the store at my preferred time

  Scenario: 予約成功
    Given ユーザーがログインしている
    And 予約カレンダーページにアクセスしている
    When "2025年1月20日"を選択する
    And "14:00"の時間帯を選択する
    And "カット"メニューを選択する
    And "田中"スタッフを選択する
    And "予約を確定する"ボタンをクリックする
    Then 予約完了画面が表示される
    And 確認メールが送信される
```

#### 2. E2Eテスト（Playwright）
```typescript
// src/__tests__/e2e/booking.spec.ts
import { test, expect } from '@playwright/test';

test.describe('予約機能', () => {
  test('予約成功', async ({ page }) => {
    // Given: ユーザーがログインしている
    await page.goto('/login');
    await page.fill('[name="email"]', 'test@example.com');
    await page.fill('[name="password"]', 'password123');
    await page.click('button[type="submit"]');

    // And: 予約カレンダーページにアクセスしている
    await page.goto('/booking');

    // When: 日時を選択
    await page.click('button:has-text("20")');
    await page.click('button:has-text("14:00")');

    // And: メニュー選択
    await page.selectOption('select[name="menu"]', 'カット');

    // And: スタッフ選択
    await page.selectOption('select[name="staff"]', '田中');

    // And: 予約確定
    await page.click('button:has-text("予約を確定する")');

    // Then: 予約完了画面が表示される
    await expect(page).toHaveURL('/booking/complete');
    await expect(page.locator('h1')).toContainText('予約が完了しました');
  });
});
```

#### 3. 単体テスト（Jest + RTL）
```typescript
// src/__tests__/unit/BookingCalendar.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import BookingCalendar from '@/components/BookingCalendar';

describe('BookingCalendar', () => {
  it('日付を選択できる', () => {
    render(<BookingCalendar />);

    const dateButton = screen.getByText('20');
    fireEvent.click(dateButton);

    expect(dateButton).toHaveClass('bg-blue-500');
  });
});
```

---

## 📈 成功指標（KPI）

### コード品質
- テストカバレッジ: **80%以上**
- 技術負債時間: **1日以内**
- ESLintエラー: **0件**
- バグ発生率: **Sprint毎に5件以下**

### パフォーマンス
- Lighthouse Performance: **90以上**
- First Contentful Paint: **1.5秒以内**
- Time to Interactive: **3秒以内**

### 開発速度
- Issue Close率: **80%以上**（Sprint内）
- PRマージまでの時間: **24時間以内**
- CI/CD実行時間: **5分以内**

---

## 🚦 次のアクション

1. **今すぐやること**: GitHub Issueテンプレート作成
2. **次にやること**: テスト環境セットアップ
3. **その次**: 認証機能の実装（ATDD/BDD）

準備ができたら、まずGitHub Issueのテンプレートファイルを作成しましょうか？
