Supabase Free 2プロジェクト × 複数デモサイトの設計戦略
1. テーブル設計：Prefix戦略の詳細
【推奨】Prefix付きテーブル構成
sql-- Supabase Project 1 のテーブル構成例

-- 飲食店予約システム用テーブル
CREATE TABLE restaurant_users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email TEXT UNIQUE NOT NULL,
  name TEXT,
  phone TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE restaurant_reservations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES restaurant_users(id),
  date DATE NOT NULL,
  time TIME NOT NULL,
  party_size INTEGER NOT NULL,
  status TEXT DEFAULT 'pending',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE restaurant_menus (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  price DECIMAL(10,2),
  category TEXT,
  available BOOLEAN DEFAULT true
);

-- 士業向けシステム用テーブル
CREATE TABLE accounting_clients (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  email TEXT,
  company TEXT,
  contract_type TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE accounting_appointments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  client_id UUID REFERENCES accounting_clients(id),
  appointment_date TIMESTAMPTZ NOT NULL,
  purpose TEXT,
  status TEXT DEFAULT 'scheduled',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

2. Prefix戦略のメリット・デメリット
メリット ✅
markdown1. コスト削減
   - 2つのSupabase Freeプロジェクトで5つ以上のデモをカバー

2. 管理が楽
   - 1つのダッシュボードで全体を確認
   - マイグレーションが一元管理できる

3. 認証の共有
   - 1つのAuth設定で複数デモに対応可能
   - ユーザー管理が統一される

4. ストレージの効率化
   - 500MB × 2 = 1GB を効率的に使える
デメリット ⚠️
markdown1. データが混在する
   - 全てのデモデータが同じDBに存在
   - テーブル数が増えると管理が複雑

2. セキュリティリスク
   - RLS（Row Level Security）の設定ミスで
     他のデモのデータが見えてしまう可能性

3. スキーマの複雑化
   - テーブル数が多くなる（20-30個以上）
   - ER図が見づらくなる

4. 将来の分離が大変
   - 後で独立したプロジェクトに分けるのが面倒

3. 【重要】データ分離の方法
方法A：Prefix + RLS（Row Level Security）
sql-- 例：restaurant_users テーブルのRLS設定

-- RLSを有効化
ALTER TABLE restaurant_users ENABLE ROW LEVEL SECURITY;

-- デモごとにAPIキーで分離するパターン
-- （あまり推奨しないが、シンプル）

-- 認証済みユーザーは自分のデータのみ閲覧可能
CREATE POLICY "Users can view own data"
  ON restaurant_users
  FOR SELECT
  TO authenticated
  USING (auth.uid() = id);

-- 挿入も自分のデータのみ
CREATE POLICY "Users can insert own data"
  ON restaurant_users
  FOR INSERT
  TO authenticated
  WITH CHECK (auth.uid() = id);
方法B：tenant_id カラムでの分離（より堅牢）
sql-- 各テーブルに tenant_id を追加する方法

CREATE TABLE restaurant_users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id TEXT NOT NULL DEFAULT 'demo-restaurant', -- 追加
  email TEXT NOT NULL,
  name TEXT,
  phone TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(tenant_id, email) -- テナントごとにユニーク
);

-- インデックス作成（パフォーマンス向上）
CREATE INDEX idx_restaurant_users_tenant 
  ON restaurant_users(tenant_id);

-- RLS設定（tenant_idで完全分離）
ALTER TABLE restaurant_users ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Tenant isolation"
  ON restaurant_users
  USING (
    tenant_id = current_setting('app.tenant_id', true)
  );
アプリ側での使用：
typescript// lib/supabase.ts
import { createClient } from '@supabase/supabase-js'

export const createTenantClient = (tenantId: string) => {
  const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      db: {
        schema: 'public',
      },
      global: {
        headers: {
          'x-tenant-id': tenantId,
        },
      },
    }
  )

  // セッション変数を設定
  supabase.rpc('set_tenant', { tenant_id: tenantId })

  return supabase
}

// 使用例
// apps/demo-restaurant/lib/supabase.ts
import { createTenantClient } from '@/shared/supabase'

export const supabase = createTenantClient('demo-restaurant')
Supabase側の関数：
sql-- tenant_idを設定する関数
CREATE OR REPLACE FUNCTION set_tenant(tenant_id TEXT)
RETURNS void AS $$
BEGIN
  PERFORM set_config('app.tenant_id', tenant_id, false);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

GRANT EXECUTE ON FUNCTION set_tenant TO anon, authenticated;

4. 2つのSupabaseプロジェクトの分け方
推奨構成
markdown## Supabase Project 1：「トランザクション系デモ」
├── restaurant_* （飲食店予約システム）
│   ├── restaurant_users
│   ├── restaurant_reservations
│   ├── restaurant_menus
│   └── restaurant_settings
│
└── accounting_* （士業向けシステム）
    ├── accounting_clients
    ├── accounting_appointments
    ├── accounting_contracts
    └── accounting_documents

理由：
- 予約や予約管理など、リアルタイム性が重要
- ユーザー認証が必須
- データの整合性が重要

## Supabase Project 2：「カタログ・EC系デモ」
├── ec_* （ECサイト）
│   ├── ec_products
│   ├── ec_categories
│   ├── ec_orders
│   ├── ec_carts
│   └── ec_users
│
└── construction_* （施工管理システム）
    ├── construction_projects
    ├── construction_tasks
    ├── construction_photos
    └── construction_clients

理由：
- 商品データなど、データ量が多め
- 画像ストレージの使用が多い
- 読み取り中心

5. 具体的なテーブル設計例
Supabase Project 1 の完全なスキーマ
sql-- =====================================
-- 飲食店予約システム
-- =====================================

-- ユーザー
CREATE TABLE restaurant_users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id TEXT NOT NULL DEFAULT 'demo-restaurant',
  email TEXT NOT NULL,
  name TEXT,
  phone TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(tenant_id, email)
);

-- 予約
CREATE TABLE restaurant_reservations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id TEXT NOT NULL DEFAULT 'demo-restaurant',
  user_id UUID REFERENCES restaurant_users(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  time TIME NOT NULL,
  party_size INTEGER NOT NULL CHECK (party_size > 0),
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'confirmed', 'cancelled', 'completed')),
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- メニュー
CREATE TABLE restaurant_menus (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id TEXT NOT NULL DEFAULT 'demo-restaurant',
  name TEXT NOT NULL,
  description TEXT,
  price DECIMAL(10,2) NOT NULL,
  category TEXT,
  image_url TEXT,
  available BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 店舗設定
CREATE TABLE restaurant_settings (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id TEXT NOT NULL DEFAULT 'demo-restaurant' UNIQUE,
  business_hours JSONB,
  closed_days TEXT[],
  max_party_size INTEGER DEFAULT 10,
  booking_window_days INTEGER DEFAULT 30,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- =====================================
-- 士業向けシステム
-- =====================================

-- 顧客
CREATE TABLE accounting_clients (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id TEXT NOT NULL DEFAULT 'demo-accounting',
  name TEXT NOT NULL,
  email TEXT,
  phone TEXT,
  company TEXT,
  contract_type TEXT,
  contract_start_date DATE,
  contract_end_date DATE,
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'pending')),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 予約・面談
CREATE TABLE accounting_appointments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id TEXT NOT NULL DEFAULT 'demo-accounting',
  client_id UUID REFERENCES accounting_clients(id) ON DELETE CASCADE,
  appointment_date TIMESTAMPTZ NOT NULL,
  duration_minutes INTEGER DEFAULT 60,
  purpose TEXT,
  status TEXT DEFAULT 'scheduled' CHECK (status IN ('scheduled', 'completed', 'cancelled', 'no_show')),
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 契約
CREATE TABLE accounting_contracts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id TEXT NOT NULL DEFAULT 'demo-accounting',
  client_id UUID REFERENCES accounting_clients(id) ON DELETE CASCADE,
  contract_number TEXT UNIQUE,
  service_type TEXT,
  monthly_fee DECIMAL(10,2),
  start_date DATE NOT NULL,
  end_date DATE,
  status TEXT DEFAULT 'active',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- タスク・TODO
CREATE TABLE accounting_tasks (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id TEXT NOT NULL DEFAULT 'demo-accounting',
  client_id UUID REFERENCES accounting_clients(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  due_date DATE,
  priority TEXT DEFAULT 'medium' CHECK (priority IN ('low', 'medium', 'high')),
  status TEXT DEFAULT 'todo' CHECK (status IN ('todo', 'in_progress', 'done')),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- =====================================
-- インデックス作成
-- =====================================

CREATE INDEX idx_restaurant_reservations_date ON restaurant_reservations(date);
CREATE INDEX idx_restaurant_reservations_user ON restaurant_reservations(user_id);
CREATE INDEX idx_accounting_appointments_date ON accounting_appointments(appointment_date);
CREATE INDEX idx_accounting_appointments_client ON accounting_appointments(client_id);

-- =====================================
-- RLS設定
-- =====================================

ALTER TABLE restaurant_users ENABLE ROW LEVEL SECURITY;
ALTER TABLE restaurant_reservations ENABLE ROW LEVEL SECURITY;
ALTER TABLE restaurant_menus ENABLE ROW LEVEL SECURITY;
ALTER TABLE accounting_clients ENABLE ROW LEVEL SECURITY;
ALTER TABLE accounting_appointments ENABLE ROW LEVEL SECURITY;

-- デモサイトは全データ閲覧可能（anon ロール）
CREATE POLICY "Demo users can view all restaurant data"
  ON restaurant_users FOR SELECT TO anon USING (true);

CREATE POLICY "Demo users can view all reservations"
  ON restaurant_reservations FOR SELECT TO anon USING (true);

CREATE POLICY "Demo users can view all menus"
  ON restaurant_menus FOR SELECT TO anon USING (true);

-- 挿入も許可（デモなので）
CREATE POLICY "Demo users can insert reservations"
  ON restaurant_reservations FOR INSERT TO anon WITH CHECK (true);

-- 同様に他のテーブルにも設定...

6. 環境変数の管理
モノレポでの環境変数構成
bash# ルートの .env（共通）
SUPABASE_PROJECT_1_URL=https://xxxxx.supabase.co
SUPABASE_PROJECT_1_ANON_KEY=eyJhbGc...
SUPABASE_PROJECT_2_URL=https://yyyyy.supabase.co
SUPABASE_PROJECT_2_ANON_KEY=eyJhbGc...

# apps/demo-restaurant/.env.local
NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_PROJECT_1_URL}
NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_PROJECT_1_ANON_KEY}
NEXT_PUBLIC_TENANT_ID=demo-restaurant

# apps/demo-accounting/.env.local
NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_PROJECT_1_URL}
NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_PROJECT_1_ANON_KEY}
NEXT_PUBLIC_TENANT_ID=demo-accounting

# apps/demo-ec/.env.local
NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_PROJECT_2_URL}
NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_PROJECT_2_ANON_KEY}
NEXT_PUBLIC_TENANT_ID=demo-ec

# apps/demo-construction/.env.local
NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_PROJECT_2_URL}
NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_PROJECT_2_ANON_KEY}
NEXT_PUBLIC_TENANT_ID=demo-construction

7. 共通ライブラリの作成
packages/database/src/client.ts
typescriptimport { createClient, SupabaseClient } from '@supabase/supabase-js'

export interface TenantConfig {
  tenantId: string
  supabaseUrl: string
  supabaseKey: string
}

export class TenantSupabaseClient {
  private client: SupabaseClient
  private tenantId: string

  constructor(config: TenantConfig) {
    this.tenantId = config.tenantId
    this.client = createClient(config.supabaseUrl, config.supabaseKey, {
      auth: {
        persistSession: false, // デモなのでセッション永続化不要
      },
    })
  }

  // tenant_id を自動的に付与するヘルパー
  async from<T = any>(table: string) {
    return this.client
      .from(table)
      .select('*')
      .eq('tenant_id', this.tenantId)
  }

  async insert<T = any>(table: string, data: Partial<T>) {
    return this.client
      .from(table)
      .insert({
        ...data,
        tenant_id: this.tenantId,
      })
  }

  async update<T = any>(table: string, id: string, data: Partial<T>) {
    return this.client
      .from(table)
      .update(data)
      .eq('id', id)
      .eq('tenant_id', this.tenantId)
  }

  async delete(table: string, id: string) {
    return this.client
      .from(table)
      .delete()
      .eq('id', id)
      .eq('tenant_id', this.tenantId)
  }

  // 生のクライアントへのアクセス（必要な場合）
  getClient() {
    return this.client
  }
}

// ファクトリー関数
export const createTenantClient = (config: TenantConfig) => {
  return new TenantSupabaseClient(config)
}
使用例
typescript// apps/demo-restaurant/lib/supabase.ts
import { createTenantClient } from '@repo/database'

export const supabase = createTenantClient({
  tenantId: process.env.NEXT_PUBLIC_TENANT_ID!,
  supabaseUrl: process.env.NEXT_PUBLIC_SUPABASE_URL!,
  supabaseKey: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
})

// 使用例
const { data: reservations } = await supabase.from('restaurant_reservations')
// 自動的に tenant_id = 'demo-restaurant' でフィルタリングされる

const { data: newReservation } = await supabase.insert('restaurant_reservations', {
  date: '2025-01-10',
  time: '18:00',
  party_size: 4,
  // tenant_id は自動的に付与される
})

8. マイグレーション管理
Supabase CLI でのマイグレーション
bash# Supabase CLIインストール
npm install -g supabase

# プロジェクトと紐付け
supabase link --project-ref xxxxx

# マイグレーションファイル作成
supabase migration new create_restaurant_tables

# マイグレーション適用
supabase db push

# スキーマのダンプ
supabase db dump -f schema.sql
```

### マイグレーションファイルの管理
```
supabase/
├── migrations/
│   ├── 20250101000000_create_restaurant_tables.sql
│   ├── 20250101000001_create_accounting_tables.sql
│   ├── 20250101000002_setup_rls_policies.sql
│   └── 20250101000003_insert_demo_data.sql
└── seed.sql

9. デモデータの投入
seed.sql（サンプルデータ）
sql-- restaurant_users
INSERT INTO restaurant_users (tenant_id, email, name, phone) VALUES
('demo-restaurant', 'yamada@example.com', '山田太郎', '090-1234-5678'),
('demo-restaurant', 'sato@example.com', '佐藤花子', '090-2345-6789'),
('demo-restaurant', 'tanaka@example.com', '田中一郎', '090-3456-7890');

-- restaurant_reservations
INSERT INTO restaurant_reservations (tenant_id, user_id, date, time, party_size, status)
SELECT 
  'demo-restaurant',
  id,
  CURRENT_DATE + (ROW_NUMBER() OVER ()) * INTERVAL '1 day',
  '18:00'::TIME + (ROW_NUMBER() OVER () * INTERVAL '30 minutes'),
  2 + (ROW_NUMBER() OVER () % 4),
  CASE 
    WHEN ROW_NUMBER() OVER () % 3 = 0 THEN 'confirmed'
    WHEN ROW_NUMBER() OVER () % 3 = 1 THEN 'pending'
    ELSE 'completed'
  END
FROM restaurant_users
WHERE tenant_id = 'demo-restaurant'
LIMIT 10;

-- restaurant_menus
INSERT INTO restaurant_menus (tenant_id, name, description, price, category, available) VALUES
('demo-restaurant', '和牛ステーキ', '最高級A5ランク和牛', 5800, '肉料理', true),
('demo-restaurant', '海鮮パスタ', '新鮮な魚介のトマトパスタ', 1980, 'パスタ', true),
('demo-restaurant', 'シーザーサラダ', 'クリーミーなドレッシング', 980, 'サラダ', true),
('demo-restaurant', 'ティラミス', '自家製マスカルポーネ', 680, 'デザート', true);

-- accounting_clients
INSERT INTO accounting_clients (tenant_id, name, email, company, contract_type, status) VALUES
('demo-accounting', '株式会社サンプル', 'info@sample.co.jp', '株式会社サンプル', '顧問契約', 'active'),
('demo-accounting', '田中商店', 'tanaka@shop.com', '田中商店', '確定申告', 'active'),
('demo-accounting', '山田工業', 'yamada@industry.jp', '山田工業株式会社', '顧問契約', 'active');

10. 注意点とベストプラクティス
⚠️ 注意点
markdown1. テーブル数の上限
   - Supabase Freeに制限はないが、管理が煩雑になる
   - 1プロジェクトあたり20-30テーブルが実用的な上限

2. ストレージ容量
   - 500MB/プロジェクト = 画像は最小限に
   - デモ用の画像は低解像度・圧縮済みを使用

3. RLSの設定ミス
   - 必ず全テーブルでRLSを有効化
   - anonロールの権限を適切に設定

4. デモデータのメンテナンス
   - 定期的にリセットするスクリプトを用意
   - 古いデータは自動削除
✅ ベストプラクティス
markdown1. テーブル命名規則を厳守
   - 必ず {demo_name}_{table_name} の形式
   - 例: restaurant_users, ec_products

2. tenant_id を全テーブルに追加
   - データの完全分離が可能
   - 将来の移行が楽

3. インデックスを適切に設定
   - tenant_id にインデックス必須
   - よく検索されるカラムにインデックス

4. 外部キー制約を使用
   - データ整合性の担保
   - ON DELETE CASCADE で関連データも削除

5. デモデータリセット関数を用意
   - 定期的な自動リセット
   - 手動リセットも可能に

11. まとめ：最終推奨構成
markdown## インフラ
✅ Vercel Pro: $20/月
✅ Vercel Cron: 含まれる（Keep Alive用）
✅ Supabase Free × 2: $0/月

合計: $20/月（約2,800円）

## データベース設計
✅ Prefix付きテーブル名
✅ tenant_id カラムで完全分離
✅ RLSで厳密なアクセス制御
✅ 共通ライブラリで抽象化

## プロジェクト分割
Project 1: 予約・管理系（restaurant, accounting）
Project 2: カタログ・EC系（ec, construction）

## 管理方法
✅ Supabase CLI でマイグレーション管理
✅ seed.sql でデモデータ投入
✅ 定期リセット関数で常に新鮮な状態
この構成なら、低コストで複数のデモサイトを効率的に運用できます！Prefixをしっかり付けておけば、将来的に独立したプロジェクトに分離するのも比較的簡単です。