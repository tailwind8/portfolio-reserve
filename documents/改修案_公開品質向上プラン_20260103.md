# 改修案（公開品質向上プラン）
**作成日**: 2026-01-03  
**対象**: `reserve-app/`（Next.js 16 + Supabase + Prisma）/ リポジトリ運用  
**目的**: ポートフォリオとしての完成度を維持したまま、**「公開・運用できる品質」**に引き上げるための改修タスクリストを提示する

---

## 0. 重要な前提（この提案の立ち位置）
- 本提案は「不足点の指摘」ではなく、**“何をどう直すか”**にフォーカスした改修案。
- 既存の分析は `documents/プロジェクト不足点分析レポート.md` / `documents/実装状況差分レポート.md` を参照。
- **最重要リスク**は、機能不足よりも「暫定実装が本番相当の環境に残ること」による事故（権限不備/情報漏えい/監視不在）である。

---

## 1. 優先度サマリー（結論）
### 🔴 Critical（公開前に必須）
1. **暫定認証（`x-user-id` / mock userId）の排除**  
2. **`SKIP_AUTH_IN_TEST` の本番混入耐性の強化**（多重ガード/ビルド時検知）  
3. **法的ページと同意**（`/privacy` `/terms` Cookie同意）  
4. **エラー監視（Sentry）と稼働監視（/api/health）**  

### 🟠 High（公開品質・信頼性の底上げ）
5. **テスト品質指標の整合（カバレッジ閾値とドキュメントの齟齬解消）**  
6. **CI/CDドキュメントと実態の整合（Vercel deployの扱い明確化）**  

### 🟡 Medium（リポジトリ運用としての不足）
7. **`LICENSE` / `SECURITY.md` / Dependabot / Codeowners 等の整備**  
8. **ドキュメント（基本仕様）の現状追随（Husky/Prettier等の記載整合）**  

---

## 2. 改修案（具体）

## 2.1 🔴 暫定認証の排除（最優先）
### 背景
現状、以下が「暫定」になっている：
- API: `reserve-app/src/app/api/reservations/route.ts` が **`x-user-id`ヘッダー**でユーザー識別（TODOあり）
- UI: `reserve-app/src/app/mypage/page.tsx` が **`mock-user-id`** を送出
- Hook: `reserve-app/src/hooks/useReservations.ts` が **`temp-user-id`** を送出

この状態は「デモ用途」としては成立しても、公開環境で残ると **なりすまし/情報漏えい**の設計になり得る。

### 方針（推奨）
**A案（推奨）: Supabaseセッション由来のユーザーIDに統一（本番想定）**
- サーバー側（Route Handler）でセッション取得→userId確定
- クライアントはユーザーIDを送らない（ヘッダー不要）

**B案（デモ専用）: “デモモード”を明確化し、本番で必ず無効化**
- `DEMO_MODE=true` のときだけ `x-user-id` を許可
- `NODE_ENV=production` では `DEMO_MODE` を拒否（ビルド/起動で落とす）

### 実施タスク（例）
- [ ] `src/app/api/reservations/route.ts`：`x-user-id`依存を廃止し、`lib/auth`等の既存ヘルパーを使って userId を確定
- [ ] `src/app/mypage/page.tsx`：`x-user-id`付与を削除（fetchを通常呼び出しに）
- [ ] `src/hooks/useReservations.ts`：同上
- [ ] 影響API（`/api/reservations/[id]` 等）も同じ方針で統一

### 受け入れ基準
- **ユーザーIDをクライアント入力で指定できない**
- E2Eが既存の方式で動く必要がある場合は、テスト側だけでセッションを作る（またはB案のデモモードをCI限定で利用）

---

## 2.2 🔴 `SKIP_AUTH_IN_TEST` 本番混入リスクの封じ込め
### 背景
`playwright.config.ts` が `webServer.env.SKIP_AUTH_IN_TEST = 'true'` を設定しており、
`reserve-app/src/middleware.ts` などが参照している。

### 方針（推奨）
- `SKIP_AUTH_IN_TEST` は **CI/E2E専用の危険フラグ**として扱う
- **productionでは絶対に効かない**ことをコード側で保証する（設定ミス耐性）

### 実施タスク（例）
- [ ] `src/middleware.ts`：`skipAuthInTest`を有効にできる条件を限定  
  - 例: `process.env.NODE_ENV !== 'production' && process.env.SKIP_AUTH_IN_TEST === 'true'`
- [ ] 可能なら `next build` 時に `SKIP_AUTH_IN_TEST=true` を検知したら失敗させる（運用ミス対策）

### 受け入れ基準
- `NODE_ENV=production` のとき、`SKIP_AUTH_IN_TEST=true`でも認証スキップされない

---

## 2.3 🔴 法的ページ・Cookie同意（公開前必須）
### 背景
ドキュメント上でも未対応として挙がっている（公開前の最低限）。

### 実施タスク（例）
- [ ] `documents/legal/` を新設し、以下を作成
  - `プライバシーポリシー.md`
  - `利用規約.md`
- [ ] Next.js ページ追加
  - `/privacy`
  - `/terms`
- [ ] Cookie同意バナー（ローカルストレージで同意保持、同意前は解析系を無効化）

### 受け入れ基準
- 主要導線（フッター等）から `privacy/terms` に遷移可能
- 同意前にCookie/解析が走らない（導入する場合）

---

## 2.4 🔴 監視（Sentry）と稼働監視（/api/health）
### 背景
本番運用で「気づけない」が最大のリスク。Sentryは費用対効果が高い。

### 実施タスク（例）
- [ ] Sentry導入（Next.js用）
- [ ] `NEXT_PUBLIC_SENTRY_DSN` などの環境変数を `.env.example` とドキュメントに追記（実値は書かない）
- [ ] `/api/health` を Uptime Robot 等で監視する手順を `documents/runbook/` に追加

### 受け入れ基準
- 意図的に例外を投げたとき、Sentryでイベントが確認できる
- 稼働監視の設定手順がRunbook化されている

---

## 2.5 🟠 テスト品質指標（カバレッジ閾値）とドキュメント整合
### 背景
`reserve-app/jest.config.js`で閾値が一時的に引き下げられている一方、
ドキュメント/BDDでは高い基準が書かれており、外部から見ると矛盾に見える。

### 方針（推奨）
- 「現状の閾値（暫定）」と「目標値」をドキュメントに明確化
- 期限/Issue紐付けで“暫定が恒久化しない”ようにする

### 実施タスク（例）
- [ ] `jest.config.js` のコメントに対応Issueと期限（目標日）を追記
- [ ] `documents/コード品質チェックリスト.md` に「暫定閾値の扱い」を追記
- [ ] `.feature`（CI/CDの期待値）を現状に合わせる or 目標値に合わせてテストを増やす（どちらかに統一）

---

## 2.6 🟠 CI/CDの“宣言”と“実態”の整合
### 背景
`.github/workflows/cicd.yml` では Vercel デプロイがコメントアウトされている。
一方でドキュメントに「PRで自動プレビュー/本番自動デプロイ」が書かれている箇所がある。

### 実施タスク（例）
- [ ] 「今はデプロイ無効（Secrets未設定）」であることを `documents/CI-CD運用ガイド.md` に明記
- [ ] Secretsが揃ったら有効化する手順を手順書化（失敗時の切り戻しも含む）

---

## 2.7 🟡 公開リポジトリとしての標準ファイル整備
### 現状
以下が見当たらない（少なくともルート直下に未存在）：
- `LICENSE`
- `SECURITY.md`
- `.github/dependabot.yml`
- `CODEOWNERS`

### 実施タスク（例）
- [ ] ライセンス決定→`LICENSE`追加（ポートフォリオならMIT/Apache-2.0が一般的）
- [ ] `SECURITY.md`（脆弱性報告窓口、対応方針）
- [ ] Dependabot（npm/GitHub Actionsの自動更新）
- [ ] Codeowners（レビュー責任の明確化：任意）

---

## 2.8 🟡 ドキュメントの現状追随（混乱防止）
### 背景
`documents/basic/プロジェクト概要.md` に Prettier/Husky/lint-staged 記載があるが、
`reserve-app/package.json` からは読み取れない。

### 実施タスク（例）
- [ ] 事実ベースでドキュメントを修正（導入済み/未導入を明記）
- [ ] “導入予定”ならIssue化し、計画と現状を分離して書く

---

## 3. 実施順（最短で公開品質に到達するルート）
1) 暫定認証の排除（2.1）  
2) `SKIP_AUTH_IN_TEST` ガード強化（2.2）  
3) 法的ページ + 同意（2.3）  
4) 監視（Sentry）+ 稼働監視Runbook（2.4）  
5) カバレッジ/CIドキュメント整合（2.5, 2.6）  
6) リポジトリ標準整備（2.7）  
7) ドキュメント現状追随（2.8）

---

## 4. 付記（判断が必要な点）
- **本番の定義**: 「一般公開するデモサイト」でも、第三者が触るなら本番同等に扱うのが安全  
- **デモの利便性 vs 安全性**: “デモモード”を採用する場合でも、productionで絶対無効化する仕組みが必要  

