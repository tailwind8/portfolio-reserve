# Issue #77, #78 - Gherkinシナリオ

**作成日**: 2026-01-02
**対象Issue**:
- Issue #77: スタッフ指名機能のON/OFF設定
- Issue #78: スタッフシフト管理のON/OFF設定

---

## Issue #77: スタッフ指名機能のON/OFF設定

### Feature: スタッフ指名機能の動的制御

```gherkin
Feature: スタッフ指名機能の動的制御
  As a システム管理者（SUPER_ADMIN）
  I want スタッフ指名機能をON/OFFできる
  So that 店舗の運用形態に応じた予約フローを提供できる

  Background:
    Given デモテナント "demo-booking" が存在する
    And メニュー "カット" が登録されている
    And スタッフ "田中" が登録されている
    And スタッフ "佐藤" が登録されている

  # ========================================
  # シナリオ1: スタッフ指名機能ON（デフォルト）
  # ========================================
  Scenario: スタッフ指名機能がONの場合、予約フォームにスタッフ選択欄が表示される
    Given スーパー管理者としてログインしている
    And 機能フラグ "enableStaffSelection" が "true" に設定されている
    When 一般ユーザーとして予約ページにアクセスする
    And メニュー "カット" を選択する
    And 予約日 "2026-01-10" を選択する
    Then スタッフ選択欄が表示される
    And スタッフ選択肢に "田中" が含まれる
    And スタッフ選択肢に "佐藤" が含まれる
    And スタッフ選択肢に "指名なし" が含まれる

  Scenario: スタッフ指名機能がONの場合、スタッフを指名して予約できる
    Given スーパー管理者としてログインしている
    And 機能フラグ "enableStaffSelection" が "true" に設定されている
    When 一般ユーザーとして予約フォームで以下を入力する
      | フィールド | 値 |
      | メニュー | カット |
      | 予約日 | 2026-01-10 |
      | 予約時間 | 10:00 |
      | スタッフ | 田中 |
    And 予約を確定する
    Then 予約が正常に登録される
    And 予約詳細に "担当スタッフ: 田中" と表示される

  Scenario: スタッフ指名機能がONの場合、指名なしで予約できる
    Given スーパー管理者としてログインしている
    And 機能フラグ "enableStaffSelection" が "true" に設定されている
    When 一般ユーザーとして予約フォームで以下を入力する
      | フィールド | 値 |
      | メニュー | カット |
      | 予約日 | 2026-01-10 |
      | 予約時間 | 10:00 |
      | スタッフ | 指名なし |
    And 予約を確定する
    Then 予約が正常に登録される
    And システムがスタッフを自動的に割り当てる

  # ========================================
  # シナリオ2: スタッフ指名機能OFF
  # ========================================
  Scenario: スタッフ指名機能がOFFの場合、予約フォームにスタッフ選択欄が表示されない
    Given スーパー管理者としてログインしている
    And 機能フラグ "enableStaffSelection" が "false" に設定されている
    When 一般ユーザーとして予約ページにアクセスする
    And メニュー "カット" を選択する
    And 予約日 "2026-01-10" を選択する
    Then スタッフ選択欄が表示されない
    And 空き時間スロットが表示される

  Scenario: スタッフ指名機能がOFFの場合、スタッフが自動割り当てされる
    Given スーパー管理者としてログインしている
    And 機能フラグ "enableStaffSelection" が "false" に設定されている
    When 一般ユーザーとして予約フォームで以下を入力する
      | フィールド | 値 |
      | メニュー | カット |
      | 予約日 | 2026-01-10 |
      | 予約時間 | 10:00 |
    And 予約を確定する
    Then 予約が正常に登録される
    And システムが自動的にスタッフを割り当てる
    And 予約詳細に担当スタッフが表示される

  Scenario: スタッフ指名機能がOFFの場合、空き時間APIは全スタッフの空き状況を統合して返す
    Given スーパー管理者としてログインしている
    And 機能フラグ "enableStaffSelection" が "false" に設定されている
    And スタッフ "田中" の "2026-01-10 10:00" に予約が入っている
    And スタッフ "佐藤" の "2026-01-10 10:00" は空いている
    When 空き時間APIを呼び出す
      | パラメータ | 値 |
      | date | 2026-01-10 |
      | menuId | カットのID |
    Then "10:00" のスロットが "available: true" として返される
    And レスポンスに "staffId" が含まれる（佐藤のID）

  # ========================================
  # シナリオ3: 動的な切り替え
  # ========================================
  Scenario: スーパー管理者が機能フラグをOFFに変更すると、即座に反映される
    Given スーパー管理者としてログインしている
    And 機能フラグ "enableStaffSelection" が "true" に設定されている
    When スーパー管理者が機能フラグ管理画面で "enableStaffSelection" を "false" に変更する
    And 変更を保存する
    And 一般ユーザーとして予約ページを開き直す
    Then スタッフ選択欄が表示されない
```

---

## Issue #78: スタッフシフト管理のON/OFF設定

### Feature: スタッフシフト管理機能の動的制御

```gherkin
Feature: スタッフシフト管理機能の動的制御
  As a システム管理者（SUPER_ADMIN）
  I want スタッフシフト管理機能をON/OFFできる
  So that シフト制の店舗と常時勤務の店舗の両方に対応できる

  Background:
    Given デモテナント "demo-booking" が存在する
    And メニュー "カット" が登録されている
    And スタッフ "田中" が登録されている
    And スタッフ "佐藤" が登録されている
    And 店舗の営業時間が "09:00-20:00" に設定されている

  # ========================================
  # シナリオ1: シフト管理機能OFF（デフォルト）
  # ========================================
  Scenario: シフト管理機能がOFFの場合、全てのisActive=trueスタッフが空き時間に含まれる
    Given スーパー管理者としてログインしている
    And 機能フラグ "enableStaffShiftManagement" が "false" に設定されている
    And スタッフ "田中" の isActive が "true"
    And スタッフ "佐藤" の isActive が "true"
    And スタッフ "田中" にはシフトが登録されていない
    When 空き時間APIを呼び出す
      | パラメータ | 値 |
      | date | 2026-01-10 |
      | menuId | カットのID |
    Then レスポンスに "田中" のスロットが含まれる
    And レスポンスに "佐藤" のスロットが含まれる

  Scenario: シフト管理機能がOFFの場合、管理画面にシフト設定メニューが表示されない
    Given 管理者（ADMIN）としてログインしている
    And 機能フラグ "enableStaffShiftManagement" が "false" に設定されている
    When 管理画面のスタッフページにアクセスする
    Then スタッフ一覧が表示される
    And "シフト設定" タブが表示されない
    And "休暇設定" タブが表示されない

  # ========================================
  # シナリオ2: シフト管理機能ON
  # ========================================
  Scenario: シフト管理機能がONの場合、シフトに基づいて空き時間が計算される
    Given スーパー管理者としてログインしている
    And 機能フラグ "enableStaffShiftManagement" が "true" に設定されている
    And スタッフ "田中" のシフトが以下のように設定されている
      | 曜日 | 出勤時間 | 退勤時間 |
      | Friday | 09:00 | 15:00 |
    And スタッフ "佐藤" のシフトが以下のように設定されている
      | 曜日 | 出勤時間 | 退勤時間 |
      | Friday | 14:00 | 20:00 |
    And "2026-01-10" が "Friday" である
    When 空き時間APIを呼び出す
      | パラメータ | 値 |
      | date | 2026-01-10 |
      | menuId | カットのID |
    Then "10:00" のスロットに "田中" が割り当て可能
    And "10:00" のスロットに "佐藤" が割り当て不可能（シフト外）
    And "16:00" のスロットに "田中" が割り当て不可能（シフト外）
    And "16:00" のスロットに "佐藤" が割り当て可能

  Scenario: シフト管理機能がONの場合、休暇期間のスタッフは空き時間に含まれない
    Given スーパー管理者としてログインしている
    And 機能フラグ "enableStaffShiftManagement" が "true" に設定されている
    And スタッフ "田中" のシフトが設定されている
    And スタッフ "田中" の休暇が以下のように設定されている
      | 開始日 | 終了日 |
      | 2026-01-10 | 2026-01-12 |
    When 空き時間APIを呼び出す
      | パラメータ | 値 |
      | date | 2026-01-10 |
      | menuId | カットのID |
    Then レスポンスに "田中" のスロットが含まれない

  Scenario: シフト管理機能がONの場合、管理画面にシフト設定メニューが表示される
    Given 管理者（ADMIN）としてログインしている
    And 機能フラグ "enableStaffShiftManagement" が "true" に設定されている
    When 管理画面のスタッフページにアクセスする
    Then スタッフ一覧が表示される
    And "シフト設定" タブが表示される
    And "休暇設定" タブが表示される

  Scenario: シフト管理機能がONの場合、管理者がスタッフのシフトを登録できる
    Given 管理者（ADMIN）としてログインしている
    And 機能フラグ "enableStaffShiftManagement" が "true" に設定されている
    When 管理画面のスタッフページで "田中" を選択する
    And "シフト設定" タブをクリックする
    And 以下のシフトを登録する
      | 曜日 | 出勤時間 | 退勤時間 |
      | Monday | 09:00 | 18:00 |
    And "保存" ボタンをクリックする
    Then シフトが正常に登録される
    And 成功メッセージが表示される

  # ========================================
  # シナリオ3: 動的な切り替え
  # ========================================
  Scenario: スーパー管理者が機能フラグをONに変更すると、シフトUIが表示される
    Given スーパー管理者としてログインしている
    And 機能フラグ "enableStaffShiftManagement" が "false" に設定されている
    When スーパー管理者が機能フラグ管理画面で "enableStaffShiftManagement" を "true" に変更する
    And 変更を保存する
    And 管理者（ADMIN）として管理画面のスタッフページを開き直す
    Then "シフト設定" タブが表示される
    And "休暇設定" タブが表示される

  Scenario: シフト未登録のスタッフは、シフト管理ON時に空き時間に含まれない
    Given スーパー管理者としてログインしている
    And 機能フラグ "enableStaffShiftManagement" が "true" に設定されている
    And スタッフ "田中" にシフトが登録されていない
    When 空き時間APIを呼び出す
      | パラメータ | 値 |
      | date | 2026-01-10 |
      | menuId | カットのID |
    Then レスポンスに "田中" のスロットが含まれない
```

---

## 受入条件（Acceptance Criteria）

### Issue #77
- [ ] 機能フラグ `enableStaffSelection` が `true` の場合、予約フォームにスタッフ選択欄が表示される
- [ ] 機能フラグ `enableStaffSelection` が `false` の場合、予約フォームにスタッフ選択欄が表示されない
- [ ] スタッフ指名OFFの場合、空き時間APIは全スタッフの空き状況を統合して返す
- [ ] スタッフ指名OFFの場合、予約作成時にシステムが自動的にスタッフを割り当てる
- [ ] E2Eテストで両パターン（ON/OFF）をカバーする

### Issue #78
- [ ] 機能フラグ `enableStaffShiftManagement` が `true` の場合、空き時間APIはシフトを考慮する
- [ ] 機能フラグ `enableStaffShiftManagement` が `false` の場合、全てのisActive=trueスタッフを対象とする
- [ ] シフト管理ON時、管理画面にシフト設定・休暇設定UIが表示される
- [ ] シフト管理OFF時、管理画面にシフト設定・休暇設定UIが表示されない
- [ ] シフト未登録のスタッフは、シフト管理ON時に空き時間に含まれない
- [ ] E2Eテストでシフト考慮パターンをカバーする

---

## テスト優先順位

### Phase 1（必須）
1. スタッフ指名ON/OFFの動的切り替え
2. 空き時間APIのスタッフ自動割り当てロジック
3. シフト管理ON/OFFの動的切り替え
4. 空き時間APIのシフト判定ロジック

### Phase 2（重要）
5. 管理画面のシフト設定UI
6. 管理画面の休暇設定UI

---

**このGherkinシナリオをもとに、E2Eテストを実装してください。**
