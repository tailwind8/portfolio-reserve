# ロール設計書

**最終更新**: 2026-01-02
**対象システム**: 予約管理システム（Reserve System）
**目的**: システムの3つのロール（CUSTOMER、ADMIN、SUPER_ADMIN）の権限と責務を明確化

---

## 📋 目次

1. [概要](#概要)
2. [ロール一覧](#ロール一覧)
3. [各ロールの詳細](#各ロールの詳細)
4. [権限マトリクス](#権限マトリクス)
5. [認証・認可フロー](#認証・認可フロー)
6. [実装上の注意事項](#実装上の注意事項)

---

## 概要

### なぜ3層構造が必要か

このシステムはココナラで「買い切り型」として販売するため、以下の要件があります：

1. **基準パッケージ**（50,000円）: 基本機能のみ提供
2. **オプション機能**（+5,000円〜+20,000円）: 顧客が購入した機能のみ有効化

**問題**: 店舗管理者（ADMIN）が購入していない機能を勝手にONできてしまう

**解決策**: 3層構造を導入し、機能フラグの管理権限を分離

---

## ロール一覧

| ロール | 日本語名 | 対象ユーザー | 主な責務 |
|--------|---------|------------|----------|
| **CUSTOMER** | 一般ユーザー（顧客） | 店舗のサービス利用者 | 予約の作成・確認・キャンセル |
| **ADMIN** | 店舗管理者 | 店舗オーナー・スタッフ | 店舗運用・予約管理・顧客管理 |
| **SUPER_ADMIN** | システム管理者（開発者） | システム開発者・保守担当 | オプション機能ON/OFF・全テナント管理 |

---

## 各ロールの詳細

### 1. CUSTOMER（一般ユーザー）

#### 対象ユーザー
- 店舗のサービスを利用する顧客
- 20代〜50代の幅広い年齢層
- スマホから予約を希望する層

#### アクセス可能なルート
```
/                          # トップページ
/login                     # ログイン
/register                  # 新規登録
/menus                     # メニュー一覧
/booking                   # 予約フォーム
/booking/confirm           # 予約確認
/mypage                    # マイページ
/mypage/reservations       # 予約一覧
/mypage/profile            # プロフィール編集
```

#### 主な権限
- ✅ 予約の作成
- ✅ 自分の予約の確認
- ✅ 自分の予約のキャンセル（期限内）
- ✅ 予約の変更（オプション機能が有効な場合）
- ✅ 自分のプロフィール編集
- ❌ 他人の予約の閲覧・編集
- ❌ スタッフ管理
- ❌ メニュー管理
- ❌ 店舗設定の変更

#### データベース定義
```prisma
model BookingUser {
  role UserRole @default(CUSTOMER)
  // ...
}

enum UserRole {
  CUSTOMER // デフォルトロール
  ADMIN
  SUPER_ADMIN
}
```

---

### 2. ADMIN（店舗管理者）

#### 対象ユーザー
- 店舗オーナー
- 店舗のスタッフ（予約管理担当）
- 経営者（分析レポート活用）

#### アクセス可能なルート
```
/admin/dashboard           # 管理者ダッシュボード
/admin/reservations        # 予約管理
/admin/customers           # 顧客管理（オプション）
/admin/staff               # スタッフ管理
/admin/menus               # メニュー管理
/admin/settings            # 店舗設定
/admin/analytics           # 分析レポート（オプション）
```

#### 主な権限
- ✅ 全予約の閲覧・編集・削除
- ✅ 予約の手動追加（オプション機能が有効な場合）
- ✅ 顧客情報の閲覧・編集（オプション機能が有効な場合）
- ✅ スタッフの登録・編集
- ✅ メニューの登録・編集・削除
- ✅ 店舗基本設定の変更（営業時間、定休日など）
- ✅ 分析レポートの閲覧（オプション機能が有効な場合）
- ❌ **オプション機能のON/OFF切り替え**（SUPER_ADMINのみ可能）
- ❌ 他のテナントのデータ閲覧
- ❌ システム全体の設定変更

#### 認証方法
- Supabase Authによるログイン
- `BookingUser.role = ADMIN`で判定
- `/admin/*` ルートはMiddlewareで保護

#### 注意事項
⚠️ **ADMINは「購入済みオプション機能」を使用するのみ**
- オプション機能のON/OFFはできない
- SUPER_ADMINが有効化した機能のみ利用可能
- 機能フラグで無効な機能はUIに表示されない

---

### 3. SUPER_ADMIN（システム管理者）

#### 対象ユーザー
- **システム開発者のみ**
- システム保守担当者
- ココナラでの販売・納品担当者

#### アクセス可能なルート
```
/super-admin/login         # スーパー管理者ログイン
/super-admin/dashboard     # スーパー管理者ダッシュボード
/super-admin/feature-flags # 機能フラグ管理（全テナント対象）
```

#### 主な権限
- ✅ **全テナントの機能フラグON/OFF**（最重要）
- ✅ 全テナントのデータ閲覧（デバッグ用）
- ✅ テナント選択・切り替え
- ✅ システム全体の設定変更
- ❌ 通常の店舗運用業務（ADMINの仕事）
- ❌ 顧客の予約代行（ADMINの仕事）

#### 認証方法
- Supabase Authによるログイン
- `BookingUser.role = SUPER_ADMIN`で判定
- `/super-admin/*` ルートはMiddlewareで厳重に保護
- Seedデータで1名のみ作成（`contact@tailwind8.com`）

#### ビジネスフロー（ココナラ販売時）
1. 顧客がココナラで「基準パッケージ + オプション機能」を購入
2. **SUPER_ADMIN**が `/super-admin/feature-flags` にアクセス
3. 購入されたオプション機能をONに切り替え
4. **ADMIN**（店舗管理者）が有効化された機能を使用開始

#### セキュリティ上の注意
⚠️ **SUPER_ADMINアカウントは厳重に管理**
- パスワードは複雑なもの（`SuperAdmin2026!`）
- 本番環境では環境変数で管理
- アクセスログを記録（将来的に実装）

---

## 権限マトリクス

### 機能別アクセス権限

| 機能 | CUSTOMER | ADMIN | SUPER_ADMIN |
|------|----------|-------|-------------|
| **予約作成** | ✅ | ✅ | ❌ |
| **自分の予約確認** | ✅ | ✅ | ❌ |
| **自分の予約キャンセル** | ✅ | ❌ | ❌ |
| **全予約閲覧** | ❌ | ✅ | ✅（全テナント） |
| **予約手動追加** | ❌ | ✅（※1） | ❌ |
| **顧客管理** | ❌ | ✅（※1） | ❌ |
| **スタッフ管理** | ❌ | ✅ | ❌ |
| **メニュー管理** | ❌ | ✅ | ❌ |
| **店舗設定** | ❌ | ✅ | ❌ |
| **分析レポート** | ❌ | ✅（※1） | ❌ |
| **機能フラグON/OFF** | ❌ | ❌ | ✅ |
| **テナント切り替え** | ❌ | ❌ | ✅ |

※1: オプション機能が有効な場合のみ

### API別アクセス権限

| APIエンドポイント | CUSTOMER | ADMIN | SUPER_ADMIN |
|------------------|----------|-------|-------------|
| `POST /api/reservations` | ✅ | ✅ | ❌ |
| `GET /api/reservations` | ✅（自分のみ） | ✅（全件） | ❌ |
| `DELETE /api/reservations/:id` | ✅（自分のみ） | ✅ | ❌ |
| `GET /api/admin/stats` | ❌ | ✅ | ❌ |
| `GET /api/admin/customers` | ❌ | ✅ | ❌ |
| `PATCH /api/admin/settings` | ❌ | ✅ | ❌ |
| `GET /api/super-admin/feature-flags` | ❌ | ❌ | ✅ |
| `PATCH /api/super-admin/feature-flags` | ❌ | ❌ | ✅ |

---

## 認証・認可フロー

### 1. ログインフロー

#### CUSTOMER / ADMIN
```
ユーザー → /login → Supabase Auth認証
         ↓
         成功
         ↓
BookingUser取得（Prisma）
         ↓
    role確認
         ↓
  CUSTOMER → /mypage へリダイレクト
  ADMIN    → /admin/dashboard へリダイレクト
```

#### SUPER_ADMIN
```
開発者 → /super-admin/login → Supabase Auth認証
       ↓
       成功
       ↓
BookingUser取得（Prisma）
       ↓
  role === SUPER_ADMIN ?
       ↓
       YES → /super-admin/dashboard へリダイレクト
       NO  → 403 Forbidden
```

### 2. Middleware保護

**ファイル**: `src/middleware.ts`

```typescript
// /admin/* ルート保護
if (pathname.startsWith('/admin/')) {
  // Supabase Auth認証チェック
  // role === ADMIN || role === SUPER_ADMIN のみ許可
}

// /super-admin/* ルート保護（厳重）
if (pathname.startsWith('/super-admin/')) {
  // Supabase Auth認証チェック
  // role === SUPER_ADMIN のみ許可
  // それ以外は /super-admin/login へリダイレクト
}
```

### 3. API Route保護

```typescript
// app/api/admin/stats/route.ts
export async function GET(request: NextRequest) {
  // 1. Supabase Auth認証チェック
  const { user } = await getAuth(request);

  // 2. BookingUserからrole取得
  const dbUser = await prisma.bookingUser.findUnique({
    where: { authId: user.id },
  });

  // 3. ADMIN or SUPER_ADMIN のみ許可
  if (dbUser.role !== 'ADMIN' && dbUser.role !== 'SUPER_ADMIN') {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }

  // 4. データ取得
  // ...
}
```

---

## 実装上の注意事項

### 1. ロールチェックの実装パターン

#### ❌ 悪い例: テキストでロールを判定
```typescript
if (user.email === 'contact@tailwind8.com') {
  // SUPER_ADMINとして扱う
}
```

#### ✅ 良い例: DBのroleカラムで判定
```typescript
const dbUser = await prisma.bookingUser.findUnique({
  where: { authId: user.id },
});

if (dbUser.role === 'SUPER_ADMIN') {
  // SUPER_ADMIN権限
}
```

### 2. 機能フラグのチェック

#### フロントエンド（ADMIN画面）
```tsx
import { useFeatureFlags } from '@/hooks/useFeatureFlags';

export function AdminSidebar() {
  const { flags } = useFeatureFlags();

  return (
    <nav>
      {/* 基準機能は常に表示 */}
      <NavItem href="/admin/dashboard">ダッシュボード</NavItem>
      <NavItem href="/admin/reservations">予約管理</NavItem>

      {/* オプション機能は機能フラグで制御 */}
      {flags.enableCustomerManagement && (
        <NavItem href="/admin/customers">顧客管理</NavItem>
      )}

      {flags.enableAnalyticsReport && (
        <NavItem href="/admin/analytics">分析レポート</NavItem>
      )}
    </nav>
  );
}
```

#### バックエンド（API Route）
```typescript
import { requireFeatureFlag } from '@/lib/api-feature-flag';

export async function GET(request: NextRequest) {
  // 機能フラグチェック
  return requireFeatureFlag('enableCustomerManagement', async () => {
    // 実際の処理
    const customers = await prisma.bookingUser.findMany({ ... });
    return NextResponse.json({ success: true, data: customers });
  });
}
```

### 3. テナント分離の厳守

**全クエリに`tenantId`フィルタを追加**

```typescript
// ❌ 悪い例: tenantIdフィルタなし
const reservations = await prisma.bookingReservation.findMany({
  where: { status: 'CONFIRMED' },
});

// ✅ 良い例: tenantIdフィルタあり
const TENANT_ID = process.env.NEXT_PUBLIC_TENANT_ID || 'demo-booking';
const reservations = await prisma.bookingReservation.findMany({
  where: {
    tenantId: TENANT_ID,
    status: 'CONFIRMED',
  },
});
```

**例外**: SUPER_ADMINは複数テナントを管理可能

```typescript
// SUPER_ADMINのみ: tenantIdを切り替え可能
export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const tenantId = searchParams.get('tenantId') || 'demo-booking';

  // SUPER_ADMINかチェック
  if (dbUser.role !== 'SUPER_ADMIN') {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }

  // 指定されたテナントのデータ取得
  const flags = await prisma.featureFlag.findUnique({
    where: { tenantId },
  });

  return NextResponse.json({ success: true, data: flags });
}
```

### 4. Seedデータでのロール設定

**ファイル**: `prisma/seed.ts`

```typescript
// SUPER_ADMIN（1名のみ）
await prisma.bookingUser.upsert({
  where: { id: 'super-admin-001' },
  update: {},
  create: {
    id: 'super-admin-001',
    tenantId: 'demo-booking',
    authId: null, // Supabase Authで後から設定
    email: 'contact@tailwind8.com',
    name: 'System Administrator',
    role: 'SUPER_ADMIN', // 🔑
  },
});

// ADMIN（店舗管理者）
await prisma.bookingUser.create({
  data: {
    tenantId: 'demo-booking',
    email: 'admin@demo-salon.com',
    name: '店舗管理者',
    role: 'ADMIN', // 🔑
  },
});

// CUSTOMER（一般ユーザー）
await prisma.bookingUser.create({
  data: {
    tenantId: 'demo-booking',
    email: 'user@example.com',
    name: '田中太郎',
    role: 'CUSTOMER', // デフォルト
  },
});
```

---

## まとめ

### ロール設計の原則

1. **CUSTOMER**: 予約するだけ
2. **ADMIN**: 店舗を運営するだけ（購入済み機能のみ使用）
3. **SUPER_ADMIN**: 機能フラグを管理するだけ（店舗運用はしない）

### 重要ポイント

⚠️ **ADMINは機能フラグのON/OFFができない**
- 機能フラグの管理権限はSUPER_ADMINのみ
- ADMINは購入済みオプション機能を「使用するだけ」
- `/admin/settings/features` ページは**存在しない**

⚠️ **SUPER_ADMINは店舗運用をしない**
- SUPER_ADMINの役割は「機能フラグ管理」のみ
- 予約管理・顧客管理などはADMINの仕事
- `/super-admin/*` は開発者専用エリア

---

## 関連ドキュメント

- `reserve-app/prisma/schema.prisma` - UserRole enum定義
- `reserve-app/src/middleware.ts` - ルート保護実装
- `documents/handover/Phase1-スーパーadmin基盤構築.md` - SUPER_ADMIN実装詳細
- `documents/spec/データベース設計書.md` - BookingUserテーブル定義
- `documents/marketing/SuperAdmin機能フラグ設計.md` - 機能フラグ管理詳細

---

**最終更新日**: 2026-01-02
**作成者**: 開発チーム
**レビュー**: 必須（新規開発者はこのドキュメントを必読）
